# autel.yml
# EVBot Fault Pack: Autel (On-site Technician v1) â€” Descriptive + Tuned (nodes-based)
# Notes:
# - Node-based decision tree: start_node + nodes map
# - Each node has: prompt, options -> next
# - image: autel/<filename_without_extension> (expects files in assets/images/autel/*.png)

faults:

  # ============================================================
  # (1) GOLD STANDARD CLUSTER: Autel Power-Stage / HV Start Inhibit
  # ============================================================

  - id: autel_power_stage_cluster
    platform: autel
    charger_type: dc
    title: "Power-Stage / HV Start Inhibit (Precharge / DC Bus / Contactors)"
    severity: critical
    tags: [power_stage, hv_enable, precharge, dc_bus, contactor, interlock, insulation, start_inhibit]

    aliases:
      - "Power-stage fault"
      - "HV start inhibited"
      - "precharge fault"
      - "dc bus not ready"
      - "dc contactor failed"
      - "hv enable fault"
      - "start failed"

    triggers:
      any_text_contains:
        - "precharge"
        - "dc bus"
        - "hv enable"
        - "start failed"
        - "contactor fault"
        - "isolation"
        - "imd"
        - "hvil"
        - "interlock"

    description: >
      The charger is preventing HV start or cannot complete the HV start sequence
      (enable â†’ precharge â†’ DC bus build â†’ contactor verification).

    decision_tree:
      start_node: PS0
      nodes:
        PS0:
          prompt: |
            *Autel â€” Power-Stage / HV Start Inhibit*
            Start symptom-first. What are you seeing?
          options:
            - label: "ðŸš« Wonâ€™t start a session"
              next: PS_SAFE_REBOOT
            - label: "âš ï¸ Clicks then faults"
              next: PS_SAFE_REBOOT
            - label: "ðŸŸª Insulation / IMD alarm"
              next: PS_ESC
            - label: "â¬› Interlock / E-stop"
              next: PS_ESC

        PS_SAFE_REBOOT:
          prompt: |
            *Safe recovery*
            Perform a controlled reboot and observe which fault returns first.
          options:
            - label: "Recovered"
              next: PS_DONE_RESOLVED
            - label: "Still failing"
              next: PS_ESC

        PS_DONE_RESOLVED:
          prompt: |
            *Resolved*
            Run a short test session and confirm stability.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        PS_ESC:
          prompt: |
            *Escalate â€” Power-Stage / HV Start Inhibit*
            Include fault text, timestamps, and observed behaviour.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (7) TCU Communication Error â€” UPDATED (hardware-aware)
  # ============================================================

  - id: autel_tcu_communication_error
    platform: autel
    charger_type: dc
    title: "TCU Communication Error (Telematics / Comms Module)"
    severity: high
    tags: [tcu, modem, antenna, harness, network, ocpp]

    triggers:
      any_text_contains:
        - "tcu communication"
        - "tcu offline"
        - "tcu not responding"
        - "telematics"
        - "communication with tcu"

    description: >
      Controller cannot communicate reliably with the TCU.
      Common causes include loose harnessing, antenna/RF issues,
      control power instability, or TCU/modem failure.

    decision_tree:
      start_node: TCU0
      nodes:

        TCU0:
          prompt: |
            *TCU Communication Error â€” Start*
            Is the charger also offline to the backend?
          options:
            - label: "Yes â€” backend offline"
              next: TCU_REBOOT
            - label: "No â€” charging still works"
              next: TCU_REBOOT

        TCU_REBOOT:
          prompt: |
            *Controlled reboot*
            Reboot the charger (HMI or controlled power cycle).
          options:
            - label: "Resolved"
              next: TCU_MONITOR
            - label: "Still faulting"
              next: TCU_HW_CHECK

        TCU_HW_CHECK:
          prompt: |
            *TCU hardware checks (do before escalation)*
            Verify the physical comms path:
            - Are TCU LEDs illuminated or flashing (power/activity)?
            - Antenna securely connected and undamaged
            - If possible, test with a known-good antenna
            - Confirm all TCU harnesses/connectors are fully seated
              (power, data, intermediate adapters)
          options:
            - label: "Issue found and corrected"
              next: TCU_RETEST
            - label: "All checks OK"
              next: TCU_ESC

        TCU_RETEST:
          prompt: |
            *Re-test*
            Reboot again and allow time for modem registration.
          options:
            - label: "Online"
              next: __MENU_AUTEL__
            - label: "Still offline"
              next: TCU_ESC

        TCU_MONITOR:
          prompt: |
            *Monitor*
            Confirm no repeated TCU or backend dropouts.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        TCU_ESC:
          prompt: |
            *Escalate â€” TCU Communication Error*
            Include:
            - LED behaviour
            - Antenna test performed
            - Harness checks completed
            - Frequency/timestamps of fault
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__
