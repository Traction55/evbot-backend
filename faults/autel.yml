# autel.yml
# EVBot Fault Library — Autel DC
# Notes:
# - Node-based decision tree: start_node + nodes map
# - Each node has: prompt, actions, options -> next
# - Keep IDs stable so your bot can deep-link (e.g., /autel autel_ac_contactor_fault)

faults:
  - id: autel_ac_contactor_fault
    platform: autel
    charger_type: dc
    title: "AC Contactor Fault (Autel DC)"
    aliases:
      - "AC Contactor Fault"
      - "AC contactor error"
      - "input contactor fault"
      - "main contactor fault"
      - "contactor open feedback"
      - "contactor feedback error"
    triggers:
      any_text_contains:
        - "ac contactor"
        - "contactor fault"
        - "contactor feedback"
        - "input contactor"
        - "main contactor"
    severity: high
    tags:
      - power
      - input
      - contactor
      - interlock
      - feedback
      - three_phase

    response:
      telegram_markdown: |
        *Autel DC — AC Contactor Fault*
        This usually means the charger *can’t close or verify* the main AC input contactor feeding the rectifier stack.

        *Most common real causes:*
        • Missing phase / phase imbalance  
        • Low control PSU voltage (coil undervoltage)  
        • Loose coil/aux wiring or failed aux feedback contact  
        • Safety chain / interlock open (E-stop, door, etc.)  
        • Contactor coil or contacts actually failed

        Use the decision tree below to isolate whether it’s *supply*, *control*, *feedback*, *interlock*, or *contactor hardware*.

    safety:
      telegram_markdown: |
        *Safety (HV / LV)*
        • Follow LOTO, prove dead, wait for DC bus discharge.
        • Treat DC bus as live until verified discharged (wait 2–3 min minimum after isolation).
        • Only proceed if you’re authorised and competent.

    tools:
      - "Multimeter (AC V + DC V)"
      - "Torque driver / insulated tools"
      - "Thermal camera (optional)"
      - "Screwdrivers / cabinet keys"

    likely_causes:
      - "Upstream supply issue (missing phase, blown fuse, isolator OFF)"
      - "Coil drive missing (control board / wiring / PSU rail)"
      - "Coil undervoltage (PSU weak, voltage sag)"
      - "Aux feedback not changing state (aux contact failure / wiring)"
      - "Safety chain open (E-stop, door interlock, internal safety relay)"
      - "Contactor failure (coil open, contacts welded/pitted)"

    decision_tree:
      start_node: A0
      nodes:
        A0:
          prompt: |
            *AC Contactor Fault — Start*
            Confirm: Is this fault present *right now* and preventing charging?
          actions:
            - "If possible, capture event logs / fault timestamp before clearing."
            - "Ask: does it clear after a reboot but returns?"
          options:
            - label: "Yes, fault active now"
              next: A1
            - label: "Intermittent / clears after reboot"
              next: A2

        A1:
          prompt: |
            *Check Site Supply (most common)*
            Verify upstream power before opening cabinets:
            • Isolator ON
            • 3-phase present (L1/L2/L3)
            • No blown fuses / phase loss
            • Phase imbalance not excessive
          actions:
            - "Measure L-L voltages (e.g., ~400–415VAC) and compare phases."
            - "Confirm no phase missing at charger input terminals."
          options:
            - label: "Supply OK (all phases present)"
              next: A3
            - label: "Missing phase / bad supply"
              next: FIX_SUPPLY

        A2:
          prompt: |
            *Intermittent Pattern*
            If it clears after reboot but returns:
            • Suspect marginal coil voltage, loose wiring, aux feedback, PSU sag, or heating.
          actions:
            - "Proceed through checks in order; don’t replace the contactor first."
          options:
            - label: "Continue diagnostics"
              next: A1

        A3:
          prompt: |
            *Perform a Proper Power Cycle*
            Not just a software reboot:
            1) AC isolator OFF
            2) Wait 2–3 minutes (DC bus discharge)
            3) AC isolator ON
            Observe startup: do you hear a clean contactor pull-in?
          actions:
            - "Listen for a single solid 'clunk' (pull-in)."
            - "Note any chatter or no actuation."
          options:
            - label: "Fault clears and stays cleared"
              next: MONITOR
            - label: "No clunk / no pull-in"
              next: A4
            - label: "Chatter / weak pull-in"
              next: A5
            - label: "Clunks but fault remains"
              next: A6

        A4:
          prompt: |
            *No Pull-in*
            Likely: coil not being driven OR safety chain open.
            Next: check interlocks and coil control voltage.
          actions:
            - "Check door interlock / E-stop / safety chain state."
            - "Locate contactor coil terminals and measure coil voltage during pull-in attempt."
          options:
            - label: "Safety chain/interlock open"
              next: FIX_INTERLOCK
            - label: "Coil voltage absent (0V during attempt)"
              next: A7
            - label: "Coil voltage present (normal) but no pull-in"
              next: REPLACE_CONTACTOR

        A5:
          prompt: |
            *Chatter / Weak Pull-in*
            This is usually undervoltage to coil or a weak PSU rail.
          actions:
            - "Measure coil voltage during pull-in (watch for sag)."
            - "Check control PSU output (commonly 24VDC rail, model dependent)."
            - "Inspect coil wiring for loose / burnt terminals."
          options:
            - label: "Coil/control voltage low or sagging"
              next: FIX_PSU_OR_SUPPLY
            - label: "Voltage normal but still chatter"
              next: REPLACE_CONTACTOR

        A6:
          prompt: |
            *Clunks but Fault Persists*
            Likely: aux feedback not detected or wiring issue.
          actions:
            - "Identify aux/feedback contacts wired to controller."
            - "Check continuity/state change when contactor closes."
            - "Inspect crimps, plugs, and harness seating."
          options:
            - label: "Aux feedback not changing / wiring fault"
              next: FIX_AUX_FEEDBACK
            - label: "Aux feedback OK but fault persists"
              next: A8

        A7:
          prompt: |
            *Coil Voltage Absent*
            If contactor never receives coil drive:
            • controller not commanding closure
            • safety chain not satisfied
            • broken wire / connector
            • PSU rail missing
          actions:
            - "Verify safety chain closed (E-stop, door, internal safety relays)."
            - "Verify control PSU output rail present and stable."
            - "Inspect coil drive wiring from controller to contactor."
          options:
            - label: "PSU rail missing/unstable"
              next: FIX_PSU_OR_SUPPLY
            - label: "Safety chain issue"
              next: FIX_INTERLOCK
            - label: "Wiring/connector issue"
              next: FIX_WIRING
            - label: "Controller not commanding (needs logs/support)"
              next: ESCALATE_AUTEL

        A8:
          prompt: |
            *Firmware / Configuration Check*
            If hardware looks OK:
            • Confirm firmware current
            • Confirm site voltage/grid config matches (400/415, TN/TT as applicable)
          actions:
            - "Update firmware (per Autel process) if not current."
            - "Verify configuration: site-specific voltage and grid parameters."
            - "Reboot after changes."
          options:
            - label: "Resolved after firmware/config"
              next: MONITOR
            - label: "Still faulting"
              next: ESCALATE_AUTEL

        # ---- Resolution / End Nodes ----
        FIX_SUPPLY:
          prompt: |
            *Fix: Supply Issue*
            Root cause is upstream power:
            • Restore missing phase / replace fuse
            • Fix isolator / upstream breaker
            Then re-test startup.
          actions:
            - "Recheck L-L voltages after repair."
            - "Power cycle and confirm stable operation."
          options:
            - label: "Re-test after supply fix"
              next: A3

        FIX_INTERLOCK:
          prompt: |
            *Fix: Interlock / Safety Chain*
            Clear E-stop, close doors, confirm interlock loop and safety relays are satisfied.
          actions:
            - "Verify interlock inputs in diagnostics if available."
            - "Fix wiring/microswitch as needed."
          options:
            - label: "Re-test after interlock fix"
              next: A3

        FIX_AUX_FEEDBACK:
          prompt: |
            *Fix: Aux Feedback*
            The controller isn’t seeing the contactor state change.
          actions:
            - "Repair/replace aux contact block (if separate) or harness."
            - "Reseat connectors; re-crimp damaged terminals."
          options:
            - label: "Re-test after feedback fix"
              next: A3

        FIX_PSU_OR_SUPPLY:
          prompt: |
            *Fix: Coil/PSU Undervoltage*
            If coil voltage sags or PSU rail is low:
            • check control PSU outputs
            • check for loose/burnt terminals
            • confirm upstream voltage stability under load
          actions:
            - "Measure PSU rail under actuation attempt."
            - "Inspect for heat damage and high resistance joints."
          options:
            - label: "Re-test after PSU/supply work"
              next: A3
            - label: "PSU suspected failed (replace/dispatch part)"
              next: DISPATCH_PSU

        FIX_WIRING:
          prompt: |
            *Fix: Wiring/Connector*
            Repair open-circuit/loose coil drive or feedback wiring.
          actions:
            - "Continuity check between controller outputs and coil terminals."
            - "Reseat/replace connectors, repair damaged loom."
          options:
            - label: "Re-test after wiring fix"
              next: A3

        REPLACE_CONTACTOR:
          prompt: |
            *Replace: AC Contactor*
            Replace if:
            • coil voltage is present but no pull-in
            • contacts welded/pitted
            • persistent chatter with correct voltage
          actions:
            - "Torque terminals to spec."
            - "Verify aux feedback wiring after replacement."
          options:
            - label: "Re-test after replacement"
              next: A3

        DISPATCH_PSU:
          prompt: |
            *Action: Dispatch / Replace Control PSU*
            Based on measurements, the control PSU rail is unstable/low and preventing reliable contactor operation.
          actions:
            - "Dispatch PSU or schedule replacement."
          options:
            - label: "After PSU replaced, re-test"
              next: A3

        ESCALATE_AUTEL:
          prompt: |
            *Escalate to Autel Support*
            Provide:
            • fault timestamp
            • measured L-L voltages
            • coil voltage during pull-in attempt
            • aux feedback state result
            • interlock status
            • firmware version + config summary
          actions:
            - "Request logs + controller diagnostics guidance."
          options:
            - label: "Back to start"
              next: A0

        MONITOR:
          prompt: |
            *Monitor*
            Fault cleared. If it reoccurs:
            • suspect marginal PSU/coil voltage or feedback intermittency
            • capture logs before clearing next time
          actions:
            - "Monitor station and record recurrence conditions (temp/load/time)."
          options:
            - label: "Back to start"
              next: A0


  - id: insulation_monitor_fault
    platform: autel
    charger_type: dc
    title: "Insulation Monitoring / IMD Fault"
    severity: high
    tags:
      - insulation
      - imd
      - leakage
      - dc_bus
      - moisture

    response:
      telegram_markdown: |
        *Autel DC — Insulation Monitoring (IMD) Fault*
        The charger has detected **leakage between DC conductors and earth**.
        This is a *safety-critical* fault and must not be bypassed.

    safety:
      telegram_markdown: |
        *Safety*
        • LOTO and prove dead.
        • Treat as live leakage until confirmed otherwise.
        • Do NOT megger unless manufacturer procedure allows it.

    decision_tree:
      start_node: I0
      nodes:
        I0:
          prompt: |
            *IMD Fault — Start*
            Is the fault active right now and preventing DC enable?
          actions:
            - "Capture fault code, timestamp, and weather conditions."
          options:
            - label: "Yes, active now"
              next: I1
            - label: "Intermittent / cleared"
              next: I2

        I1:
          prompt: |
            *Visual Moisture Check (Most Common)*
            Inspect for:
            • Water ingress
            • Condensation
            • Damp cable glands or base
          actions:
            - "Inspect cabinet base, filters, glands, DC terminals."
          options:
            - label: "Moisture / ingress found"
              next: FIX_INGRESS
            - label: "Dry / no visible ingress"
              next: I3

        I2:
          prompt: |
            *Intermittent IMD*
            Often triggered by humidity, rain, or condensation.
          actions:
            - "Ask: did this occur after rain or washdown?"
          options:
            - label: "Continue checks"
              next: I1

        I3:
          prompt: |
            *DC Output & Bus Inspection*
            Check:
            • DC cables and connectors
            • Busbars for tracking or contamination
          actions:
            - "Look for carbon tracking, residue, damaged insulation."
          options:
            - label: "Damage or contamination found"
              next: FIX_DC_CONTAMINATION
            - label: "No visible issue"
              next: I4

        I4:
          prompt: |
            *IMD Self-Test / Reset*
            Perform a full power-down and restart.
          actions:
            - "AC isolator OFF → wait discharge → ON."
          options:
            - label: "Fault clears"
              next: MONITOR
            - label: "Fault returns"
              next: ESCALATE_IMD

        FIX_INGRESS:
          prompt: |
            *Fix: Water Ingress*
            Root cause is moisture intrusion.
          actions:
            - "Dry cabinet (controlled method only)."
            - "Repair/replace seals, glands, filters."
          options:
            - label: "Re-test after drying"
              next: I4

        FIX_DC_CONTAMINATION:
          prompt: |
            *Fix: DC Contamination*
            Tracking or residue is causing leakage.
          actions:
            - "Clean per OEM procedure."
            - "Replace damaged insulation/components."
          options:
            - label: "Re-test after repair"
              next: I4

        ESCALATE_IMD:
          prompt: |
            *Escalate — IMD / Leakage*
            Provide:
            • Fault code & timestamp
            • Weather conditions
            • Photos of cabinet & DC paths
          actions:
            - "Request OEM IMD diagnostics guidance."
          options:
            - label: "Back to start"
              next: I0

        MONITOR:
          prompt: |
            *Monitor*
            IMD cleared.
            If it reoccurs, ingress or insulation breakdown is likely.
          actions:
            - "Monitor after rain/high humidity."
          options:
            - label: "Back to start"
              next: I0


  - id: communication_fault_ocpp
    platform: autel
    charger_type: dc
    title: "OCPP / Backend Communication Fault"
    severity: medium
    tags:
      - ocpp
      - modem
      - sim
      - backend
      - network

    decision_tree:
      start_node: C0
      nodes:
        C0:
          prompt: |
            *OCPP / Backend Fault — Start*
            Is the charger currently **offline** in the backend?
          actions:
            - "Confirm status in backend platform."
          options:
            - label: "Yes, offline"
              next: C1
            - label: "Online but sessions fail"
              next: C4

        C1:
          prompt: |
            *Check Modem Status*
            Verify:
            • SIM present & active
            • Signal strength
          actions:
            - "Check router/modem LEDs or diagnostics."
          options:
            - label: "No signal / SIM issue"
              next: FIX_SIM
            - label: "Signal OK"
              next: C2

        C2:
          prompt: |
            *Power Cycle Comms*
            Restart modem/control module.
          actions:
            - "Wait up to 10 minutes for OCPP reconnect."
          options:
            - label: "Reconnects"
              next: MONITOR
            - label: "Still offline"
              next: C3

        C3:
          prompt: |
            *Configuration Check*
            Verify:
            • APN
            • DNS
            • OCPP URL
            • Time/date
          actions:
            - "Correct any mismatch."
          options:
            - label: "Fixed after config"
              next: MONITOR
            - label: "Still failing"
              next: ESCALATE_OCPP

        C4:
          prompt: |
            *Authorization Failure*
            Does RFID/app fail at authorization?
          actions:
            - "Test with known-good RFID/app."
          options:
            - label: "Auth now works"
              next: MONITOR
            - label: "Still failing"
              next: ESCALATE_OCPP

        FIX_SIM:
          prompt: |
            *Fix: SIM / Signal*
            Root cause is connectivity.
          actions:
            - "Check antenna, SIM status, carrier coverage."
          options:
            - label: "Re-test after fix"
              next: C2

        ESCALATE_OCPP:
          prompt: |
            *Escalate — Backend/OCPP*
            Provide:
            • Logs
            • SIM ICCID & carrier
            • OCPP status screenshots
          actions:
            - "Raise to network/OEM support."
          options:
            - label: "Back to start"
              next: C0

        MONITOR:
          prompt: |
            *Monitor*
            OCPP stable.
          actions:
            - "Confirm stable heartbeat over time."
          options:
            - label: "Back to start"
              next: C0


  - id: emergency_stop_active
    platform: autel
    charger_type: dc
    title: "E-Stop / Interlock Active"
    severity: high
    tags:
      - safety
      - interlock
      - estop

    decision_tree:
      start_node: E0
      nodes:
        E0:
          prompt: |
            *E-Stop / Interlock Fault — Start*
            Is the charger preventing startup due to safety?
          actions:
            - "Identify which interlock is indicated."
          options:
            - label: "Yes"
              next: E1

        E1:
          prompt: |
            *Check All E-Stops*
            Including:
            • Charger
            • Remote pedestals
          actions:
            - "Twist/pull to reset fully."
          options:
            - label: "E-Stop was engaged"
              next: FIX_ESTOP
            - label: "All released"
              next: E2

        E2:
          prompt: |
            *Door / Panel Interlocks*
            Confirm all doors closed and aligned.
          actions:
            - "Inspect microswitches and wiring."
          options:
            - label: "Door/interlock fault found"
              next: FIX_INTERLOCK
            - label: "No issue found"
              next: ESCALATE_INTERLOCK

        FIX_ESTOP:
          prompt: |
            *Fix: E-Stop*
            Reset restored safety loop.
          actions:
            - "Confirm UI clears and contactors enable."
          options:
            - label: "Re-test"
              next: MONITOR

        FIX_INTERLOCK:
          prompt: |
            *Fix: Door Interlock*
            Repair or adjust faulty interlock.
          actions:
            - "Replace damaged switch or wiring."
          options:
            - label: "Re-test"
              next: MONITOR

        ESCALATE_INTERLOCK:
          prompt: |
            *Escalate — Safety Loop*
            Possible internal safety relay or wiring fault.
          actions:
            - "Provide fault screen + photos."
          options:
            - label: "Back to start"
              next: E0

        MONITOR:
          prompt: |
            *Monitor*
            Safety fault cleared.
          actions:
            - "Ensure no recurrence."
          options:
            - label: "Back to start"
              next: E0


  - id: cooling_fan_fault_overtemp
    platform: autel
    charger_type: dc
    title: "Cooling / Fan Fault (Overtemperature Risk)"
    severity: medium
    tags:
      - cooling
      - fan
      - thermal
      - overtemp

    decision_tree:
      start_node: T0
      nodes:
        T0:
          prompt: |
            *Cooling / Overtemp Fault — Start*
            Has the charger derated or stopped due to temperature?
          actions:
            - "Note ambient temperature and load."
          options:
            - label: "Yes"
              next: T1

        T1:
          prompt: |
            *Filter Check (Most Common)*
            Are filters blocked or dirty?
          actions:
            - "Inspect intake and exhaust filters."
          options:
            - label: "Dirty/blocked"
              next: FIX_FILTERS
            - label: "Clean"
              next: T2

        T2:
          prompt: |
            *Fan Operation*
            Do fans run when commanded?
          actions:
            - "Listen and visually confirm airflow."
          options:
            - label: "Fan not running / noisy"
              next: FIX_FAN
            - label: "Fans OK"
              next: T3

        T3:
          prompt: |
            *Thermal Re-Test*
            Run controlled load after cooldown.
          actions:
            - "Monitor temps and derating."
          options:
            - label: "No fault"
              next: MONITOR
            - label: "Fault returns"
              next: ESCALATE_THERMAL

        FIX_FILTERS:
          prompt: |
            *Fix: Filters*
            Restricted airflow caused overheating.
          actions:
            - "Clean or replace filters."
          options:
            - label: "Re-test"
              next: T3

        FIX_FAN:
          prompt: |
            *Fix: Fan*
            Cooling fan failed or degraded.
          actions:
            - "Replace fan assembly."
          options:
            - label: "Re-test"
              next: T3

        ESCALATE_THERMAL:
          prompt: |
            *Escalate — Thermal*
            Possible sensor or internal cooling fault.
          actions:
            - "Send logs, temps, photos."
          options:
            - label: "Back to start"
              next: T0

        MONITOR:
          prompt: |
            *Monitor*
            Cooling operating normally.
          actions:
            - "Recommend filter maintenance interval."
          options:
            - label: "Back to start"
              next: T0
