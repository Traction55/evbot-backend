# autel.yml
# EVBot Fault Pack: Autel (On-site Technician v1) ‚Äî General-DC-style (symptom-first, gated, canonical clusters)
#
# Convention pass (Jan 2026):
# - Evidence nodes renamed to *_EVIDENCE
# - Escalation nodes renamed to *_ESC
# - Resolution nodes renamed to *_DONE
# - Routing kept inside the same flow (no mid-flow menu bounce)
# - IDs for fault entries remain stable
#
# Notes:
# - Node-based decision tree: start_node + nodes map
# - node.options MUST be a LIST of {label, next}
# - image: autel/<filename_without_extension> (expects files in assets/images/autel/*.png)

faults:

  # ============================================================
  # (1) GOLD STANDARD CLUSTER: Autel HV Enable / Power-Stage Start Sequence
  # Canonical flow for:
  # - Start inhibited / start failed
  # - Precharge / DC bus not building
  # - DC output contactor cannot close / verify
  # - AC input contactor issues that affect HV enable
  # - ‚ÄúClicks then faults‚Äù
  # ============================================================

  - id: autel_power_stage_cluster
    platform: autel
    charger_type: dc
    title: "HV Enable / Power-Stage Start Inhibit (Precharge / DC Bus / Contactors)"
    severity: critical
    tags: [power_stage, hv_enable, precharge, dc_bus, contactor, interlock, insulation, start_inhibit]

    aliases:
      - "Power-stage fault"
      - "HV start inhibited"
      - "HV enable fault"
      - "start failed"
      - "precharge fault"
      - "pre-charge fault"
      - "dc bus fault"
      - "dc bus not ready"
      - "dc bus undervoltage"
      - "dc bus overvoltage"
      - "output contactor fault"
      - "dc contactor failed"
      - "failed to close contactor"
      - "ac contactor fault"
      - "input contactor fault"
      - "internal power fault"

    triggers:
      any_text_contains:
        - "power-stage"
        - "power stage"
        - "hv enable"
        - "hv start"
        - "start inhibited"
        - "start failed"
        - "precharge"
        - "pre-charge"
        - "dc bus"
        - "bus undervoltage"
        - "bus overvoltage"
        - "output contactor"
        - "dc contactor"
        - "failed to close"
        - "contactor failed"
        - "verify failed"
        - "welded contactor"
        - "ac contactor"
        - "input contactor"
        - "interlock open"
        - "door interlock"
        - "hvil"
        - "e-stop"
        - "estop"
        - "insulation"
        - "isolation"
        - "imd"

    description: >
      The charger is preventing HV start or cannot complete the HV start sequence (enable ‚Üí precharge ‚Üí DC bus build ‚Üí
      contactor verification). The fastest wins come from gating: safety/visual ‚Üí supply sanity ‚Üí interlock/HVIL ‚Üí IMD/isolation.
      Only after gates are cleared do you chase contactors/DC bus. Capture the ‚Äúfirst fault that returns‚Äù after a clean reboot.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - Treat insulation/isolation alarms as high risk; avoid repeated start attempts
      - Do not bypass HVIL/interlocks; do not repeatedly reset trips

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated hand tools
      - Torch / inspection light
      - IR thermometer (optional)

    decision_tree:
      start_node: PS0
      nodes:

        PS0:
          prompt: |
            ‚ö° *Autel ‚Äî HV Enable / Power-Stage Start Inhibit*
            Start with what you‚Äôre seeing (symptom-first). Pick the closest:
          options:
            - label: "üö´ Won‚Äôt start / fails immediately"
              next: PS_PATTERN_START_FAIL
            - label: "‚ö†Ô∏è Clicks/tries then faults quickly"
              next: PS_PATTERN_CLICKS
            - label: "üü™ Insulation / Isolation / IMD alarm present"
              next: PS_ISO_GATE
            - label: "‚¨õ Interlock / HVIL / E-stop indicated"
              next: PS_INTERLOCK_GATE
            - label: "üîå Supply unstable / undervoltage / phase issue suspected"
              next: PS_SUPPLY_GATE
            - label: "üîé I have a specific message (precharge/DC bus/contactor)"
              next: PS_CODE_ROUTER

        PS_PATTERN_START_FAIL:
          prompt: |
            *Pattern check ‚Äî Start fails*
            Do you see an explicit block reason on HMI/logs?
          options:
            - label: "üü™ Isolation/IMD"
              next: PS_ISO_GATE
            - label: "‚¨õ Interlock/HVIL/E-stop"
              next: PS_INTERLOCK_GATE
            - label: "üü• Contactor / Precharge / DC bus"
              next: PS_SAFE_REBOOT
            - label: "No obvious reason shown"
              next: PS_SAFE_REBOOT

        PS_PATTERN_CLICKS:
          prompt: |
            *Pattern check ‚Äî Clicks then faults*
            Most often: supply sag at enable, interlock gating, or contactor/DC bus verification.
            Proceed with safe-first recovery to identify the *first fault that returns*.
          options:
            - label: "Continue ‚û°Ô∏è"
              next: PS_SAFE_REBOOT

        PS_CODE_ROUTER:
          prompt: |
            *Quick routing (choose closest)*
          options:
            - label: "üü• DC/Output contactor failed / failed to close / verify"
              next: PS_SAFE_REBOOT
            - label: "üü¶ Precharge fault / DC bus not ready / undervoltage"
              next: PS_SAFE_REBOOT
            - label: "üüß DC bus overvoltage"
              next: PS_DC_BUS_OV
            - label: "üü™ Insulation / isolation / IMD"
              next: PS_ISO_GATE
            - label: "‚¨õ Interlock / HVIL / E-stop"
              next: PS_INTERLOCK_GATE
            - label: "‚ùì Not sure"
              next: PS_SAFE_REBOOT

        PS_SAFE_REBOOT:
          prompt: |
            ‚úÖ *Safe recovery first (do this once, cleanly)*
            1) Confirm: no smoke/heat/water ingress
            2) Controlled reboot or full power cycle
            3) Note the *first* fault/message that returns (root clue)
          options:
            - label: "Recovered ‚úÖ"
              next: AUTEL_PS_DONE
            - label: "Still failing"
              next: PS_VISUAL

        PS_VISUAL:
          prompt: |
            üëÄ *Visual checks (non-invasive)*
            - Burnt smell / discoloration / melted insulation?
            - Water ingress / wet marks?
            - Harness strain / loose external connectors?
          options:
            - label: "üî• Unsafe condition found"
              next: AUTEL_PS_ESC_UNSAFE
            - label: "Looks OK"
              next: PS_SUPPLY_GATE

        PS_SUPPLY_GATE:
          prompt: |
            ‚ö° *Supply sanity check*
            Any upstream trip, undervoltage/phase loss alarm, or known site instability?
          options:
            - label: "Yes ‚Äî supply issue suspected"
              next: PS_SUPPLY_ACTIONS
            - label: "No / unknown"
              next: PS_INTERLOCK_GATE

        PS_SUPPLY_ACTIONS:
          prompt: |
            *Supply actions (safe-first)*
            - Check upstream breaker/isolator
            - If authorised: confirm L-L voltages present and not sagging badly at enable
            - Stabilise supply before deeper charger work
          options:
            - label: "Supply corrected ‚Üí retry"
              next: PS_SAFE_REBOOT
            - label: "Supply seems OK ‚Üí continue"
              next: PS_INTERLOCK_GATE
            - label: "Can‚Äôt verify ‚Üí evidence + escalate"
              next: AUTEL_PS_EVIDENCE

        PS_INTERLOCK_GATE:
          prompt: |
            ‚¨õ *Interlock / HVIL gate*
            If any interlock is open, HV start will be inhibited. Clear this before chasing power-stage parts.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock cleared ‚Üí retry"
              next: PS_SAFE_REBOOT
            - label: "Interlock won‚Äôt clear"
              next: AUTEL_PS_EVIDENCE

        PS_ISO_GATE:
          prompt: |
            üü™ *Isolation / IMD gate (high risk)*
            Treat as safety critical:
            - Avoid repeated start attempts
            - Inspect connector face + cabinet for moisture/contamination/burn marks
          options:
            - label: "Continue ‚û°Ô∏è"
              next: PS_ISO_ACTIONS

        PS_ISO_ACTIONS:
          prompt: |
            *Isolation actions*
            - Record exact IMD/isolation message + timestamp
            - Inspect connector face (water/debris/burn marks)
            - If repeatable across EVs/ports: tag out affected port and escalate
          options:
            - label: "Evidence pack ‚Üí escalate"
              next: AUTEL_PS_EVIDENCE
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        PS_DC_BUS_OV:
          prompt: |
            üüß *DC bus overvoltage*
            Do NOT repeatedly retry. Capture evidence and escalate.
          options:
            - label: "Evidence pack ‚Üí escalate"
              next: AUTEL_PS_EVIDENCE
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        AUTEL_PS_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî HV Enable / Power-Stage*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Any supply alarms / measured L-L voltages (if taken)
            - Interlock/HVIL status
            - IMD/isolation status (if shown)
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: AUTEL_PS_ESC
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        AUTEL_PS_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise.
            Provide photos + what you observed (smell/heat/water ingress).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_PS_ESC:
          prompt: |
            *Escalate ‚Äî Autel HV Enable / Power-Stage Start Inhibit*
            Include:
            - Exact code/text + timestamps
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL/IMD status
            - Actions taken (reboot/power cycle)
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_PS_DONE:
          prompt: |
            ‚úÖ *Resolved*
            HV start restored. Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (2) UX-FIXED ROUTED ENTRY: AC Contactor Fault (ID stable; no menu bounce)
  # ============================================================

  - id: autel_ac_contactor_fault
    platform: autel
    charger_type: dc
    title: "AC Contactor Fault (Autel DC)"
    severity: high
    tags: [power, input, contactor, hv_enable, start_inhibit, interlock, supply]

    aliases:
      - "AC Contactor Fault"
      - "AC contactor error"
      - "input contactor fault"
      - "main contactor fault"
      - "contactor open feedback"
      - "contactor feedback error"
      - "input relay fault"
      - "mains contactor fault"

    triggers:
      any_text_contains:
        - "ac contactor"
        - "input contactor"
        - "main contactor"
        - "contactor feedback"
        - "open feedback"
        - "mains contactor"
        - "input relay"

    description: >
      AC contactor alarms are usually part of the HV enable/start sequence (supply stability + interlocks/HVIL + control power).
      This entry embeds the canonical gates so the tech never has to back out to a different menu item.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - Do not bypass interlocks/HVIL

    decision_tree:
      start_node: AC0
      nodes:

        AC0:
          prompt: |
            ‚ö° *Autel ‚Äî AC Contactor Fault (Field Flow)*
            Start symptom-first. What are you seeing?
          options:
            - label: "üö´ Won‚Äôt start / fails immediately"
              next: AC_PATTERN_FAIL
            - label: "‚ö†Ô∏è Clicks/tries then faults"
              next: AC_REBOOT
            - label: "‚¨õ Interlock/HVIL/E-stop indicated"
              next: AC_INTERLOCK
            - label: "üîå Supply issue suspected (undervoltage/phase)"
              next: AC_SUPPLY
            - label: "üü™ IMD/Isolation alarm appears"
              next: AC_IMD
            - label: "üîé Not sure"
              next: AC_REBOOT

        AC_PATTERN_FAIL:
          prompt: |
            *Pattern ‚Äî Start fails*
            Do you see any explicit block reason?
          options:
            - label: "Interlock/HVIL/E-stop"
              next: AC_INTERLOCK
            - label: "Supply/undervoltage/phase"
              next: AC_SUPPLY
            - label: "No clear reason"
              next: AC_REBOOT

        AC_REBOOT:
          prompt: |
            ‚úÖ *Clean recovery step*
            Do a controlled reboot/power cycle ONCE.
            Then note the *first* fault that returns.
          options:
            - label: "Recovered ‚úÖ"
              next: AUTEL_AC_DONE
            - label: "Still faulting"
              next: AC_VISUAL

        AC_VISUAL:
          prompt: |
            üëÄ *Visual check (non-invasive)*
            - Burnt smell/heat/discoloration?
            - Water ingress/wet marks?
            - Harness strain/loose external connectors?
          options:
            - label: "üî• Unsafe condition"
              next: AUTEL_AC_ESC_UNSAFE
            - label: "Looks OK"
              next: AC_SUPPLY

        AC_SUPPLY:
          prompt: |
            ‚ö° *Supply gate*
            Check upstream isolator/CB. If authorised: confirm L-L voltages present and not sagging badly at enable.
          options:
            - label: "Supply corrected ‚Üí retry"
              next: AC_REBOOT
            - label: "Supply OK / not the issue"
              next: AC_INTERLOCK
            - label: "Can‚Äôt verify"
              next: AUTEL_AC_EVIDENCE

        AC_INTERLOCK:
          prompt: |
            ‚¨õ *Interlock / HVIL gate*
            If any interlock is open, AC contactor/HV enable can be inhibited.
            Clear interlocks before chasing parts.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock cleared ‚Üí retry"
              next: AC_REBOOT
            - label: "Interlock won‚Äôt clear"
              next: AUTEL_AC_EVIDENCE

        AC_IMD:
          prompt: |
            üü™ *IMD/Isolation appeared*
            Treat as safety critical. Avoid repeated attempts.
            Inspect connector face + cabinet for moisture/contamination/burn marks.
          options:
            - label: "Evidence pack"
              next: AUTEL_AC_EVIDENCE
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        AUTEL_AC_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî AC Contactor / HV Enable path*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL status
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: AUTEL_AC_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_AC_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise. Provide photos + what you observed.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_AC_ESC:
          prompt: |
            *Escalate ‚Äî AC Contactor Fault*
            Include evidence pack + any supply/interlock findings.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_AC_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (3) UX-FIXED ROUTED ENTRY: DC Contactor Fault (ID stable; no menu bounce)
  # ============================================================

  - id: autel_dc_contactor_fault
    platform: autel
    charger_type: dc
    title: "DC Contactor Fault / Failed to Close (Autel DC)"
    severity: high
    tags: [dc, contactor, hv_enable, start_inhibit, interlock, supply, precharge]

    aliases:
      - "DC Contactor Fault"
      - "output contactor fault"
      - "failed to close"
      - "contactor verify failed"
      - "verify failed"
      - "welded contactor"

    triggers:
      any_text_contains:
        - "dc contactor"
        - "output contactor"
        - "failed to close"
        - "verify failed"
        - "welded contactor"

    description: >
      DC contactor faults are typically part of the HV enable/start sequence (precharge/DC bus/verification).
      This entry embeds the canonical gates so the tech stays in one flow.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - If IMD/isolation appears, stop repeated attempts and escalate

    decision_tree:
      start_node: DC0
      nodes:

        DC0:
          prompt: |
            üü• *Autel ‚Äî DC Contactor Failed to Close (Field Flow)*
            Start symptom-first. What are you seeing?
          options:
            - label: "üö´ Start fails immediately"
              next: DC_REBOOT
            - label: "‚ö†Ô∏è Clicks then faults"
              next: DC_REBOOT
            - label: "‚¨õ Interlock/HVIL/E-stop indicated"
              next: DC_INTERLOCK
            - label: "üîå Supply issue suspected"
              next: DC_SUPPLY
            - label: "üü™ IMD/Isolation alarm appears"
              next: DC_IMD
            - label: "üîé Not sure"
              next: DC_REBOOT

        DC_REBOOT:
          prompt: |
            ‚úÖ *Clean recovery step*
            Controlled reboot/power cycle ONCE.
            Note the *first* fault that returns.
          options:
            - label: "Recovered ‚úÖ"
              next: AUTEL_DC_DONE
            - label: "Still faulting"
              next: DC_VISUAL

        DC_VISUAL:
          prompt: |
            üëÄ *Visual check (non-invasive)*
            - Burnt smell/heat/discoloration?
            - Water ingress/wet marks?
            - Harness strain/loose connectors?
          options:
            - label: "üî• Unsafe condition"
              next: AUTEL_DC_ESC_UNSAFE
            - label: "Looks OK"
              next: DC_SUPPLY

        DC_SUPPLY:
          prompt: |
            ‚ö° *Supply gate*
            Check upstream isolator/CB. If authorised: confirm L-L voltages present and stable at enable.
          options:
            - label: "Supply corrected ‚Üí retry"
              next: DC_REBOOT
            - label: "Supply OK / not the issue"
              next: DC_INTERLOCK
            - label: "Can‚Äôt verify"
              next: AUTEL_DC_EVIDENCE

        DC_INTERLOCK:
          prompt: |
            ‚¨õ *Interlock / HVIL gate*
            If any interlock is open, HV enable/precharge/contactors can be inhibited.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock cleared ‚Üí retry"
              next: DC_REBOOT
            - label: "Interlock won‚Äôt clear"
              next: AUTEL_DC_EVIDENCE

        DC_IMD:
          prompt: |
            üü™ *IMD/Isolation appeared*
            Treat as safety critical. Avoid repeated attempts.
            Inspect connector face + cabinet for moisture/contamination/burn marks.
          options:
            - label: "Evidence pack"
              next: AUTEL_DC_EVIDENCE
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_DC_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî DC Contactor / HV Enable path*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL status
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: AUTEL_DC_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_DC_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise. Provide photos + what you observed.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_DC_ESC:
          prompt: |
            *Escalate ‚Äî DC Contactor Failed to Close*
            Include evidence pack + any supply/interlock findings.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_DC_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (4) Backend / OCPP Communication Fault
  # ============================================================

  - id: autel_backend_ocpp_comms_fault
    platform: autel
    charger_type: dc
    title: "Offline / Backend Comms (Autel DC)"
    severity: high
    tags: [ocpp, network, modem, sim, ethernet, offline]

    aliases:
      - "ocpp offline"
      - "backend offline"
      - "server offline"
      - "network offline"
      - "charger offline"

    triggers:
      any_text_contains:
        - "ocpp"
        - "backend offline"
        - "server offline"
        - "network offline"
        - "charger offline"
        - "offline"

    description: >
      Charger is not connected to backend (OCPP). Highest-yield path: confirm scope ‚Üí controlled reboot ‚Üí
      check link (LTE/Ethernet) ‚Üí check antenna/SIM/cables ‚Üí evidence pack ‚Üí escalate.

    decision_tree:
      start_node: AUTEL_NET0
      nodes:

        AUTEL_NET0:
          prompt: |
            üåê *Offline / Backend Comms ‚Äî Start*
            Is it site-wide (multiple chargers offline) or just this unit?
          options:
            - label: "Multiple chargers offline / site likely"
              next: AUTEL_NET_SITE
            - label: "Only this charger offline"
              next: AUTEL_NET_REBOOT
            - label: "Not sure"
              next: AUTEL_NET_REBOOT

        AUTEL_NET_SITE:
          prompt: |
            *Site gate*
            - Check router/WAN status if accessible
            - Note site outage indicators
          options:
            - label: "Reboot charger after site checks"
              next: AUTEL_NET_REBOOT
            - label: "Evidence pack"
              next: AUTEL_NET_EVIDENCE

        AUTEL_NET_REBOOT:
          prompt: |
            üîÅ *Controlled reboot*
            Reboot/power cycle and wait for registration/OCPP handshake.
          options:
            - label: "Recovered ‚úÖ"
              next: AUTEL_NET_DONE
            - label: "Still offline"
              next: AUTEL_NET_LINKTYPE

        AUTEL_NET_LINKTYPE:
          prompt: |
            *Connection type?*
          options:
            - label: "üì∂ Cellular/LTE"
              next: AUTEL_NET_LTE
            - label: "üîå Ethernet"
              next: AUTEL_NET_ETH
            - label: "‚ùì Not sure"
              next: AUTEL_NET_EVIDENCE

        AUTEL_NET_LTE:
          prompt: |
            üì∂ *LTE checks*
            - Antenna seated/tight, cable not damaged
            - If permitted: reseat SIM
            - Note signal indicators if shown
          options:
            - label: "Retest"
              next: AUTEL_NET_REBOOT
            - label: "Evidence pack"
              next: AUTEL_NET_EVIDENCE

        AUTEL_NET_ETH:
          prompt: |
            üîå *Ethernet checks*
            - Link lights?
            - Reseat cable at charger and switch
            - Try alternate port/cable if permitted
          options:
            - label: "Retest"
              next: AUTEL_NET_REBOOT
            - label: "Evidence pack"
              next: AUTEL_NET_EVIDENCE

        AUTEL_NET_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Offline*
            Capture:
            - Offline message + timestamp
            - Link type (LTE/Ethernet)
            - Antenna/cable/SIM actions performed
            - Any signal/link indicators
          options:
            - label: "Escalate"
              next: AUTEL_NET_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_NET_ESC:
          prompt: |
            *Escalate ‚Äî Offline / Backend Comms*
            Include evidence pack + last known online time + what you tried (reboot/cables/antenna/SIM).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_NET_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Confirm stable backend connection (no repeated dropouts).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (5) Overtemperature / Cooling Fault
  # ============================================================

  - id: autel_overtemp_cooling_fault
    platform: autel
    charger_type: dc
    title: "Overtemp / Cooling Fault (Autel DC)"
    severity: high
    tags: [cooling, fans, filters, thermal, derating, airflow]

    aliases:
      - "overtemp"
      - "over temperature"
      - "thermal"
      - "thermal fault"
      - "fan fault"
      - "cooling fault"
      - "overheat"
      - "derate"
      - "derating"
      - "low power"

    triggers:
      any_text_contains:
        - "overtemp"
        - "over temperature"
        - "thermal"
        - "thermal fault"
        - "fan fault"
        - "cooling fault"
        - "overheat"
        - "derate"
        - "derating"
        - "low power"

    description: >
      Thermal alarm or thermal derating. Most common causes are blocked filters/vents and failed/underperforming fans.
      This flow matches General DC: Safety ‚Üí Filters/Vents ‚Üí Fans ‚Üí Air path ‚Üí Retest ‚Üí Evidence ‚Üí Escalate ‚Üí Done.

    decision_tree:
      start_node: AUTEL_TH0
      nodes:

        AUTEL_TH0:
          prompt: |
            üü´ *Overtemp / Cooling ‚Äî Start*
            Quick triage:
            ‚Ä¢ Is the charger in direct sun / hot ambient?
            ‚Ä¢ Is airflow obviously blocked (grills packed with dust, leaves, plastic, etc)?
          options:
            - label: "Continue ‚û°Ô∏è"
              next: AUTEL_TH_SAFETY

        AUTEL_TH_SAFETY:
          prompt: |
            ‚úÖ *Safety / access*
            If cabinet access is required:
            ‚Ä¢ Follow site procedure / LOTO as required
            ‚Ä¢ Fans may start automatically
            ‚Ä¢ Keep hands clear of fan blades
          options:
            - label: "Continue ‚û°Ô∏è"
              next: AUTEL_TH_FILTERS

        AUTEL_TH_FILTERS:
          prompt: |
            üßº *Filters / vents / grills*
            Inspect and clear:
            ‚Ä¢ Intake filters / louvers
            ‚Ä¢ Exhaust grills
            ‚Ä¢ Dust mats, leaves, insects, nests, plastic film, debris
            Action:
            ‚Ä¢ Clean/replace filters if blocked
            ‚Ä¢ Vacuum grills / clear obstructions
            Were filters/vents dirty or blocked?
          image: autel/cooling_filters_location
          options:
            - label: "Yes ‚Äî dirty/blocked (cleaned or will clean now)"
              next: AUTEL_TH_FANS
            - label: "No ‚Äî looks clear"
              next: AUTEL_TH_FANS

        AUTEL_TH_FANS:
          prompt: |
            üåÄ *Fan operation check*
            Confirm:
            ‚Ä¢ Fans are spinning when expected (thermal alarm / under load)
            ‚Ä¢ Airflow feels normal (not weak / reversed)
            ‚Ä¢ No abnormal noise/vibration
            ‚Ä¢ No jammed blades / fouled guards
            ‚Ä¢ No loose connectors (authorised only)
            Are all expected fans running normally?
          image: autel/cooling_fan_location
          options:
            - label: "Yes ‚Äî fans OK"
              next: AUTEL_TH_AIRPATH
            - label: "No ‚Äî fan issue / abnormal"
              next: AUTEL_TH_FAN_ACTIONS

        AUTEL_TH_FAN_ACTIONS:
          prompt: |
            üõ†Ô∏è *Fan issue actions*
            Do:
            ‚Ä¢ Remove debris / unjam blades (if safe)
            ‚Ä¢ Reseat fan connector(s) (authorised only)
            ‚Ä¢ Check guards not contacting blades
            ‚Ä¢ If you can identify a failed fan position, note it clearly
          options:
            - label: "Continue to retest ‚û°Ô∏è"
              next: AUTEL_TH_RETEST

        AUTEL_TH_AIRPATH:
          prompt: |
            üå¨Ô∏è *Airflow path / cabinet conditions*
            Check:
            ‚Ä¢ Internal air path not blocked (loose insulation / plastic film / debris)
            ‚Ä¢ Doors/panels seated correctly
            ‚Ä¢ Hot exhaust not recirculating into intake
            ‚Ä¢ Heat exchanger/radiator fins (if applicable) not clogged
            Any issues found?
          options:
            - label: "Yes ‚Äî corrected airflow/path issue"
              next: AUTEL_TH_RETEST
            - label: "No ‚Äî airflow path seems normal"
              next: AUTEL_TH_RETEST

        AUTEL_TH_RETEST:
          prompt: |
            üîÅ *Retest*
            Steps:
            ‚Ä¢ Clear alarm if possible (HMI/reset)
            ‚Ä¢ Reboot only if permitted
            ‚Ä¢ Start a test session and monitor 5‚Äì10 minutes
            Did the fault/derate clear after filter/fan/airflow actions?
          options:
            - label: "Cleared ‚úÖ"
              next: AUTEL_TH_DONE
            - label: "Still faulting"
              next: AUTEL_TH_EVIDENCE

        AUTEL_TH_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Overtemp/Cooling*
            Capture:
            ‚Ä¢ Alarm text + timestamp
            ‚Ä¢ Ambient temp / sun exposure notes
            ‚Ä¢ Photos of filters/grills (before/after)
            ‚Ä¢ Which fans running / not running (video if possible)
            ‚Ä¢ Any abnormal noise/vibration
            ‚Ä¢ Notes on doors/panels seated + airflow path condition
          options:
            - label: "Escalate"
              next: AUTEL_TH_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_TH_ESC:
          prompt: |
            *Escalate ‚Äî Overtemp/Cooling*
            Include evidence pack + what you tried (filters/fans/airflow/retest).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_TH_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stability:
            ‚Ä¢ No repeat thermal alarms
            ‚Ä¢ Fans ramp normally under load
            ‚Ä¢ Session sustains without abnormal derating
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (6) Power Module Fault (kept as an entry label; routes when needed)
  # ============================================================

  - id: autel_power_module_fault
    platform: autel
    charger_type: dc
    title: "Power Module Fault / Module Offline (Autel DC)"
    severity: high
    tags: [power_module, rectifier, module_offline, routed, hv_enable]

    aliases:
      - "module offline"
      - "power module offline"
      - "rectifier module fault"
      - "power module fault"

    triggers:
      any_text_contains:
        - "power module"
        - "module offline"
        - "rectifier"
        - "power module fault"

    description: >
      First action is reseat to eliminate poor seating/connection. If the symptom also includes start inhibit,
      precharge/DC bus/contactor messages, use the canonical HV Enable / Power-Stage cluster.

    decision_tree:
      start_node: PM0
      nodes:

        PM0:
          prompt: |
            üß© *Power Module Offline ‚Äî Start*
            Are you seeing HV start inhibited / precharge/DC bus/contactor messages too?
          options:
            - label: "Yes ‚Äî start inhibited / clicks then faults"
              next: PM_ROUTE_CLUSTER
            - label: "No ‚Äî just a module offline/alarm"
              next: PM1

        PM1:
          prompt: |
            *Reseat (authorised only)*
            Apply LOTO, reseat the affected module/connection, then retest.
          options:
            - label: "Retest"
              next: PM2

        PM2:
          prompt: |
            Did the module return online?
          options:
            - label: "Resolved ‚úÖ"
              next: AUTEL_PM_DONE
            - label: "Still offline"
              next: AUTEL_PM_EVIDENCE

        PM_ROUTE_CLUSTER:
          prompt: |
            Routing to canonical flow:
            *HV Enable / Power-Stage Start Inhibit (Precharge / DC Bus / Contactors)*
          options:
            - label: "Open HV Enable cluster"
              next: PS0

        AUTEL_PM_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Power Module Offline*
            Capture:
            - Which module/slot (if known)
            - Any module LEDs / indicators
            - Actions taken (reseat)
            - Timestamps and photos
            - Whether charging possible at reduced power
          options:
            - label: "Escalate"
              next: AUTEL_PM_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_PM_ESC:
          prompt: |
            *Escalate ‚Äî Power Module Offline*
            Include evidence pack + whether reseat changed behaviour.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_PM_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Run a short test session and confirm stable operation.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (7) TCU Communication Error (expanded; convention aligned)
  # ============================================================

  - id: autel_tcu_communication_error
    platform: autel
    charger_type: dc
    title: "TCU Communication Error (Telematics/Comms Module)"
    severity: high
    tags: [tcu, comms, modem, antenna, harness, leds, ocpp]

    aliases:
      - "TCU communication error"
      - "TCU comm error"
      - "TCU comms fault"
      - "TCU offline"
      - "telematics offline"
      - "communication with tcu"

    triggers:
      any_text_contains:
        - "tcu communication"
        - "tcu comm"
        - "tcu comms"
        - "tcu offline"
        - "tcu not responding"
        - "telematics"
        - "communication with tcu"

    description: >
      Controller cannot communicate reliably with the TCU. Often presents as intermittent offline events, failed backend
      registration, or repeated comms alarms. Highest-yield field checks: controlled reboot, observe LED states, verify
      antenna and harness seating, then isolate network vs hardware.

    decision_tree:
      start_node: AUTEL_TCU0
      nodes:

        AUTEL_TCU0:
          prompt: |
            üì° *TCU Communication Error ‚Äî Start*
            Is the charger also showing OCPP/backend offline?
          options:
            - label: "‚úÖ Yes (offline as well)"
              next: AUTEL_TCU_REBOOT
            - label: "‚ùå No (charging works / backend ok)"
              next: AUTEL_TCU_LED_CHECK
            - label: "Not sure"
              next: AUTEL_TCU_REBOOT

        AUTEL_TCU_REBOOT:
          prompt: |
            üîÅ *Controlled reboot first*
            Reboot via HMI/service menu if available; otherwise controlled power cycle.
            Then check if the alarm returns.
          options:
            - label: "Recovered ‚úÖ"
              next: AUTEL_TCU_DONE
            - label: "Still faulting"
              next: AUTEL_TCU_LED_CHECK

        AUTEL_TCU_LED_CHECK:
          prompt: |
            üí° *TCU LED / status check*
            Observe TCU indicators (power/status/network) if accessible.
            What do you see?
          options:
            - label: "No LEDs / dead"
              next: AUTEL_TCU_POWER_HARNESS
            - label: "LEDs on but abnormal (no network / stuck pattern)"
              next: AUTEL_TCU_ANTENNA
            - label: "LEDs normal but alarm persists"
              next: AUTEL_TCU_NETWORK_ALIGN

        AUTEL_TCU_POWER_HARNESS:
          prompt: |
            üîå *Power + harness seating*
            - Check harness connectors are fully seated/latched (controller ‚Üî TCU)
            - Check for loose pins, strain, water ingress
            - If permitted: confirm TCU supply present (control power integrity)
          options:
            - label: "Retest after reseat"
              next: AUTEL_TCU_REBOOT
            - label: "Still faulting"
              next: AUTEL_TCU_ANTENNA

        AUTEL_TCU_ANTENNA:
          prompt: |
            üì∂ *Antenna sanity*
            - Confirm antenna is connected tightly at the TCU
            - Inspect cable for cuts/kinks/crush points
            - If you have a known-good antenna: swap to test
          options:
            - label: "Retest after antenna checks"
              next: AUTEL_TCU_REBOOT
            - label: "Still faulting"
              next: AUTEL_TCU_NETWORK_ALIGN

        AUTEL_TCU_NETWORK_ALIGN:
          prompt: |
            üåê *Network alignment*
            If TCU appears alive but comms persist:
            - Check LTE signal (if shown)
            - If Ethernet is used, confirm link lights/port
            - Confirm time sync/DNS not obviously wrong (if visible)
          options:
            - label: "Evidence pack"
              next: AUTEL_TCU_EVIDENCE
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_TCU_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî TCU*
            Capture:
            - Exact alarm text + timestamps/frequency
            - LED state description (power/status/network)
            - Antenna/harness actions performed
            - Whether backend/offline was also present
          options:
            - label: "Escalate"
              next: AUTEL_TCU_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_TCU_ESC:
          prompt: |
            *Escalate ‚Äî TCU Communication Error*
            Include evidence pack + whether a known-good antenna/harness reseat changed behaviour.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AUTEL_TCU_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Confirm stability (no repeated offline/TCU alarms).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__
