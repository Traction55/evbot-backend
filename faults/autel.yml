# autel.yml
# EVBot Fault Pack: Autel (On-site Technician v1)
# Notes:
# - Node-based decision tree: start_node + nodes map
# - Each node has: prompt, actions, options -> next
# - Keep IDs stable so your bot can deep-link

faults:

  - id: autel_ac_contactor_fault
    platform: autel
    charger_type: dc
    title: "AC Contactor Fault (Autel DC)"
    aliases:
      - "AC Contactor Fault"
      - "AC contactor error"
      - "input contactor fault"
      - "main contactor fault"
      - "contactor open feedback"
      - "contactor feedback error"
    triggers:
      any_text_contains:
        - "ac contactor"
        - "contactor fault"
        - "contactor feedback"
        - "input contactor"
        - "main contactor"
    severity: high
    tags: [power, input, contactor, interlock, feedback, three_phase]

    response:
      telegram_markdown: |
        *Autel DC â€” AC Contactor Fault*
        The charger cannot close or verify the main AC input contactor.

        Most common causes:
        â€¢ Missing phase / imbalance
        â€¢ Low control PSU voltage
        â€¢ Aux feedback or coil wiring fault
        â€¢ Interlock open
        â€¢ Failed contactor

    decision_tree:
      start_node: A0
      nodes:
        A0:
          prompt: "*AC Contactor Fault â€” Start*"
          options:
            - label: "Fault active"
              next: A1
            - label: "Intermittent"
              next: A2

        A1:
          prompt: "*Check site supply*"
          options:
            - label: "Supply OK"
              next: A3
            - label: "Missing phase"
              next: FIX_SUPPLY

        A2:
          prompt: "*Intermittent pattern*"
          options:
            - label: "Continue"
              next: A1

        A3:
          prompt: "*Power cycle & listen for pull-in*"
          options:
            - label: "Cleared"
              next: MONITOR
            - label: "No pull-in"
              next: A4
            - label: "Chatter"
              next: A5
            - label: "Clunks but fault remains"
              next: A6

        A4:
          prompt: "*No pull-in*"
          options:
            - label: "Interlock open"
              next: FIX_INTERLOCK
            - label: "No coil voltage"
              next: A7
            - label: "Voltage present"
              next: REPLACE_CONTACTOR

        A5:
          prompt: "*Chatter / weak pull-in*"
          options:
            - label: "Voltage sag"
              next: FIX_PSU_OR_SUPPLY
            - label: "Voltage OK"
              next: REPLACE_CONTACTOR

        A6:
          prompt: "*Aux feedback issue*"
          options:
            - label: "Feedback fault"
              next: FIX_AUX_FEEDBACK
            - label: "Feedback OK"
              next: A8

        A7:
          prompt: "*No coil command*"
          options:
            - label: "PSU issue"
              next: FIX_PSU_OR_SUPPLY
            - label: "Interlock"
              next: FIX_INTERLOCK
            - label: "Wiring"
              next: FIX_WIRING
            - label: "Controller"
              next: ESCALATE_AUTEL

        A8:
          prompt: "*Firmware / config check*"
          options:
            - label: "Resolved"
              next: MONITOR
            - label: "Still faulting"
              next: ESCALATE_AUTEL

        FIX_SUPPLY:
          prompt: "*Fix supply issue*"
          options:
            - label: "Re-test"
              next: A3

        FIX_INTERLOCK:
          prompt: "*Fix interlock*"
          options:
            - label: "Re-test"
              next: A3

        FIX_AUX_FEEDBACK:
          prompt: "*Fix aux feedback*"
          options:
            - label: "Re-test"
              next: A3

        FIX_PSU_OR_SUPPLY:
          prompt: "*Fix PSU / undervoltage*"
          options:
            - label: "Re-test"
              next: A3

        FIX_WIRING:
          prompt: "*Fix wiring*"
          options:
            - label: "Re-test"
              next: A3

        REPLACE_CONTACTOR:
          prompt: "*Replace AC contactor*"
          options:
            - label: "Re-test"
              next: A3

        ESCALATE_AUTEL:
          prompt: "*Escalate to Autel*"
          options:
            - label: "Back to start"
              next: A0

        MONITOR:
          prompt: "*Monitor*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_dc_contactor_fault
    platform: autel
    charger_type: dc
    title: "DC Contactor Fault / Failed to Close (Autel DC)"
    severity: high
    tags: [dc, contactor, output, hv, safety]

    decision_tree:
      start_node: D0
      nodes:
        D0:
          prompt: "*DC Contactor Fault â€” Start*"
          options:
            - label: "Fault active"
              next: D1
            - label: "Intermittent"
              next: D2

        D1:
          prompt: "*Power cycle and observe*"
          options:
            - label: "Cleared"
              next: MONITOR
            - label: "No pull-in"
              next: D3
            - label: "Closes but faults"
              next: D6

        D2:
          prompt: "*Intermittent behaviour*"
          options:
            - label: "Continue"
              next: D1

        D3:
          prompt: "*Check coil voltage*"
          options:
            - label: "No voltage"
              next: D4
            - label: "Voltage present"
              next: REPLACE_CONTACTOR
            - label: "Voltage sags"
              next: FIX_PSU

        D4:
          prompt: "*No coil command*"
          options:
            - label: "Interlock"
              next: FIX_INTERLOCK
            - label: "Wiring"
              next: FIX_WIRING
            - label: "Controller"
              next: ESCALATE_AUTEL

        D6:
          prompt: "*Aux feedback*"
          options:
            - label: "Feedback fault"
              next: FIX_AUX_FEEDBACK
            - label: "Welded"
              next: REPLACE_CONTACTOR

        FIX_PSU:
          prompt: "*Fix PSU*"
          options:
            - label: "Re-test"
              next: D1

        REPLACE_CONTACTOR:
          prompt: "*Replace DC contactor*"
          options:
            - label: "Re-test"
              next: D1

        ESCALATE_AUTEL:
          prompt: "*Escalate to Autel*"
          options:
            - label: "Back"
              next: D0

        MONITOR:
          prompt: "*Monitor*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_backend_ocpp_comms_fault
    platform: autel
    charger_type: dc
    title: "Backend / OCPP Communication Fault (Autel DC)"
    severity: high
    tags: [ocpp, backend, comms, modem, sim, network]

    decision_tree:
      start_node: C0
      nodes:
        C0:
          prompt: "*Backend / OCPP offline*"
          options:
            - label: "Continue"
              next: C1

        C1:
          prompt: "*Reboot charger*"
          options:
            - label: "Online"
              next: MONITOR
            - label: "Still offline"
              next: C2

        C2:
          prompt: "*Basic checks exhausted*"
          options:
            - label: "ðŸ“ˆ Escalate (standard)"
              next: ESCALATE_AUTEL
            - label: "ðŸ§  Deep dive â€” advanced checks"
              next: ADVANCED_SIM_NETWORK

        ADVANCED_SIM_NETWORK:
          prompt: |
            ðŸ§  *Deep Dive â€” SIM / Network / OCPP*
            Advanced causes to check:
            â€¢ SIM registered on GSM only (no packet data)
            â€¢ Incorrect APN
            â€¢ Carrier outage or throttling
            â€¢ Private IP blocked by backend firewall
            â€¢ DNS or time sync issues
          options:
            - label: "Issue fixed"
              next: C1
            - label: "No issue found"
              next: ESCALATE_AUTEL

        ESCALATE_AUTEL:
          prompt: "*Escalate backend / OCPP*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: "*Monitor*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_overtemp_cooling_fault
    platform: autel
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Autel DC)"
    severity: high
    tags: [cooling, overtemp, fans, filters]

    decision_tree:
      start_node: T0
      nodes:
        T0:
          prompt: "*Overtemperature detected*"
          options:
            - label: "Check airflow"
              next: T1

        T1:
          prompt: "*Filters dirty?*"
          options:
            - label: "Yes"
              next: FIX_FILTERS
            - label: "No"
              next: ESCALATE_AUTEL

        FIX_FILTERS:
          prompt: "*Clean filters*"
          options:
            - label: "Re-test"
              next: MONITOR

        ESCALATE_AUTEL:
          prompt: "*Escalate thermal fault*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: "*Monitor*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_power_module_fault
    platform: autel
    charger_type: dc
    title: "Power Module Fault / Module Offline (Autel DC)"
    severity: high
    tags: [power_module, rectifier, dc_bus, comms, cooling]

    decision_tree:
      start_node: P0
      nodes:
        P0:
          prompt: "*Power module offline*"
          options:
            - label: "Reseat module"
              next: P1

        P1:
          prompt: "*Re-test*"
          options:
            - label: "Resolved"
              next: MONITOR
            - label: "Still offline"
              next: ESCALATE_AUTEL

        ESCALATE_AUTEL:
          prompt: "*Escalate power module*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: "*Monitor*"
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__
