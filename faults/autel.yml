# autel.yml
# EVBot Fault Pack: Autel (On-site Technician v1) â€” Descriptive Merge (nodes-based)
# Notes:
# - Node-based decision tree: start_node + nodes map
# - Each node has: prompt, options -> next (actions optional)
# - Keep IDs stable so your bot can deep-link

faults:

  - id: autel_ac_contactor_fault
    platform: autel
    charger_type: dc
    title: "AC Contactor Fault (Autel DC)"
    aliases:
      - "AC Contactor Fault"
      - "AC contactor error"
      - "input contactor fault"
      - "main contactor fault"
      - "contactor open feedback"
      - "contactor feedback error"

    triggers:
      any_text_contains:
        - "ac contactor"
        - "contactor fault"
        - "contactor feedback"
        - "input contactor"
        - "main contactor"
    severity: high
    tags: [power, input, contactor, interlock, feedback, three_phase]

    description: >
      The charger cannot close or verify the main AC input contactor.
      Most commonly caused by missing/unstable 3-phase supply, undervoltage on the control PSU,
      an open interlock, coil/aux wiring issues, or a failed contactor.

    likely_causes:
      - Missing phase / supply imbalance or sag during pull-in
      - Low control PSU voltage / undervoltage
      - Interlock open (door, E-stop chain, safety loop)
      - Coil wiring / auxiliary feedback wiring loose or damaged
      - Failed contactor (coil/mechanism/contacts)

    safety_notes:
      - LOTO before opening cabinet; wait minimum 5 minutes for DC bus discharge
      - Verify absence of voltage with an approved meter before touching conductors

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated hand tools

    response:
      telegram_markdown: |
        *Autel DC â€” AC Contactor Fault*
        The charger cannot close or verify the main AC input contactor.

        Most common causes:
        â€¢ Missing phase / imbalance
        â€¢ Low control PSU voltage
        â€¢ Aux feedback or coil wiring fault
        â€¢ Interlock open
        â€¢ Failed contactor

    decision_tree:
      start_node: A0
      nodes:
        A0:
          prompt: |
            *AC Contactor Fault â€” Start*
            Is the fault active right now, or only intermittent?
          options:
            - label: "Fault active"
              next: A1
            - label: "Intermittent"
              next: A2

        A1:
          prompt: |
            *Check site supply*
            Confirm 3-phase is present and stable (no missing phase/major imbalance).
          options:
            - label: "Supply OK"
              next: A3
            - label: "Missing phase"
              next: FIX_SUPPLY

        A2:
          prompt: |
            *Intermittent pattern*
            Treat this like a supply/connection/PSU sag issue until proven otherwise. Continue through checks.
          options:
            - label: "Continue"
              next: A1

        A3:
          prompt: |
            *Power cycle & check pull-in*
            Power cycle and listen/observe: does the AC contactor pull in cleanly?
          options:
            - label: "Cleared"
              next: MONITOR
            - label: "No pull-in"
              next: A4
            - label: "Chatter"
              next: A5
            - label: "Clunks but fault remains"
              next: A6

        A4:
          prompt: |
            *No pull-in*
            Work out whether itâ€™s being *blocked* (interlock), *not commanded* (no coil voltage),
            or *failed* (coil voltage present but no pull-in).
          options:
            - label: "Interlock open"
              next: FIX_INTERLOCK
            - label: "No coil voltage"
              next: A7
            - label: "Voltage present"
              next: REPLACE_CONTACTOR

        A5:
          prompt: |
            *Chatter / weak pull-in*
            Usually undervoltage (supply sag / weak control PSU) or a failing contactor.
          options:
            - label: "Voltage sag"
              next: FIX_PSU_OR_SUPPLY
            - label: "Voltage OK"
              next: REPLACE_CONTACTOR

        A6:
          prompt: |
            *Clunks but fault remains*
            Contactor may be moving, but the system canâ€™t verify it. Focus on aux feedback circuit.
          options:
            - label: "Feedback fault"
              next: FIX_AUX_FEEDBACK
            - label: "Feedback OK"
              next: A8

        A7:
          prompt: |
            *No coil command*
            No coil voltage typically points to PSU undervoltage, an open interlock, wiring break, or controller output issue.
          options:
            - label: "PSU / undervoltage"
              next: FIX_PSU_OR_SUPPLY
            - label: "Interlock"
              next: FIX_INTERLOCK
            - label: "Wiring"
              next: FIX_WIRING
            - label: "Controller"
              next: ESCALATE_AUTEL

        A8:
          prompt: |
            *Firmware / config check*
            If supply/pull-in/feedback look OK but it still faults, check firmware/config/logs then escalate if needed.
          options:
            - label: "Resolved"
              next: MONITOR
            - label: "Still faulting"
              next: ESCALATE_AUTEL

        FIX_SUPPLY:
          prompt: |
            *Fix supply issue*
            Restore correct 3-phase supply (phase present, within spec, balanced). Then re-test.
          options:
            - label: "Re-test"
              next: A3

        FIX_INTERLOCK:
          prompt: |
            *Fix interlock*
            Identify which interlock is open (door, E-stop chain, safety loop) and restore continuity. Then re-test.
          options:
            - label: "Re-test"
              next: A3

        FIX_AUX_FEEDBACK:
          prompt: |
            *Fix aux feedback*
            Repair/secure aux feedback wiring and confirm state change during pull-in/pull-out. Then re-test.
          options:
            - label: "Re-test"
              next: A3

        FIX_PSU_OR_SUPPLY:
          prompt: |
            *Fix PSU / undervoltage*
            Address control PSU undervoltage or supply sag during pull-in (connections, PSU health, upstream quality). Then re-test.
          options:
            - label: "Re-test"
              next: A3

        FIX_WIRING:
          prompt: |
            *Fix wiring*
            Repair/secure coil wiring and related harnessing (loose terminals, damaged conductors, heat issues). Then re-test.
          options:
            - label: "Re-test"
              next: A3

        REPLACE_CONTACTOR:
          prompt: |
            *Replace AC contactor*
            Coil voltage present but no reliable pull-in = likely failed contactor. Replace and function test.
          options:
            - label: "Re-test"
              next: A3

        ESCALATE_AUTEL:
          prompt: |
            *Escalate to Autel*
            Include: site voltages, coil command findings, interlock status, feedback checks, and timestamps/logs.
          options:
            - label: "Back to start"
              next: A0

        MONITOR:
          prompt: |
            *Monitor*
            Run a test session and monitor for recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__



  - id: autel_dc_contactor_fault
    platform: autel
    charger_type: dc
    title: "DC Contactor Fault / Failed to Close (Autel DC)"
    severity: high
    tags: [dc, contactor, output, hv, safety]

    description: >
      The charger is unable to close or verify the DC output contactor.
      This can be caused by interlocks, missing coil command, undervoltage/PSU issues,
      wiring faults, auxiliary feedback issues, or a failed/welded contactor.

    likely_causes:
      - No coil command from controller (logic inhibit / controller fault)
      - Interlock preventing closure
      - Coil wiring fault or loose terminals
      - PSU undervoltage or voltage sag at pull-in
      - Failed or welded DC contactor / feedback fault

    safety_notes:
      - DC contactors are HV components; follow LOTO and verify discharge state
      - Wait minimum 5 minutes after isolation for DC bus discharge
      - Use appropriate PPE and confirm absence of voltage before touching conductors

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated tools
      - Clamp meter (optional)
      - Torque driver (if specified by OEM)

    decision_tree:
      start_node: D0
      nodes:
        D0:
          prompt: >
            *DC Contactor Fault â€” Start*
            Confirm whether the fault is active now or intermittent.
          options:
            - label: "Fault active"
              next: D1
            - label: "Intermittent"
              next: D2

        D1:
          prompt: >
            *Power cycle and observe*
            Power cycle and observe contactor behaviour. Youâ€™re proving whether it closes reliably
            and whether the fault clears or persists.
          options:
            - label: "Cleared"
              next: MONITOR
            - label: "No pull-in"
              next: D3
            - label: "Closes but faults"
              next: D6

        D2:
          prompt: >
            *Intermittent behaviour*
            Intermittent faults are often loose wiring, thermal movement, or supply/PSU sag.
            Continue through checks to isolate the root cause.
          options:
            - label: "Continue"
              next: D1

        D3:
          prompt: >
            *Check coil voltage*
            Measure whether coil voltage is present during the close command.
            This tells you whether itâ€™s a command issue or a contactor/mechanical issue.
          options:
            - label: "No voltage"
              next: D4
            - label: "Voltage present"
              next: REPLACE_CONTACTOR
            - label: "Voltage sags"
              next: FIX_PSU

        D4:
          prompt: >
            *No coil command*
            No coil voltage indicates an inhibit condition, interlock open, wiring issue,
            or controller output fault.
          options:
            - label: "Interlock"
              next: FIX_INTERLOCK
            - label: "Wiring"
              next: FIX_WIRING
            - label: "Controller"
              next: ESCALATE_AUTEL

        D6:
          prompt: >
            *Aux feedback*
            If it closes but faults, check the auxiliary feedback circuit and whether the contactor
            may be welded or not reporting state change correctly.
          options:
            - label: "Feedback fault"
              next: FIX_AUX_FEEDBACK
            - label: "Welded"
              next: REPLACE_CONTACTOR

        FIX_PSU:
          prompt: >
            *Fix PSU*
            Address undervoltage and control power stability. Confirm stable voltage during pull-in.
          options:
            - label: "Re-test"
              next: D1

        FIX_INTERLOCK:
          prompt: >
            *Fix interlock*
            Identify the open interlock (door, E-stop chain, safety loop) and restore continuity.
          options:
            - label: "Re-test"
              next: D1

        FIX_WIRING:
          prompt: >
            *Fix wiring*
            Repair/secure wiring to the contactor coil and feedback circuits. Check for heat damage
            and loose terminals.
          options:
            - label: "Re-test"
              next: D1

        FIX_AUX_FEEDBACK:
          prompt: >
            *Fix aux feedback*
            Repair/secure auxiliary feedback wiring and confirm state change.
          options:
            - label: "Re-test"
              next: D1

        REPLACE_CONTACTOR:
          prompt: >
            *Replace DC contactor*
            If coil voltage is present and it wonâ€™t close reliably, replacement is indicated.
            Perform functional test after replacement.
          options:
            - label: "Re-test"
              next: D1

        ESCALATE_AUTEL:
          prompt: >
            *Escalate to Autel*
            Escalate with coil voltage findings, interlock status, wiring checks performed,
            and relevant logs/time stamps.
          options:
            - label: "Back"
              next: D0

        MONITOR:
          prompt: >
            *Monitor*
            Run a test session and monitor for recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_backend_ocpp_comms_fault
    platform: autel
    charger_type: dc
    title: "Backend / OCPP Communication Fault (Autel DC)"
    severity: high
    tags: [ocpp, backend, comms, modem, sim, network]

    description: >
      The charger is offline to the backend (OCPP). This can be caused by modem/SIM issues,
      APN misconfiguration, carrier outage/throttling, DNS/time sync problems, or a backend
      firewall/whitelist issue blocking traffic.

    likely_causes:
      - Charger not registered on packet data (SIM / carrier provisioning)
      - Incorrect APN or APN credentials
      - Carrier outage, poor signal, or throttling
      - DNS resolution failure or time sync drift affecting TLS/OCPP
      - Backend firewall/whitelist blocking private IP ranges

    safety_notes:
      - Network checks can often be performed without opening HV compartments
      - Follow site access and ESD precautions if accessing comms hardware

    tools_required:
      - Phone/laptop for hotspot testing (if permitted)
      - Access to APN details / backend requirements
      - SIM tool / spare SIM (optional)

    decision_tree:
      start_node: C0
      nodes:
        C0:
          prompt: >
            *Backend / OCPP offline*
            Confirm the charger is offline and proceed through basic recovery steps first.
          options:
            - label: "Continue"
              next: C1

        C1:
          prompt: >
            *Reboot charger*
            Reboot and allow sufficient time for modem registration and OCPP handshake.
          options:
            - label: "Online"
              next: MONITOR
            - label: "Still offline"
              next: C2

        C2:
          prompt: >
            *Basic checks exhausted*
            If reboot doesnâ€™t restore comms, escalate or proceed with advanced checks (SIM/APN/network/DNS/time).
          options:
            - label: "ðŸ“ˆ Escalate (standard)"
              next: ESCALATE_AUTEL
            - label: "ðŸ§  Deep dive â€” advanced checks"
              next: ADVANCED_SIM_NETWORK

        ADVANCED_SIM_NETWORK:
          prompt: |
            ðŸ§  *Deep Dive â€” SIM / Network / OCPP*
            Advanced causes to check:
            â€¢ SIM registered on GSM only (no packet data)
            â€¢ Incorrect APN
            â€¢ Carrier outage or throttling
            â€¢ Private IP blocked by backend firewall
            â€¢ DNS or time sync issues
          options:
            - label: "Issue fixed"
              next: C1
            - label: "No issue found"
              next: ESCALATE_AUTEL

        ESCALATE_AUTEL:
          prompt: >
            *Escalate backend / OCPP*
            Escalate with: last known online time, signal strength (if available),
            SIM/APN checks, and any logged comms errors.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: >
            *Monitor*
            Confirm stable backend connection and monitor for dropouts.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_overtemp_cooling_fault
    platform: autel
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Autel DC)"
    severity: high
    tags: [cooling, overtemp, fans, filters]

    description: >
      Overtemperature indicates the charger is exceeding thermal limits or has detected inadequate cooling.
      This is commonly caused by blocked airflow (dirty filters), failed fans, poor ventilation, or high ambient temperature.

    likely_causes:
      - Dirty or blocked air filters / intake vents
      - Failed or obstructed fans
      - Poor ventilation around cabinet (recirculation)
      - High ambient temperature / direct sun load

    safety_notes:
      - Some checks can be performed externally (filters/airflow) before opening cabinet
      - Follow site safety and LOTO requirements for any internal inspection

    tools_required:
      - Basic hand tools for filter access panels (if required)
      - Torch / inspection light
      - IR thermometer (optional)

    decision_tree:
      start_node: T0
      nodes:
        T0:
          prompt: >
            *Overtemperature detected*
            Start with airflow checks and filter condition. This is the most common field cause.
          options:
            - label: "Check airflow"
              next: T1

        T1:
          prompt: >
            *Filters dirty?*
            Inspect filters and intake vents for blockage.
          options:
            - label: "Yes"
              next: FIX_FILTERS
            - label: "No"
              next: ESCALATE_AUTEL

        FIX_FILTERS:
          prompt: >
            *Clean filters*
            Clean/replace filters as per site maintenance standard, then re-test under load.
          options:
            - label: "Re-test"
              next: MONITOR

        ESCALATE_AUTEL:
          prompt: >
            *Escalate thermal fault*
            Escalate with ambient conditions, fan operation observations, and any temperature readings/logs.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: >
            *Monitor*
            Run a test session and confirm temperatures stabilise within normal range.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_power_module_fault
    platform: autel
    charger_type: dc
    title: "Power Module Fault / Module Offline (Autel DC)"
    severity: high
    tags: [power_module, rectifier, dc_bus, comms, cooling]

    description: >
      A power module is offline or reporting a fault. This is often caused by a loose module seating,
      internal comms faults, cooling issues, or a failed module. Start with reseating and basic verification.

    likely_causes:
      - Module not seated correctly / loose connections
      - Internal comms fault between modules and controller
      - Cooling issue causing module to trip
      - Failed power module requiring replacement

    safety_notes:
      - Follow LOTO and discharge wait times before accessing module bays
      - Modules may retain charge; confirm safe state before handling

    tools_required:
      - Basic hand tools for access panels
      - Inspection light
      - Multimeter (for verification as needed)

    decision_tree:
      start_node: P0
      nodes:
        P0:
          prompt: >
            *Power module offline*
            Reseat the affected module to rule out poor seating or connection.
          options:
            - label: "Reseat module"
              next: P1

        P1:
          prompt: >
            *Re-test*
            Re-test after reseating and confirm whether the module returns online.
          options:
            - label: "Resolved"
              next: MONITOR
            - label: "Still offline"
              next: ESCALATE_AUTEL

        ESCALATE_AUTEL:
          prompt: >
            *Escalate power module*
            Escalate with module ID/slot position, any LEDs/error codes, and actions performed.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: >
            *Monitor*
            Run a test session and confirm stable operation across all modules.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__
