# autel.yml
# EVBot Fault Pack: Autel (On-site Technician v1) â€” Descriptive + Tuned (nodes-based)
# Notes:
# - Node-based decision tree: start_node + nodes map
# - Each node has: prompt, options -> next
# - image: autel/<filename_without_extension> (expects files in assets/images/autel/*.png)

faults:

  - id: autel_ac_contactor_fault
    platform: autel
    charger_type: dc
    title: "AC Contactor Fault (Autel DC)"
    aliases:
      - "AC Contactor Fault"
      - "AC contactor error"
      - "input contactor fault"
      - "main contactor fault"
      - "contactor open feedback"
      - "contactor feedback error"

    triggers:
      any_text_contains:
        - "ac contactor"
        - "contactor fault"
        - "contactor feedback"
        - "input contactor"
        - "main contactor"

    severity: high
    tags: [power, input, contactor, interlock, feedback, three_phase]

    description: >
      The charger cannot close or verify the main AC input contactor.
      Most commonly caused by missing/unstable 3-phase supply, undervoltage on the control PSU,
      an open interlock, coil/aux wiring issues, or a failed contactor.

    likely_causes:
      - Missing phase / supply imbalance or sag during pull-in
      - Low control PSU voltage / undervoltage
      - Interlock open (door, E-stop chain, safety loop)
      - Coil wiring / auxiliary feedback wiring loose or damaged
      - Failed contactor (coil/mechanism/contacts)

    safety_notes:
      - LOTO before opening cabinet; wait minimum 5 minutes for DC bus discharge
      - Verify absence of voltage with an approved meter before touching conductors

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated hand tools

    response:
      telegram_markdown: |
        *Autel DC â€” AC Contactor Fault*
        The charger cannot close or verify the main AC input contactor.

        Most common causes:
        â€¢ Missing phase / imbalance
        â€¢ Low control PSU voltage
        â€¢ Aux feedback or coil wiring fault
        â€¢ Interlock open
        â€¢ Failed contactor

    decision_tree:
      start_node: A0
      nodes:
        A0:
          prompt: |
            *AC Contactor Fault â€” Start*
            Is the fault active right now, or only intermittent?
          options:
            - label: "Fault active"
              next: A1
            - label: "Intermittent"
              next: A2

        A1:
          prompt: |
            *Check site supply*
            Confirm 3-phase is present and stable (no missing phase/major imbalance).
          options:
            - label: "Supply OK"
              next: A3
            - label: "Missing phase"
              next: FIX_SUPPLY

        A2:
          prompt: |
            *Intermittent pattern*
            Treat this like a supply/connection/PSU sag issue until proven otherwise. Continue through checks.
          options:
            - label: "Continue"
              next: A1

        A3:
          prompt: |
            *Power cycle & check pull-in*
            Power cycle and listen/observe: does the AC contactor pull in cleanly?
          image: autel/ac_contactor_location
          options:
            - label: "Cleared"
              next: MONITOR
            - label: "No pull-in"
              next: A4
            - label: "Chatter"
              next: A5
            - label: "Clunks but fault remains"
              next: A6

        A4:
          prompt: |
            *No pull-in*
            Work out whether itâ€™s being *blocked* (interlock), *not commanded* (no coil voltage),
            or *failed* (coil voltage present but no pull-in).
          image: autel/interlock_chain_points
          options:
            - label: "Interlock open"
              next: FIX_INTERLOCK
            - label: "No coil voltage"
              next: A7
            - label: "Voltage present"
              next: REPLACE_CONTACTOR

        A5:
          prompt: |
            *Chatter / weak pull-in*
            Usually undervoltage (supply sag / weak control PSU) or a failing contactor.
          image: autel/control_psu_location
          options:
            - label: "Voltage sag"
              next: FIX_PSU_OR_SUPPLY
            - label: "Voltage OK"
              next: REPLACE_CONTACTOR

        A6:
          prompt: |
            *Clunks but fault remains*
            Contactor may be moving, but the system canâ€™t verify it. Focus on aux feedback circuit.
          image: autel/aux_feedback_terminals
          options:
            - label: "Feedback fault"
              next: FIX_AUX_FEEDBACK
            - label: "Feedback OK"
              next: A8

        A7:
          prompt: |
            *No coil command*
            No coil voltage typically points to PSU undervoltage, an open interlock, wiring break, or controller output issue.
          image: autel/control_psu_location
          options:
            - label: "PSU / undervoltage"
              next: FIX_PSU_OR_SUPPLY
            - label: "Interlock"
              next: FIX_INTERLOCK
            - label: "Wiring"
              next: FIX_WIRING
            - label: "Controller"
              next: ESCALATE_AUTEL

        A8:
          prompt: |
            *Firmware / config check*
            If supply/pull-in/feedback look OK but it still faults, check firmware/config/logs then escalate if needed.
          options:
            - label: "Resolved"
              next: MONITOR
            - label: "Still faulting"
              next: ESCALATE_AUTEL

        FIX_SUPPLY:
          prompt: |
            *Fix supply issue*
            Restore correct 3-phase supply (phase present, within spec, balanced). Then re-test.
          options:
            - label: "Re-test"
              next: A3

        FIX_INTERLOCK:
          prompt: |
            *Fix interlock*
            Identify which interlock is open (door, E-stop chain, safety loop) and restore continuity. Then re-test.
          image: autel/interlock_chain_points
          options:
            - label: "Re-test"
              next: A3

        FIX_AUX_FEEDBACK:
          prompt: |
            *Fix aux feedback*
            Repair/secure aux feedback wiring and confirm state change during pull-in/pull-out. Then re-test.
          image: autel/aux_feedback_terminals
          options:
            - label: "Re-test"
              next: A3

        FIX_PSU_OR_SUPPLY:
          prompt: |
            *Fix PSU / undervoltage*
            Address control PSU undervoltage or supply sag during pull-in (connections, PSU health, upstream quality). Then re-test.
          image: autel/control_psu_location
          options:
            - label: "Re-test"
              next: A3

        FIX_WIRING:
          prompt: |
            *Fix wiring*
            Repair/secure coil wiring and related harnessing (loose terminals, damaged conductors, heat issues). Then re-test.
          options:
            - label: "Re-test"
              next: A3

        REPLACE_CONTACTOR:
          prompt: |
            *Replace AC contactor*
            Coil voltage present but no reliable pull-in = likely failed contactor. Replace and function test.
          image: autel/ac_contactor_location
          options:
            - label: "Re-test"
              next: A3

        ESCALATE_AUTEL:
          prompt: |
            *Escalate to Autel*
            Include: site voltages, coil command findings, interlock status, feedback checks, and timestamps/logs.
          options:
            - label: "Back to start"
              next: A0

        MONITOR:
          prompt: |
            *Monitor*
            Run a test session and monitor for recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_dc_contactor_fault
    platform: autel
    charger_type: dc
    title: "DC Contactor Fault / Failed to Close (Autel DC)"
    severity: high
    tags: [dc, contactor, output, hv, safety]

    description: >
      The charger is unable to close or verify the DC output contactor.
      Most causes are interlock inhibits, missing coil command, undervoltage/PSU issues,
      wiring faults, auxiliary feedback issues, or a failed/welded contactor.

    likely_causes:
      - Interlock preventing closure
      - No coil command from controller
      - Coil wiring/terminals loose or damaged
      - PSU undervoltage or voltage sag at pull-in
      - Failed or welded DC contactor / feedback fault

    safety_notes:
      - LOTO before cabinet access; wait minimum 5 minutes for DC bus discharge
      - Verify safe state before touching DC contactor/DC bus components

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated hand tools

    decision_tree:
      start_node: D0
      nodes:
        D0:
          prompt: |
            *DC Contactor Fault â€” Start*
            Is the fault active right now, or intermittent?
          options:
            - label: "Fault active"
              next: D1
            - label: "Intermittent"
              next: D2

        D1:
          prompt: |
            *Power cycle and observe*
            Power cycle and observe contactor behaviour (close attempt, pull-in, and whether the fault clears).
          image: autel/dc_contactor_location
          options:
            - label: "Cleared"
              next: MONITOR
            - label: "No pull-in"
              next: D3
            - label: "Closes but faults"
              next: D6

        D2:
          prompt: |
            *Intermittent behaviour*
            Intermittent faults are often loose wiring, thermal movement, or PSU/supply sag. Continue through checks.
          options:
            - label: "Continue"
              next: D1

        D3:
          prompt: |
            *Check coil voltage*
            Measure whether coil voltage is present during the close command.
            This tells you if itâ€™s a command/inhibit issue vs contactor/mechanical failure.
          image: autel/dc_contactor_location
          options:
            - label: "No voltage"
              next: D4
            - label: "Voltage present"
              next: REPLACE_CONTACTOR
            - label: "Voltage sags"
              next: FIX_PSU

        D4:
          prompt: |
            *No coil command*
            No coil voltage typically points to an interlock inhibit, wiring issue, or controller output fault.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock"
              next: FIX_INTERLOCK
            - label: "Wiring"
              next: FIX_WIRING
            - label: "Controller"
              next: ESCALATE_AUTEL

        D6:
          prompt: |
            *Aux feedback / verification*
            If it closes but faults, check auxiliary feedback circuit or welded contactor condition.
          image: autel/aux_feedback_terminals
          options:
            - label: "Feedback fault"
              next: FIX_AUX_FEEDBACK
            - label: "Welded"
              next: REPLACE_CONTACTOR

        FIX_PSU:
          prompt: |
            *Fix PSU / undervoltage*
            Address control power stability and confirm voltage holds during pull-in. Then re-test.
          image: autel/control_psu_location
          options:
            - label: "Re-test"
              next: D1

        FIX_INTERLOCK:
          prompt: |
            *Fix interlock*
            Identify the open interlock (door, E-stop chain, safety loop) and restore continuity. Then re-test.
          image: autel/interlock_chain_points
          options:
            - label: "Re-test"
              next: D1

        FIX_WIRING:
          prompt: |
            *Fix wiring*
            Repair/secure coil wiring and harness connections (loose terminals, heat damage). Then re-test.
          options:
            - label: "Re-test"
              next: D1

        FIX_AUX_FEEDBACK:
          prompt: |
            *Fix aux feedback*
            Repair/secure auxiliary feedback wiring and confirm state change. Then re-test.
          image: autel/aux_feedback_terminals
          options:
            - label: "Re-test"
              next: D1

        REPLACE_CONTACTOR:
          prompt: |
            *Replace DC contactor*
            Coil voltage present but unreliable/no operation = likely failed/welded contactor. Replace and function test.
          image: autel/dc_contactor_location
          options:
            - label: "Re-test"
              next: D1

        ESCALATE_AUTEL:
          prompt: |
            *Escalate to Autel*
            Include: coil voltage findings, interlock status, wiring checks performed, and timestamps/logs.
          options:
            - label: "Back"
              next: D0

        MONITOR:
          prompt: |
            *Monitor*
            Run a test session and monitor for recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_backend_ocpp_comms_fault
    platform: autel
    charger_type: dc
    title: "Backend / OCPP Communication Fault (Autel DC)"
    severity: high
    tags: [ocpp, backend, comms, modem, sim, network]

    description: >
      The charger is offline to the backend (OCPP). Start with a reboot/power cycle to recover modem registration.
      If basic recovery fails, investigate SIM/APN, carrier/signal issues, DNS/time sync, and backend firewall/whitelisting.

    likely_causes:
      - SIM not registered on packet data / provisioning issue
      - Incorrect APN settings
      - Carrier outage/throttling or poor signal/antenna issue
      - DNS or time sync issues affecting TLS/OCPP handshake
      - Backend firewall/whitelist blocking private IP ranges

    safety_notes:
      - Most checks are low risk and can be done without entering HV compartments
      - Follow ESD precautions if accessing comms hardware

    tools_required:
      - Phone/laptop for hotspot testing (if permitted)
      - Access to APN/back-end requirements
      - Known-good SIM (optional)

    decision_tree:
      start_node: C0
      nodes:
        C0:
          prompt: |
            *Backend / OCPP offline*
            Confirm offline state and proceed with recovery steps.
          options:
            - label: "Continue"
              next: C1

        C1:
          prompt: |
            *Reboot charger*
            Reboot and allow time for modem registration and OCPP handshake.
          options:
            - label: "Online"
              next: MONITOR
            - label: "Still offline"
              next: C2

        C2:
          prompt: |
            *Next step*
            If reboot did not restore comms, either escalate or perform advanced SIM/network checks.
          options:
            - label: "ðŸ“ˆ Escalate (standard)"
              next: ESCALATE_AUTEL
            - label: "ðŸ§  Deep dive â€” advanced checks"
              next: ADVANCED_SIM_NETWORK

        ADVANCED_SIM_NETWORK:
          prompt: |
            ðŸ§  *Deep Dive â€” SIM / Network / OCPP*
            Check these advanced causes:
            â€¢ SIM registered on GSM only (no packet data)
            â€¢ Incorrect APN
            â€¢ Carrier outage or throttling
            â€¢ Private IP blocked by backend firewall
            â€¢ DNS or time sync issues
          options:
            - label: "Issue fixed"
              next: C1
            - label: "No issue found"
              next: ESCALATE_AUTEL

        ESCALATE_AUTEL:
          prompt: |
            *Escalate backend / OCPP*
            Include: last known online time, signal strength (if available),
            SIM/APN checks, and any comms errors/log timestamps.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: |
            *Monitor*
            Confirm stable backend connection and monitor for dropouts.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_overtemp_cooling_fault
    platform: autel
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Autel DC)"
    severity: high
    tags: [cooling, overtemp, fans, filters]

    description: >
      Overtemperature indicates the charger is exceeding thermal limits or has detected inadequate cooling.
      Most common field cause is blocked airflow (dirty filters/vents). Fan faults or poor ventilation can also trigger it.

    likely_causes:
      - Dirty/blocked filters or intake vents
      - Fan failure or obstruction
      - Poor cabinet ventilation / recirculation
      - High ambient temperature / direct sun load

    safety_notes:
      - Start with external airflow/filter checks where possible
      - Follow LOTO requirements for internal fan inspection

    tools_required:
      - Torch / inspection light
      - Basic hand tools for filter access (if required)
      - IR thermometer (optional)

    decision_tree:
      start_node: T0
      nodes:
        T0:
          prompt: |
            *Overtemperature detected*
            Start with airflow checks and filter condition.
          image: autel/cooling_filters_location
          options:
            - label: "Check airflow"
              next: T1

        T1:
          prompt: |
            *Filters dirty?*
            Inspect filters/vents for blockage.
          image: autel/cooling_filters_location
          options:
            - label: "Yes"
              next: FIX_FILTERS
            - label: "No"
              next: T2

        T2:
          prompt: |
            *Check cooling fans*
            Confirm fans run freely, no obstructions, and airflow direction is correct.
          image: autel/cooling_fan_location
          options:
            - label: "Fans OK"
              next: MONITOR
            - label: "Fan not running / blocked"
              next: FIX_FANS

        FIX_FILTERS:
          prompt: |
            *Clean filters*
            Clean/replace filters, then re-test under load.
          image: autel/cooling_filters_location
          options:
            - label: "Re-test"
              next: T2

        FIX_FANS:
          prompt: |
            *Fix fan issue*
            Clear obstruction, check fan power/connector, replace fan if failed. Then re-test.
          image: autel/cooling_fan_location
          options:
            - label: "Re-test"
              next: MONITOR

        ESCALATE_AUTEL:
          prompt: |
            *Escalate thermal fault*
            Include: ambient conditions, fan operation observations, filter condition, and any temp/log readings.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: |
            *Monitor*
            Run a test session and monitor for recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  - id: autel_power_module_fault
    platform: autel
    charger_type: dc
    title: "Power Module Fault / Module Offline (Autel DC)"
    severity: high
    tags: [power_module, rectifier, dc_bus, comms, cooling]

    description: >
      A power module is offline or reporting a module fault. Start with reseating to rule out poor seating or connection.
      If it remains offline, suspect module failure, cooling trip, or controller/comms issue.

    likely_causes:
      - Module not seated correctly / loose connections
      - Internal comms issue between module and controller
      - Cooling-related trip (fan/airflow/filter)
      - Failed power module

    safety_notes:
      - LOTO before access; wait minimum 5 minutes for DC bus discharge
      - Verify safe state before handling modules

    tools_required:
      - Torch / inspection light
      - Basic hand tools for access
      - Multimeter (as needed)

    decision_tree:
      start_node: P0
      nodes:
        P0:
          prompt: |
            *Power module offline*
            Reseat the affected module to rule out poor seating/connection.
          options:
            - label: "Reseat module"
              next: P1

        P1:
          prompt: |
            *Re-test*
            Confirm whether the module returns online after reseat.
          options:
            - label: "Resolved"
              next: MONITOR
            - label: "Still offline"
              next: P2

        P2:
          prompt: |
            *Check cooling basics*
            If modules are tripping offline, confirm airflow/filters and fans are OK.
          image: autel/cooling_filters_location
          options:
            - label: "Filters / airflow OK"
              next: ESCALATE_AUTEL
            - label: "Filters dirty"
              next: FIX_FILTERS
            - label: "Check fans"
              next: CHECK_FANS

        CHECK_FANS:
          prompt: |
            *Check cooling fans*
            Confirm fans are operating and unobstructed.
          image: autel/cooling_fan_location
          options:
            - label: "Fans OK"
              next: ESCALATE_AUTEL
            - label: "Fan issue"
              next: FIX_FANS

        FIX_FILTERS:
          prompt: |
            *Clean filters*
            Clean/replace filters then re-test module stability under load.
          image: autel/cooling_filters_location
          options:
            - label: "Re-test"
              next: P1

        FIX_FANS:
          prompt: |
            *Fix fan issue*
            Clear obstruction, check connectors, replace fan if failed. Then re-test.
          image: autel/cooling_fan_location
          options:
            - label: "Re-test"
              next: P1

        ESCALATE_AUTEL:
          prompt: |
            *Escalate power module*
            Include: module ID/slot, any LEDs/error codes, actions taken (reseat), cooling status, and timestamps/logs.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        MONITOR:
          prompt: |
            *Monitor*
            Run a test session and confirm stable module operation.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__
