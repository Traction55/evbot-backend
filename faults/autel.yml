# autel.yml
# EVBot Fault Pack: Autel (On-site Technician v1) ‚Äî Kempower-style (symptom-first, gated, canonical clusters)
#
# Philosophy:
# - 1‚Äì2 gold-standard clusters do the heavy lifting (consistent gates + evidence pack + outcomes)
# - Individual ‚Äúfault‚Äù entries can stay stable for deep-links but must NOT bounce the tech back to menus
# - Symptom-first > code-first. Codes route you into the same canonical path.
#
# Notes:
# - Node-based decision tree: start_node + nodes map
# - node.options MUST be a LIST of {label, next}
# - image: autel/<filename_without_extension> (expects files in assets/images/autel/*.png)

faults:

  # ============================================================
  # (1) GOLD STANDARD CLUSTER: Autel HV Enable / Power-Stage Start Sequence
  # Canonical flow for:
  # - Start inhibited / start failed
  # - Precharge / DC bus not building
  # - DC output contactor cannot close / verify
  # - AC input contactor issues that affect HV enable
  # - ‚ÄúClicks then faults‚Äù
  # ============================================================

  - id: autel_power_stage_cluster
    platform: autel
    charger_type: dc
    title: "HV Enable / Power-Stage Start Inhibit (Precharge / DC Bus / Contactors)"
    severity: critical
    tags: [power_stage, hv_enable, precharge, dc_bus, contactor, interlock, insulation, start_inhibit]

    aliases:
      - "Power-stage fault"
      - "HV start inhibited"
      - "HV enable fault"
      - "start failed"
      - "precharge fault"
      - "pre-charge fault"
      - "dc bus fault"
      - "dc bus not ready"
      - "dc bus undervoltage"
      - "dc bus overvoltage"
      - "output contactor fault"
      - "dc contactor failed"
      - "failed to close contactor"
      - "ac contactor fault"
      - "input contactor fault"
      - "internal power fault"

    triggers:
      any_text_contains:
        - "power-stage"
        - "power stage"
        - "hv enable"
        - "hv start"
        - "start inhibited"
        - "start failed"
        - "precharge"
        - "pre-charge"
        - "dc bus"
        - "bus undervoltage"
        - "bus overvoltage"
        - "output contactor"
        - "dc contactor"
        - "failed to close"
        - "contactor failed"
        - "verify failed"
        - "welded contactor"
        - "ac contactor"
        - "input contactor"
        - "interlock open"
        - "door interlock"
        - "hvil"
        - "e-stop"
        - "estop"
        - "insulation"
        - "isolation"
        - "imd"

    description: >
      The charger is preventing HV start or cannot complete the HV start sequence (enable ‚Üí precharge ‚Üí DC bus build ‚Üí
      contactor verification). The fastest wins come from gating: safety/visual ‚Üí supply sanity ‚Üí interlock/HVIL ‚Üí IMD/isolation.
      Only after gates are cleared do you chase contactors/DC bus. Capture the ‚Äúfirst fault that returns‚Äù after a clean reboot.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - Treat insulation/isolation alarms as high risk; avoid repeated start attempts
      - Do not bypass HVIL/interlocks; do not repeatedly reset trips

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated hand tools
      - Torch / inspection light
      - IR thermometer (optional)

    decision_tree:
      start_node: PS0
      nodes:

        PS0:
          prompt: |
            ‚ö° *Autel ‚Äî HV Enable / Power-Stage Start Inhibit*
            Start with what you‚Äôre seeing (symptom-first). Pick the closest:
          options:
            - label: "üö´ Won‚Äôt start / fails immediately"
              next: PS_PATTERN_START_FAIL
            - label: "‚ö†Ô∏è Clicks/tries then faults quickly"
              next: PS_PATTERN_CLICKS
            - label: "üü™ Insulation / Isolation / IMD alarm present"
              next: PS_ISO_GATE
            - label: "‚¨õ Interlock / HVIL / E-stop indicated"
              next: PS_INTERLOCK_GATE
            - label: "üîå Supply unstable / undervoltage / phase issue suspected"
              next: PS_SUPPLY_GATE
            - label: "üîé I have a specific message (precharge/DC bus/contactor)"
              next: PS_CODE_ROUTER

        PS_PATTERN_START_FAIL:
          prompt: |
            *Pattern check ‚Äî Start fails*
            Do you see an explicit block reason on HMI/logs?
          options:
            - label: "üü™ Isolation/IMD"
              next: PS_ISO_GATE
            - label: "‚¨õ Interlock/HVIL/E-stop"
              next: PS_INTERLOCK_GATE
            - label: "üü• Contactor / Precharge / DC bus"
              next: PS_SAFE_REBOOT
            - label: "No obvious reason shown"
              next: PS_SAFE_REBOOT

        PS_PATTERN_CLICKS:
          prompt: |
            *Pattern check ‚Äî Clicks then faults*
            Most often: supply sag at enable, interlock gating, or contactor/DC bus verification.
            Proceed with safe-first recovery to identify the *first fault that returns*.
          options:
            - label: "Continue ‚û°Ô∏è"
              next: PS_SAFE_REBOOT

        PS_CODE_ROUTER:
          prompt: |
            *Quick routing (choose closest)*
          options:
            - label: "üü• DC/Output contactor failed / failed to close / verify"
              next: PS_SAFE_REBOOT
            - label: "üü¶ Precharge fault / DC bus not ready / undervoltage"
              next: PS_SAFE_REBOOT
            - label: "üüß DC bus overvoltage"
              next: PS_DC_BUS_OV
            - label: "üü™ Insulation / isolation / IMD"
              next: PS_ISO_GATE
            - label: "‚¨õ Interlock / HVIL / E-stop"
              next: PS_INTERLOCK_GATE
            - label: "‚ùì Not sure"
              next: PS_SAFE_REBOOT

        PS_SAFE_REBOOT:
          prompt: |
            ‚úÖ *Safe recovery first (do this once, cleanly)*
            1) Confirm: no smoke/heat/water ingress
            2) Controlled reboot or full power cycle
            3) Note the *first* fault/message that returns (root clue)
          options:
            - label: "Recovered ‚úÖ"
              next: PS_DONE_RESOLVED
            - label: "Still failing"
              next: PS_VISUAL

        PS_VISUAL:
          prompt: |
            üëÄ *Visual checks (non-invasive)*
            - Burnt smell / discoloration / melted insulation?
            - Water ingress / wet marks?
            - Harness strain / loose external connectors?
          options:
            - label: "üî• Unsafe condition found"
              next: PS_ESC_UNSAFE
            - label: "Looks OK"
              next: PS_SUPPLY_GATE

        PS_SUPPLY_GATE:
          prompt: |
            ‚ö° *Supply sanity check*
            Any upstream trip, undervoltage/phase loss alarm, or known site instability?
          options:
            - label: "Yes ‚Äî supply issue suspected"
              next: PS_SUPPLY_ACTIONS
            - label: "No / unknown"
              next: PS_INTERLOCK_GATE

        PS_SUPPLY_ACTIONS:
          prompt: |
            *Supply actions (safe-first)*
            - Check upstream breaker/isolator
            - If authorised: confirm L-L voltages present and not sagging badly at enable
            - Stabilise supply before deeper charger work
          options:
            - label: "Supply corrected ‚Üí retry"
              next: PS_SAFE_REBOOT
            - label: "Supply seems OK ‚Üí continue"
              next: PS_INTERLOCK_GATE
            - label: "Can‚Äôt verify ‚Üí evidence + escalate"
              next: PS_LOGS

        PS_INTERLOCK_GATE:
          prompt: |
            ‚¨õ *Interlock / HVIL gate*
            If any interlock is open, HV start will be inhibited. Clear this before chasing power-stage parts.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock cleared ‚Üí retry"
              next: PS_SAFE_REBOOT
            - label: "Interlock won‚Äôt clear"
              next: PS_LOGS

        PS_ISO_GATE:
          prompt: |
            üü™ *Isolation / IMD gate (high risk)*
            Treat as safety critical:
            - Avoid repeated start attempts
            - Inspect connector face + cabinet for moisture/contamination/burn marks
          options:
            - label: "Continue ‚û°Ô∏è"
              next: PS_ISO_ACTIONS

        PS_ISO_ACTIONS:
          prompt: |
            *Isolation actions*
            - Record exact IMD/isolation message + timestamp
            - Inspect connector face (water/debris/burn marks)
            - If repeatable across EVs/ports: tag out affected port and escalate
          options:
            - label: "Evidence pack ‚Üí escalate"
              next: PS_LOGS
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        PS_DC_BUS_OV:
          prompt: |
            üüß *DC bus overvoltage*
            Do NOT repeatedly retry. Capture evidence and escalate.
          options:
            - label: "Evidence pack ‚Üí escalate"
              next: PS_LOGS
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        PS_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack (fast escalation)*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Any supply alarms / measured L-L voltages (if taken)
            - Interlock/HVIL status
            - IMD/isolation status (if shown)
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: PS_ESC
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        PS_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise.
            Provide photos + what you observed (smell/heat/water ingress).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        PS_ESC:
          prompt: |
            *Escalate ‚Äî Autel HV Enable / Power-Stage Start Inhibit*
            Include:
            - Exact code/text + timestamps
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL/IMD status
            - Actions taken (reboot/power cycle)
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        PS_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            HV start restored. Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (2) UX-FIXED ROUTED ENTRY: AC Contactor Fault (ID stable; no menu bounce)
  # ============================================================

  - id: autel_ac_contactor_fault
    platform: autel
    charger_type: dc
    title: "AC Contactor Fault (Autel DC)"
    severity: high
    tags: [power, input, contactor, hv_enable, start_inhibit, interlock, supply]

    aliases:
      - "AC Contactor Fault"
      - "AC contactor error"
      - "input contactor fault"
      - "main contactor fault"
      - "contactor open feedback"
      - "contactor feedback error"
      - "input relay fault"
      - "mains contactor fault"

    triggers:
      any_text_contains:
        - "ac contactor"
        - "input contactor"
        - "main contactor"
        - "contactor feedback"
        - "open feedback"
        - "mains contactor"
        - "input relay"

    description: >
      AC contactor alarms are usually part of the HV enable/start sequence (supply stability + interlocks/HVIL + control power).
      This entry embeds the canonical gates so the tech never has to back out to a different menu item.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - Do not bypass interlocks/HVIL

    decision_tree:
      start_node: AC0
      nodes:

        AC0:
          prompt: |
            ‚ö° *Autel ‚Äî AC Contactor Fault (Field Flow)*
            Start symptom-first. What are you seeing?
          options:
            - label: "üö´ Won‚Äôt start / fails immediately"
              next: AC_PATTERN_FAIL
            - label: "‚ö†Ô∏è Clicks/tries then faults"
              next: AC_REBOOT
            - label: "‚¨õ Interlock/HVIL/E-stop indicated"
              next: AC_INTERLOCK
            - label: "üîå Supply issue suspected (undervoltage/phase)"
              next: AC_SUPPLY
            - label: "üü™ IMD/Isolation alarm appears"
              next: AC_IMD
            - label: "üîé Not sure"
              next: AC_REBOOT

        AC_PATTERN_FAIL:
          prompt: |
            *Pattern ‚Äî Start fails*
            Do you see any explicit block reason?
          options:
            - label: "Interlock/HVIL/E-stop"
              next: AC_INTERLOCK
            - label: "Supply/undervoltage/phase"
              next: AC_SUPPLY
            - label: "No clear reason"
              next: AC_REBOOT

        AC_REBOOT:
          prompt: |
            ‚úÖ *Clean recovery step*
            Do a controlled reboot/power cycle ONCE.
            Then note the *first* fault that returns.
          options:
            - label: "Recovered ‚úÖ"
              next: AC_DONE
            - label: "Still faulting"
              next: AC_VISUAL

        AC_VISUAL:
          prompt: |
            üëÄ *Visual check (non-invasive)*
            - Burnt smell/heat/discoloration?
            - Water ingress/wet marks?
            - Harness strain/loose external connectors?
          options:
            - label: "üî• Unsafe condition"
              next: AC_ESC_UNSAFE
            - label: "Looks OK"
              next: AC_SUPPLY

        AC_SUPPLY:
          prompt: |
            ‚ö° *Supply gate*
            Check upstream isolator/CB. If authorised: confirm L-L voltages present and not sagging badly at enable.
          options:
            - label: "Supply corrected ‚Üí retry"
              next: AC_REBOOT
            - label: "Supply OK / not the issue"
              next: AC_INTERLOCK
            - label: "Can‚Äôt verify"
              next: AC_EVIDENCE

        AC_INTERLOCK:
          prompt: |
            ‚¨õ *Interlock / HVIL gate*
            If any interlock is open, AC contactor/HV enable can be inhibited.
            Clear interlocks before chasing parts.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock cleared ‚Üí retry"
              next: AC_REBOOT
            - label: "Interlock won‚Äôt clear"
              next: AC_EVIDENCE

        AC_IMD:
          prompt: |
            üü™ *IMD/Isolation appeared*
            Treat as safety critical. Avoid repeated attempts.
            Inspect connector face + cabinet for moisture/contamination/burn marks.
          options:
            - label: "Evidence pack"
              next: AC_EVIDENCE
            - label: "Back to Autel menu"
              next: __MENU_AUTEL__

        AC_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack (fast escalation)*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL status
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: AC_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AC_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise. Provide photos + what you observed.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AC_ESC:
          prompt: |
            *Escalate ‚Äî AC Contactor Fault*
            Include evidence pack + any supply/interlock findings.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        AC_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (3) UX-FIXED ROUTED ENTRY: DC Contactor Fault (ID stable; no menu bounce)
  # ============================================================

  - id: autel_dc_contactor_fault
    platform: autel
    charger_type: dc
    title: "DC Contactor Fault / Failed to Close (Autel DC)"
    severity: high
    tags: [dc, contactor, hv_enable, start_inhibit, interlock, supply, precharge]

    aliases:
      - "DC Contactor Fault"
      - "output contactor fault"
      - "failed to close"
      - "contactor verify failed"
      - "verify failed"
      - "welded contactor"

    triggers:
      any_text_contains:
        - "dc contactor"
        - "output contactor"
        - "failed to close"
        - "verify failed"
        - "welded contactor"

    description: >
      DC contactor faults are typically part of the HV enable/start sequence (precharge/DC bus/verification).
      This entry embeds the canonical gates so the tech stays in one flow.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - If IMD/isolation appears, stop repeated attempts and escalate

    decision_tree:
      start_node: DC0
      nodes:

        DC0:
          prompt: |
            üü• *Autel ‚Äî DC Contactor Failed to Close (Field Flow)*
            Start symptom-first. What are you seeing?
          options:
            - label: "üö´ Start fails immediately"
              next: DC_REBOOT
            - label: "‚ö†Ô∏è Clicks then faults"
              next: DC_REBOOT
            - label: "‚¨õ Interlock/HVIL/E-stop indicated"
              next: DC_INTERLOCK
            - label: "üîå Supply issue suspected"
              next: DC_SUPPLY
            - label: "üü™ IMD/Isolation alarm appears"
              next: DC_IMD
            - label: "üîé Not sure"
              next: DC_REBOOT

        DC_REBOOT:
          prompt: |
            ‚úÖ *Clean recovery step*
            Controlled reboot/power cycle ONCE.
            Note the *first* fault that returns.
          options:
            - label: "Recovered ‚úÖ"
              next: DC_DONE
            - label: "Still faulting"
              next: DC_VISUAL

        DC_VISUAL:
          prompt: |
            üëÄ *Visual check (non-invasive)*
            - Burnt smell/heat/discoloration?
            - Water ingress/wet marks?
            - Harness strain/loose connectors?
          options:
            - label: "üî• Unsafe condition"
              next: DC_ESC_UNSAFE
            - label: "Looks OK"
              next: DC_SUPPLY

        DC_SUPPLY:
          prompt: |
            ‚ö° *Supply gate*
            Check upstream isolator/CB. If authorised: confirm L-L voltages present and stable at enable.
          options:
            - label: "Supply corrected ‚Üí retry"
              next: DC_REBOOT
            - label: "Supply OK / not the issue"
              next: DC_INTERLOCK
            - label: "Can‚Äôt verify"
              next: DC_EVIDENCE

        DC_INTERLOCK:
          prompt: |
            ‚¨õ *Interlock / HVIL gate*
            If any interlock is open, HV enable/precharge/contactors can be inhibited.
          image: autel/interlock_chain_points
          options:
            - label: "Interlock cleared ‚Üí retry"
              next: DC_REBOOT
            - label: "Interlock won‚Äôt clear"
              next: DC_EVIDENCE

        DC_IMD:
          prompt: |
            üü™ *IMD/Isolation appeared*
            Treat as safety critical. Avoid repeated attempts.
            Inspect connector face + cabinet for moisture/contamination/burn marks.
          options:
            - label: "Evidence pack"
              next: DC_EVIDENCE
            - label: "Autel menu"
              next: __MENU_AUTEL__

        DC_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack (fast escalation)*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL status
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: DC_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        DC_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise. Provide photos + what you observed.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        DC_ESC:
          prompt: |
            *Escalate ‚Äî DC Contactor Failed to Close*
            Include evidence pack + any supply/interlock findings.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        DC_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (4) Backend / OCPP Communication Fault
  # ============================================================

  - id: autel_backend_ocpp_comms_fault
    platform: autel
    charger_type: dc
    title: "Backend / OCPP Communication Fault (Autel DC)"
    severity: high
    tags: [ocpp, backend, comms, modem, sim, network]

    aliases:
      - "ocpp offline"
      - "backend offline"
      - "server offline"
      - "network offline"
      - "charger offline"

    triggers:
      any_text_contains:
        - "ocpp"
        - "backend offline"
        - "server offline"
        - "network offline"
        - "charger offline"

    description: >
      The charger is offline to the backend (OCPP). Highest success path: confirm scope ‚Üí controlled reboot ‚Üí
      check LTE/Ethernet indicators ‚Üí basic SIM/APN sanity ‚Üí evidence pack for backend/OEM.

    decision_tree:
      start_node: C0
      nodes:

        C0:
          prompt: |
            üåê *Backend / OCPP offline ‚Äî Start*
            Is the site generally online (other chargers OK)?
          options:
            - label: "Other chargers also offline / site issue likely"
              next: C_SITE
            - label: "Only this charger offline"
              next: C1
            - label: "Not sure"
              next: C1

        C_SITE:
          prompt: |
            *Site-wide comms issue likely*
            - Check upstream router/modem power
            - Check site WAN
            - Capture timestamps + site notes
          options:
            - label: "Controlled reboot after site checks"
              next: C1
            - label: "Evidence pack"
              next: C_EVIDENCE

        C1:
          prompt: |
            *Controlled reboot / power cycle*
            Reboot and allow time for modem registration and OCPP handshake.
          options:
            - label: "Recovered (online) ‚úÖ"
              next: C_DONE
            - label: "Still offline"
              next: C2

        C2:
          prompt: |
            *Quick link checks*
            What connection type is in use?
          options:
            - label: "üì∂ Cellular/LTE"
              next: C_LTE
            - label: "üîå Ethernet"
              next: C_ETH
            - label: "‚ùì Not sure"
              next: C_EVIDENCE

        C_LTE:
          prompt: |
            *LTE checks*
            - Check antenna seated and not damaged
            - Check signal indicator (if available)
            - If permitted: reseat SIM, confirm correct APN profile
          options:
            - label: "Retest after LTE checks"
              next: C1
            - label: "Evidence pack"
              next: C_EVIDENCE

        C_ETH:
          prompt: |
            *Ethernet checks*
            - Link lights present?
            - Reseat cable at charger and switch
            - Try alternate port/cable if permitted
          options:
            - label: "Retest after Ethernet checks"
              next: C1
            - label: "Evidence pack"
              next: C_EVIDENCE

        C_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack (backend/OEM)*
            Capture:
            - Offline message + timestamp
            - Connection type (LTE/Ethernet)
            - Signal strength / link lights (if known)
            - SIM/APN notes (if checked)
          options:
            - label: "Escalate"
              next: C_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        C_ESC:
          prompt: |
            *Escalate ‚Äî Backend/OCPP*
            Include: last known online time, timestamps, link type, and what was tried (reboot/cables/antenna/SIM/APN).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        C_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Confirm stable backend connection (no repeated dropouts).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (5) Overtemperature / Cooling Fault
  # ============================================================

  - id: autel_overtemp_cooling_fault
    platform: autel
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Autel DC)"
    severity: high
    tags: [cooling, overtemp, fans, filters]

    aliases:
      - "overtemp"
      - "over temperature"
      - "thermal fault"
      - "fan fault"
      - "cooling fault"

    triggers:
      any_text_contains:
        - "overtemp"
        - "over temperature"
        - "thermal fault"
        - "fan fault"
        - "cooling fault"
        - "overheat"

    description: >
      Overtemperature indicates thermal limits exceeded or inadequate cooling detected. Fastest wins are filters/airflow,
      fan operation, and site ventilation. Escalate with evidence if persistent.

    decision_tree:
      start_node: T0
      nodes:
        T0:
          prompt: |
            üü´ *Overtemperature / Cooling ‚Äî Start*
            First: airflow and filters.
          image: autel/cooling_filters_location
          options:
            - label: "Continue ‚û°Ô∏è"
              next: T1

        T1:
          prompt: |
            *Filters/vents blocked?*
            Inspect filters/vents for dust blockage and cabinet airflow.
          image: autel/cooling_filters_location
          options:
            - label: "Yes ‚Äî blocked/dirty"
              next: T_FIX_FILTERS
            - label: "No ‚Äî looks OK"
              next: T2

        T_FIX_FILTERS:
          prompt: |
            *Clean/replace filters*
            Clean/replace filters then retest under load.
          image: autel/cooling_filters_location
          options:
            - label: "Retest"
              next: T2

        T2:
          prompt: |
            *Fan check*
            Confirm fans are operating and unobstructed.
          image: autel/cooling_fan_location
          options:
            - label: "Fans OK"
              next: T_DONE_OR_ESC
            - label: "Fan not running / blocked"
              next: T_FIX_FANS

        T_FIX_FANS:
          prompt: |
            *Fix fan issue*
            Clear obstruction, check fan connector/power, replace fan if failed. Then retest.
          image: autel/cooling_fan_location
          options:
            - label: "Retest"
              next: T_DONE_OR_ESC

        T_DONE_OR_ESC:
          prompt: |
            Did the fault clear after airflow/fan actions?
          options:
            - label: "Cleared ‚úÖ"
              next: T_DONE
            - label: "Still faulting"
              next: T_ESC

        T_ESC:
          prompt: |
            *Escalate ‚Äî Overtemperature*
            Include: ambient temp, filter condition, fan status, and timestamps.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        T_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Run a short test session and confirm no recurrence.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (6) Power Module Fault (kept as an entry label; routes when needed)
  # ============================================================

  - id: autel_power_module_fault
    platform: autel
    charger_type: dc
    title: "Power Module Fault / Module Offline (Autel DC)"
    severity: high
    tags: [power_module, rectifier, module_offline, routed, hv_enable]

    aliases:
      - "module offline"
      - "power module offline"
      - "rectifier module fault"
      - "power module fault"

    triggers:
      any_text_contains:
        - "power module"
        - "module offline"
        - "rectifier"
        - "power module fault"

    description: >
      First action is reseat to eliminate poor seating/connection. If the symptom also includes start inhibit,
      precharge/DC bus/contactor messages, you should use the canonical HV Enable / Power-Stage cluster.

    decision_tree:
      start_node: PM0
      nodes:

        PM0:
          prompt: |
            üß© *Power Module Offline ‚Äî Start*
            Are you seeing HV start inhibited / precharge/DC bus/contactor messages too?
          options:
            - label: "Yes ‚Äî start inhibited / clicks then faults"
              next: PM_ROUTE_CLUSTER
            - label: "No ‚Äî just a module offline/alarm"
              next: PM1

        PM1:
          prompt: |
            *Reseat (authorised only)*
            Apply LOTO, reseat the affected module/connection, then retest.
          options:
            - label: "Retest"
              next: PM2

        PM2:
          prompt: |
            Did the module return online?
          options:
            - label: "Resolved ‚úÖ"
              next: PM_DONE
            - label: "Still offline"
              next: PM_ESC

        PM_ROUTE_CLUSTER:
          prompt: |
            Use canonical flow:
            *HV Enable / Power-Stage Start Inhibit (Precharge / DC Bus / Contactors)*
            (It includes gates + evidence pack for fastest resolution.)
          options:
            - label: "Open HV Enable cluster"
              next: PS0

        PM_ESC:
          prompt: |
            *Escalate ‚Äî Power Module Offline*
            Include: which module/slot (if known), LEDs, actions (reseat), and timestamps.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        PM_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Run a short test session and confirm stable operation.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__


  # ============================================================
  # (7) TCU Communication Error (expanded)
  # ============================================================

  - id: autel_tcu_communication_error
    platform: autel
    charger_type: dc
    title: "TCU Communication Error (Telematics/Comms Module)"
    severity: high
    tags: [tcu, comms, modem, antenna, harness, leds, ocpp]

    aliases:
      - "TCU communication error"
      - "TCU comm error"
      - "TCU comms fault"
      - "TCU offline"
      - "telematics offline"
      - "communication with tcu"

    triggers:
      any_text_contains:
        - "tcu communication"
        - "tcu comm"
        - "tcu comms"
        - "tcu offline"
        - "tcu not responding"
        - "telematics"
        - "communication with tcu"

    description: >
      Controller cannot communicate reliably with the TCU. Often presents as intermittent offline events, failed backend
      registration, or repeated comms alarms. Highest-yield field checks: controlled reboot, observe LED states, verify
      antenna and harness seating, then isolate network vs hardware.

    decision_tree:
      start_node: TCU0
      nodes:

        TCU0:
          prompt: |
            üì° *TCU Communication Error ‚Äî Start*
            Is the charger also showing OCPP/backend offline?
          options:
            - label: "‚úÖ Yes (offline as well)"
              next: TCU1
            - label: "‚ùå No (charging works / backend ok)"
              next: TCU2
            - label: "Not sure"
              next: TCU1

        TCU1:
          prompt: |
            *Controlled reboot first*
            Reboot via HMI/service menu if available; otherwise controlled power cycle.
            Then check if the alarm returns.
          options:
            - label: "Recovered ‚úÖ"
              next: TCU_MONITOR
            - label: "Still faulting"
              next: TCU_LED_CHECK

        TCU2:
          prompt: |
            *Alarm but service seems OK*
            Treat as intermittent comms/harness/TCU stability issue. Proceed to physical sanity checks.
          options:
            - label: "Continue ‚û°Ô∏è"
              next: TCU_LED_CHECK

        TCU_LED_CHECK:
          prompt: |
            üí° *TCU LED / status check*
            Observe TCU indicators (power/status/network) if accessible.
            What do you see?
          options:
            - label: "No LEDs / dead"
              next: TCU_POWER_HARNESS
            - label: "LEDs on but abnormal (no network / stuck pattern)"
              next: TCU_ANTENNA
            - label: "LEDs normal but alarm persists"
              next: TCU_BACKEND_ALIGN

        TCU_POWER_HARNESS:
          prompt: |
            üîå *Power + harness seating*
            - Check harness connectors are fully seated/latched (controller ‚Üî TCU)
            - Check for loose pins, strain, water ingress
            - If permitted: confirm TCU supply present (control power integrity)
          options:
            - label: "Retest after reseat"
              next: TCU1
            - label: "Still faulting"
              next: TCU_ANTENNA

        TCU_ANTENNA:
          prompt: |
            üì∂ *Antenna sanity*
            - Confirm antenna is connected tightly at the TCU
            - Inspect cable for cuts/kinks/crush points
            - If you have a known-good antenna: swap to test
          options:
            - label: "Retest after antenna checks"
              next: TCU1
            - label: "Still faulting"
              next: TCU_BACKEND_ALIGN

        TCU_BACKEND_ALIGN:
          prompt: |
            üåê *Network alignment*
            If TCU appears alive but comms persist:
            - Check LTE signal (if shown)
            - If Ethernet is used, confirm link lights/port
            - Confirm time sync/DNS not obviously wrong (if visible)
          options:
            - label: "Evidence pack"
              next: TCU_EVIDENCE
            - label: "Autel menu"
              next: __MENU_AUTEL__

        TCU_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî TCU*
            Capture:
            - Exact alarm text + timestamps/frequency
            - LED state description (power/status/network)
            - Antenna/harness actions performed
            - Whether backend/offline was also present
          options:
            - label: "Escalate"
              next: TCU_ESC
            - label: "Autel menu"
              next: __MENU_AUTEL__

        TCU_ESC:
          prompt: |
            *Escalate ‚Äî TCU Communication Error*
            Include evidence pack + whether a known-good antenna/harness reseat changed behaviour.
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__

        TCU_MONITOR:
          prompt: |
            ‚úÖ *Monitor*
            Confirm stability (no repeated offline/TCU alarms).
          options:
            - label: "Autel menu"
              next: __MENU_AUTEL__
