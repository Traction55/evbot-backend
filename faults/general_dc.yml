# general_dc.yml
# EVBot Fault Pack: General DC (On-site Technician v1) ‚Äî Kempower-style (symptom-first, gated)
#
# Philosophy:
# - Symptom-first > code-first
# - Gates: Safety/visual ‚Üí Supply ‚Üí Interlock ‚Üí Comms ‚Üí Thermal ‚Üí Evidence ‚Üí Escalate
# - Keep IDs stable (used by Telegram callback_data)

faults:

  # ============================================================
  # (1) Will Not Power On
  # ============================================================

  - id: general_dc_will_not_power_on
    platform: general_dc
    charger_type: dc
    title: "Will Not Power On (Dead / No Display)"
    severity: critical
    tags: [power, supply, breaker, control_power, hmi, dead]

    aliases:
      - "dead"
      - "no display"
      - "won't power on"
      - "no power"
      - "blank screen"
      - "unit dead"

    triggers:
      any_text_contains:
        - "will not power on"
        - "won't power on"
        - "no display"
        - "blank screen"
        - "unit dead"
        - "no power"

    description: >
      Charger is completely dead (no HMI, no lights, no response). Most common causes are upstream supply isolation,
      tripped breakers/fuses, control power supply failure, or internal aux power distribution faults.

    safety_notes:
      - Follow site LOTO before cabinet access
      - Do not repeatedly reset a tripping breaker/fuse; investigate cause

    decision_tree:
      start_node: GD_DEAD0
      nodes:

        GD_DEAD0:
          prompt: |
            ‚ö° *Will Not Power On*
            First: is there *any* sign of life (HMI backlight, LEDs, fans)?
          options:
            - label: "No signs of life (fully dead)"
              next: GD_DEAD_SUPPLY
            - label: "Some signs of life (lights/fans) but HMI blank"
              next: GD_DEAD_HMI

        GD_DEAD_SUPPLY:
          prompt: |
            üîå *Supply gate*
            - Confirm upstream isolator ON
            - Check upstream breaker/fuse status
            - If permitted: confirm supply present at charger incomer
          options:
            - label: "Found supply issue ‚Üí corrected"
              next: GD_DEAD_RETEST
            - label: "Supply appears OK / can‚Äôt verify"
              next: GD_DEAD_CONTROL_PWR

        GD_DEAD_CONTROL_PWR:
          prompt: |
            üß© *Control power gate*
            If supply is present but unit is dead:
            - Suspect control PSU / aux distribution
            - Look for control PSU LED indicators (if visible)
            - Check obvious loose control plugs (authorised only)
          options:
            - label: "Reboot / power cycle after checks"
              next: GD_DEAD_RETEST
            - label: "Evidence pack"
              next: GD_DEAD_EVIDENCE

        GD_DEAD_HMI:
          prompt: |
            üñ•Ô∏è *HMI gate*
            If fans/LEDs run but screen is blank:
            - Check HMI power / brightness / cable seating (if accessible)
            - Attempt soft reboot (if any UI access)
          options:
            - label: "Recovered"
              next: GD_DONE
            - label: "Still blank"
              next: GD_DEAD_EVIDENCE

        GD_DEAD_RETEST:
          prompt: |
            üîÅ *Retest*
            After restoring supply/control power, does the charger boot normally?
          options:
            - label: "Boots normally ‚úÖ"
              next: GD_DONE
            - label: "Still dead"
              next: GD_DEAD_EVIDENCE

        GD_DEAD_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Dead unit*
            Capture:
            - Upstream breaker/isolator status
            - Any measured voltages (if taken)
            - Any LEDs observed on control PSU/boards
            - Photos of incomer/breaker status and HMI
          options:
            - label: "Escalate"
              next: GD_ESC
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__

        GD_ESC:
          prompt: |
            *Escalate ‚Äî Will Not Power On*
            Include evidence pack + site supply details and timestamps.
          options:
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__

        GD_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stable boot and basic readiness (no immediate re-fault).
          options:
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__


  # ============================================================
  # (2) Powers On but Won‚Äôt Start Charge
  # ============================================================

  - id: general_dc_powers_on_wont_start_charge
    platform: general_dc
    charger_type: dc
    title: "Powers On but Won‚Äôt Start Charge"
    severity: high
    tags: [start_fail, interlock, ccs, handshake, hv_enable, ocpp]

    aliases:
      - "won't start"
      - "start failed"
      - "session won't begin"
      - "plug in but won't charge"

    triggers:
      any_text_contains:
        - "won‚Äôt start charge"
        - "won't start charge"
        - "start failed"
        - "session won't start"

    description: >
      Charger is online/awake but refuses to begin a session. Common root causes: interlock/E-stop,
      vehicle handshake, connector issues, backend auth, or internal HV-enable gating.

    decision_tree:
      start_node: GD_START0
      nodes:

        GD_START0:
          prompt: |
            üö´ *Powers On but Won‚Äôt Start*
            What‚Äôs the closest symptom?
          options:
            - label: "Shows interlock/E-stop / door open"
              next: GD_START_INTERLOCK
            - label: "Handshake/vehicle communication error"
              next: GD_START_HANDSHAKE
            - label: "Backend/auth/payment issue"
              next: GD_START_BACKEND
            - label: "Clicks/tries then stops quickly"
              next: GD_START_POWERSTAGE
            - label: "Not sure"
              next: GD_START_EVIDENCE

        GD_START_INTERLOCK:
          prompt: |
            ‚¨õ *Interlock gate*
            - Clear E-stop
            - Confirm doors closed
            - Confirm interlock chain restored
          options:
            - label: "Retest"
              next: GD_START_RETEST
            - label: "Won‚Äôt clear"
              next: GD_START_EVIDENCE

        GD_START_HANDSHAKE:
          prompt: |
            üîå *Handshake gate*
            - Inspect connector pins/face for damage/debris/water
            - Try a known-good vehicle if available
            - Try another connector/port if the site has one
          options:
            - label: "Retest"
              next: GD_START_RETEST
            - label: "Still failing"
              next: GD_START_EVIDENCE

        GD_START_BACKEND:
          prompt: |
            üåê *Backend/auth gate*
            - Is the charger showing offline?
            - Any auth/payment error?
            - If possible: confirm site connectivity / router status
          options:
            - label: "Route to Offline/Comms fault"
              next: __ROUTE_GENERAL_DC_OFFLINE__
            - label: "Evidence pack"
              next: GD_START_EVIDENCE

        GD_START_POWERSTAGE:
          prompt: |
            ‚ö° *Power-stage hint*
            If it clicks/tries then aborts, treat like a HV enable/precharge/contactors issue (OEM escalation usually required).
          options:
            - label: "Evidence pack"
              next: GD_START_EVIDENCE

        GD_START_RETEST:
          prompt: |
            üîÅ *Retest*
            Does a session start successfully now?
          options:
            - label: "Yes ‚úÖ"
              next: GD_DONE
            - label: "No"
              next: GD_START_EVIDENCE

        GD_START_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Start fail*
            Capture:
            - What the screen says (exact text)
            - Whether it attempts/clicks
            - Vehicle/connector used
            - Whether backend/auth involved
            - Timestamps + photos
          options:
            - label: "Escalate"
              next: GD_ESC
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__

        GD_ESC:
          prompt: |
            *Escalate ‚Äî Won‚Äôt Start Charge*
            Include evidence pack and what you tried (interlock/vehicle/connector/backend).
          options:
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__

        GD_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stable operation with a short test session.
          options:
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__


  # ============================================================
  # (3) Offline / Backend Comms
  # ============================================================

  - id: general_dc_offline_backend_comms
    platform: general_dc
    charger_type: dc
    title: "Offline / Backend Comms"
    severity: high
    tags: [ocpp, network, modem, sim, ethernet, offline]

    aliases: ["offline", "ocpp offline", "backend offline", "server offline"]

    triggers:
      any_text_contains:
        - "offline"
        - "backend offline"
        - "ocpp offline"
        - "server offline"
        - "network offline"

    description: >
      Charger is not connected to backend. Highest-yield path: reboot ‚Üí check link (LTE/Ethernet) ‚Üí
      check antenna/SIM/cables ‚Üí evidence pack.

    decision_tree:
      start_node: GD_NET0
      nodes:

        GD_NET0:
          prompt: |
            üåê *Offline / Comms ‚Äî Start*
            Is it site-wide (multiple chargers offline) or just this unit?
          options:
            - label: "Multiple chargers offline / site likely"
              next: GD_NET_SITE
            - label: "Only this charger offline"
              next: GD_NET_REBOOT
            - label: "Not sure"
              next: GD_NET_REBOOT

        GD_NET_SITE:
          prompt: |
            *Site gate*
            - Check router/WAN status if accessible
            - Note site outage indicators
          options:
            - label: "Reboot charger after site checks"
              next: GD_NET_REBOOT
            - label: "Evidence pack"
              next: GD_NET_EVIDENCE

        GD_NET_REBOOT:
          prompt: |
            üîÅ *Controlled reboot*
            Reboot/power cycle and wait for registration/handshake.
          options:
            - label: "Recovered ‚úÖ"
              next: GD_DONE
            - label: "Still offline"
              next: GD_NET_LINKTYPE

        GD_NET_LINKTYPE:
          prompt: |
            *Connection type?*
          options:
            - label: "üì∂ Cellular/LTE"
              next: GD_NET_LTE
            - label: "üîå Ethernet"
              next: GD_NET_ETH
            - label: "‚ùì Not sure"
              next: GD_NET_EVIDENCE

        GD_NET_LTE:
          prompt: |
            üì∂ *LTE checks*
            - Antenna seated/tight, cable not damaged
            - If permitted: reseat SIM
            - Note signal indicators if shown
          options:
            - label: "Retest"
              next: GD_NET_REBOOT
            - label: "Evidence pack"
              next: GD_NET_EVIDENCE

        GD_NET_ETH:
          prompt: |
            üîå *Ethernet checks*
            - Link lights?
            - Reseat cable at charger and switch
            - Try alternate port/cable if permitted
          options:
            - label: "Retest"
              next: GD_NET_REBOOT
            - label: "Evidence pack"
              next: GD_NET_EVIDENCE

        GD_NET_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Offline*
            Capture:
            - Offline message + timestamp
            - Link type (LTE/Ethernet)
            - Antenna/cable/SIM actions performed
            - Any signal/link indicators
          options:
            - label: "Escalate"
              next: GD_ESC
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__


  # ============================================================
  # (4) Vehicle Handshake Failure
  # ============================================================

  - id: general_dc_vehicle_handshake_failure
    platform: general_dc
    charger_type: dc
    title: "Vehicle Handshake Failure (CCS)"
    severity: high
    tags: [ccs, handshake, cp, pp, connector, plc]

    aliases: ["handshake failed", "vehicle communication error", "ccs error"]

    triggers:
      any_text_contains:
        - "handshake"
        - "vehicle communication"
        - "ccs error"
        - "plc"
        - "cp fault"

    description: >
      Vehicle comms fails at plug-in or during session start. Most common causes: connector contamination/damage,
      CP/PP issues, vehicle-side fault, or PLC handshake instability.

    decision_tree:
      start_node: GD_HS0
      nodes:

        GD_HS0:
          prompt: |
            üîå *Handshake Failure ‚Äî Start*
            Do you have another vehicle or another connector/port to test?
          options:
            - label: "Yes"
              next: GD_HS_TEST
            - label: "No"
              next: GD_HS_VISUAL

        GD_HS_TEST:
          prompt: |
            *A/B test*
            - Try known-good vehicle
            - Try alternate connector/port
            Does the fault follow the connector/port?
          options:
            - label: "Follows connector/port"
              next: GD_HS_VISUAL
            - label: "Does not follow (vehicle-specific)"
              next: GD_HS_VEHICLE
            - label: "Unclear"
              next: GD_HS_VISUAL

        GD_HS_VISUAL:
          prompt: |
            üëÄ *Connector inspection*
            - Check pins for burning/bent pins
            - Check for water/debris
            - Check latch engagement
          options:
            - label: "Damage/contamination found"
              next: GD_HS_EVIDENCE
            - label: "Looks OK"
              next: GD_HS_REBOOT

        GD_HS_REBOOT:
          prompt: |
            üîÅ *Reboot and retry*
            Controlled reboot then retry session start.
          options:
            - label: "Resolved ‚úÖ"
              next: GD_DONE
            - label: "Still failing"
              next: GD_HS_EVIDENCE

        GD_HS_VEHICLE:
          prompt: |
            üöó *Vehicle-specific*
            Likely vehicle issue if other vehicles work. Provide customer guidance if appropriate.
          options:
            - label: "Evidence pack"
              next: GD_HS_EVIDENCE
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__

        GD_HS_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Handshake*
            Capture:
            - Vehicle make/model
            - Connector/port used
            - Any visible connector damage
            - Screen message + timestamp
          options:
            - label: "Escalate"
              next: GD_ESC
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__


  # ============================================================
  # (5) Insulation / Earth Fault
  # ============================================================

  - id: general_dc_insulation_earth_fault
    platform: general_dc
    charger_type: dc
    title: "Insulation / Earth Fault (IMD / Isolation)"
    severity: critical
    tags: [safety, insulation, isolation, imd, earth_fault, moisture]

    aliases: ["earth fault", "isolation fault", "imd alarm", "insulation low"]

    triggers:
      any_text_contains:
        - "earth fault"
        - "isolation"
        - "insulation"
        - "imd"
        - "leakage"

    description: >
      Safety critical isolation/earth leakage condition. Avoid repeated start attempts.
      Highest-yield checks are visual moisture/contamination at connector and cabinet.

    decision_tree:
      start_node: GD_IMD0
      nodes:

        GD_IMD0:
          prompt: |
            üü™ *Insulation / Earth Fault ‚Äî Safety gate*
            - Avoid repeated retries
            - Inspect for moisture/water ingress/contamination
          options:
            - label: "Continue ‚û°Ô∏è"
              next: GD_IMD_VISUAL

        GD_IMD_VISUAL:
          prompt: |
            üëÄ *Visual inspection*
            - Connector face: water/debris/burn marks?
            - Cabinet: moisture marks?
          options:
            - label: "Moisture/contamination suspected"
              next: GD_IMD_EVIDENCE
            - label: "No obvious moisture"
              next: GD_IMD_EVIDENCE

        GD_IMD_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Isolation*
            Capture:
            - Exact alarm text + timestamp
            - Photos of connector face + cabinet
            - Weather/environment notes
          options:
            - label: "Escalate"
              next: GD_ESC
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__


  # ============================================================
  # (6) Overtemp / Cooling
  # ============================================================

  - id: general_dc_overtemp_cooling_fault
    platform: general_dc
    charger_type: dc
    title: "Overtemp / Cooling Fault"
    severity: high
    tags: [cooling, fans, filters, thermal]

    triggers:
      any_text_contains: ["overtemp", "thermal", "cooling fault", "fan fault"]

    decision_tree:
      start_node: GD_TH0
      nodes:

        GD_TH0:
          prompt: |
            üü´ *Overtemp / Cooling ‚Äî Start*
            First: airflow and filters.
          options:
            - label: "Continue ‚û°Ô∏è"
              next: GD_TH_FILTERS

        GD_TH_FILTERS:
          prompt: |
            *Filters/vents blocked?*
            Inspect filters/vents for dust blockage.
          options:
            - label: "Yes ‚Äî dirty/blocked"
              next: GD_TH_RETEST
            - label: "No ‚Äî looks OK"
              next: GD_TH_FANS

        GD_TH_FANS:
          prompt: |
            *Fan check*
            Confirm fans operate and are unobstructed.
          options:
            - label: "Fans OK"
              next: GD_TH_RETEST
            - label: "Fan issue"
              next: GD_TH_RETEST

        GD_TH_RETEST:
          prompt: |
            üîÅ *Retest*
            Did the fault clear after airflow/fan actions?
          options:
            - label: "Cleared ‚úÖ"
              next: GD_DONE
            - label: "Still faulting"
              next: GD_ESC


  # ============================================================
  # (7) E-stop / Interlock Active
  # ============================================================

  - id: general_dc_estop_interlock_active
    platform: general_dc
    charger_type: dc
    title: "E-stop / Interlock Active"
    severity: high
    tags: [safety, interlock, estop, hvil, door]

    triggers:
      any_text_contains: ["e-stop", "estop", "interlock", "door open", "hvil"]

    decision_tree:
      start_node: GD_INT0
      nodes:

        GD_INT0:
          prompt: |
            ‚¨õ *E-stop / Interlock ‚Äî Start*
            - Confirm E-stop released
            - Confirm doors closed
            - Restore interlock chain
          options:
            - label: "Retest session"
              next: GD_INT_RETEST
            - label: "Won‚Äôt clear"
              next: GD_ESC

        GD_INT_RETEST:
          prompt: |
            Did the charger return to ready state?
          options:
            - label: "Yes ‚úÖ"
              next: GD_DONE
            - label: "No"
              next: GD_ESC


  # ============================================================
  # (8) Low Power / Derating
  # ============================================================

  - id: general_dc_power_derating_low_power
    platform: general_dc
    charger_type: dc
    title: "Low Power / Derating"
    severity: medium
    tags: [derate, power, cooling, module, supply]

    triggers:
      any_text_contains: ["derate", "low power", "reduced power", "power limited"]

    decision_tree:
      start_node: GD_DR0
      nodes:

        GD_DR0:
          prompt: |
            ‚ö†Ô∏è *Low Power / Derating ‚Äî Start*
            Is the site hot / airflow blocked?
          options:
            - label: "Yes / likely thermal"
              next: __ROUTE_GENERAL_DC_OVERTEMP__
            - label: "No / unknown"
              next: GD_DR_SUPPLY

        GD_DR_SUPPLY:
          prompt: |
            üîå *Supply sanity*
            Any known site supply limits/undervoltage under load?
          options:
            - label: "Yes"
              next: GD_DR_EVIDENCE
            - label: "No / unknown"
              next: GD_DR_EVIDENCE

        GD_DR_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Derating*
            Capture:
            - Delivered kW
            - Whether stable/fluctuating
            - Ambient/ventilation notes
            - Any supply alarms
          options:
            - label: "Escalate"
              next: GD_ESC
            - label: "General DC menu"
              next: __MENU_GENERAL_DC__


  # ============================================================
  # (9) HMI Frozen / Unresponsive
  # ============================================================

  - id: general_dc_hmi_frozen_unresponsive
    platform: general_dc
    charger_type: dc
    title: "HMI Frozen / Unresponsive"
    severity: medium
    tags: [hmi, ui, frozen, reboot]

    triggers:
      any_text_contains: ["hmi frozen", "screen frozen", "unresponsive", "touch not working"]

    decision_tree:
      start_node: GD_UI0
      nodes:

        GD_UI0:
          prompt: |
            üñ•Ô∏è *HMI Frozen ‚Äî Start*
            Try a controlled reboot (UI reboot if available; else power cycle).
          options:
            - label: "Rebooted ‚Üí recovered ‚úÖ"
              next: GD_DONE
            - label: "Still frozen"
              next: GD_ESC


  # ============================================================
  # ROUTES (internal shortcuts used by menu UX)
  # ============================================================

  - id: __route_general_dc_offline__
    platform: general_dc
    charger_type: dc
    title: "__ROUTE: Offline/Comms"
    severity: low
    tags: [route]
    decision_tree:
      start_node: R0
      nodes:
        R0:
          prompt: |
            Routing to: *Offline / Backend Comms*
          options:
            - label: "Open Offline / Backend Comms"
              next: GD_NET0

  - id: __route_general_dc_overtemp__
    platform: general_dc
    charger_type: dc
    title: "__ROUTE: Overtemp/Cooling"
    severity: low
    tags: [route]
    decision_tree:
      start_node: R1
      nodes:
        R1:
          prompt: |
            Routing to: *Overtemp / Cooling Fault*
          options:
            - label: "Open Overtemp / Cooling Fault"
              next: GD_TH0
