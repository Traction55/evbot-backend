# faults/general_dc.yml
# EVBot Fault Pack: General DC Charger (All Brands)
# Gold Standard Fault Cards ‚Äî Technician-first (Jan 2026)
#
# CONTRACT:
# - Fault IDs are permanent ‚Äî DO NOT CHANGE
# - Symptom-first entry
# - Safety gate early
# - Explicit outcomes: RESOLVED / STABILISED / ESCALATED
# - No index.js changes required

faults:

  # ============================================================
  # WILL NOT POWER ON
  # ============================================================

  - id: general_dc_will_not_power_on
    platform: general_dc
    charger_type: dc
    title: "Will Not Power On (Dead / No Display)"
    severity: high
    tags: [power, supply, breaker, interlock, control_power]

    aliases:
      - "no power"
      - "dead"
      - "blank screen"
      - "no display"
      - "won't power on"
      - "will not power on"

    triggers:
      any_text_contains:
        - "no power"
        - "dead"
        - "blank screen"
        - "no display"
        - "won't power on"
        - "will not power on"

    description: >
      The charger shows no signs of life (no display or LEDs). This is most commonly caused by
      upstream supply loss, an active safety interlock, or failed control power. Confirm supply
      and interlocks before assuming internal failure.

    safety_notes:
      - Apply LOTO before opening cabinets
      - Do not repeatedly reset tripping breakers

    decision_tree:
      start_node: GDNP0
      nodes:

        GDNP0:
          prompt: |
            *Will Not Power On (Dead / No Display)*
            What is the scope?
          options:
            - label: "One charger affected"
              next: GDNP_SAFETY
            - label: "Multiple chargers / site-wide"
              next: GDNP_SAFETY

        GDNP_SAFETY:
          prompt: |
            ‚úÖ *Safety first*
            Can you work safely and apply isolation if required?
          options:
            - label: "Yes"
              next: GDNP_SUPPLY
            - label: "No / unsure"
              next: GDNP_ESC

        GDNP_SUPPLY:
          prompt: |
            ‚ö° *Upstream supply*
            Is the isolator/breaker ON and correct AC voltage present?
          options:
            - label: "No / tripped / missing voltage"
              next: GDNP_RESTORE
            - label: "Yes"
              next: GDNP_INTERLOCKS

        GDNP_RESTORE:
          prompt: |
            *Restore supply (once only if safe)*
          options:
            - label: "Recovered"
              next: GDNP_DONE_RESOLVED
            - label: "Trips again / unstable"
              next: GDNP_DONE_STAB
            - label: "Still dead"
              next: GDNP_INTERLOCKS

        GDNP_INTERLOCKS:
          prompt: |
            ‚¨õ *Interlocks*
            Are E-stops / doors / site interlocks active?
          options:
            - label: "Yes"
              next: GDNP_CLEAR_INTERLOCKS
            - label: "No"
              next: GDNP_CONTROL_POWER

        GDNP_CLEAR_INTERLOCKS:
          prompt: |
            Clear all interlocks and re-test.
          options:
            - label: "Recovered"
              next: GDNP_DONE_RESOLVED
            - label: "Still dead"
              next: GDNP_CONTROL_POWER

        GDNP_CONTROL_POWER:
          prompt: |
            üîå *Control power*
            Is LV/control power present and stable?
          options:
            - label: "Yes"
              next: GDNP_REBOOT
            - label: "No / unstable"
              next: GDNP_ESC

        GDNP_REBOOT:
          prompt: |
            üîÅ *Controlled power cycle*
          options:
            - label: "Recovered"
              next: GDNP_DONE_RESOLVED
            - label: "Recovered but unstable"
              next: GDNP_DONE_STAB
            - label: "Still dead"
              next: GDNP_ESC

        GDNP_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Charger powered on normally.
            Use **Create report for this fault**.
          options:
            - label: "üè† Back to General DC menu"
              next: "__MENU_GENERAL_DC__"

        GDNP_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised*
            Charger powered but supply/interlock is intermittent.
            Document conditions and follow up.
            Use **Create report for this fault**.
          options:
            - label: "üè† Back to General DC menu"
              next: "__MENU_GENERAL_DC__"

        GDNP_ESC:
          prompt: |
            *Escalate ‚Äî Will Not Power On*
            Include supply state, interlocks, actions attempted,
            timestamps, and photos if safe.
          options:
            - label: "üè† Back to General DC menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # POWERS ON BUT WON‚ÄôT START
  # ============================================================

  - id: general_dc_powers_on_wont_start_charge
    platform: general_dc
    charger_type: dc
    title: "Powers On but Won‚Äôt Start Charging"
    severity: high
    tags: [session, authorisation, contactor, handshake]

    aliases:
      - "won't start"
      - "cannot start charge"
      - "start failed"
      - "plugged in but won't charge"

    triggers:
      any_text_contains:
        - "won't start charging"
        - "cannot start"
        - "start failed"
        - "plugged in but won't charge"

    description: >
      The charger is powered and responsive but cannot begin a session.
      This is usually caused by readiness issues, authorisation blocks,
      vehicle handshake failures, or internal safety conditions.

    decision_tree:
      start_node: GDST0
      nodes:

        GDST0:
          prompt: |
            *Powers On but Won‚Äôt Start Charging*
            Is any fault message shown?
          options:
            - label: "Yes ‚Äî a fault is shown"
              next: GDST_ROUTE
            - label: "No ‚Äî just won‚Äôt start"
              next: GDST_BASICS

        GDST_BASICS:
          prompt: |
            Confirm basics: connector latched, correct plug selected,
            charger shows Ready.
          options:
            - label: "All OK"
              next: GDST_SWAP
            - label: "Issue found"
              next: GDST_SWAP

        GDST_SWAP:
          prompt: |
            Try known-good EV or alternate connector.
          options:
            - label: "Still fails"
              next: GDST_ROUTE
            - label: "Works"
              next: GDST_DONE_RESOLVED

        GDST_ROUTE:
          prompt: |
            Route by fault type shown:
          options:
            - label: "üü¶ Handshake / vehicle comms"
              next: "__MENU_GENERAL_DC__"
            - label: "üü™ Insulation / earth fault"
              next: "__MENU_GENERAL_DC__"
            - label: "‚¨õ E-stop / interlock"
              next: "__MENU_GENERAL_DC__"
            - label: "üü´ Overtemp / cooling"
              next: "__MENU_GENERAL_DC__"
            - label: "üü• HV / precharge blocked"
              next: GDST_ESC

        GDST_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Session starts normally.
            Use **Create report for this fault** if repeatable.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDST_ESC:
          prompt: |
            *Escalate ‚Äî Won‚Äôt Start Charging*
            Include EV model, connector used, fault text,
            timestamps, and actions attempted.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # OFFLINE / BACKEND COMMS
  # ============================================================

  - id: general_dc_offline_backend_comms
    platform: general_dc
    charger_type: dc
    title: "Offline / Backend Comms Down (OCPP / LTE / Ethernet)"
    severity: high
    tags: [comms, ocpp, modem, ethernet, sim]

    aliases:
      - "offline"
      - "ocpp offline"
      - "backend down"
      - "no communication"

    triggers:
      any_text_contains:
        - "offline"
        - "ocpp"
        - "no comms"
        - "backend offline"
        - "modem offline"

    description: >
      The charger cannot communicate with the backend due to LTE,
      Ethernet, or site network issues. Identify link type first,
      then follow the correct recovery order.

    decision_tree:
      start_node: GDOC0
      nodes:

        GDOC0:
          prompt: |
            *Offline / Backend Comms*
            What link type is used?
          options:
            - label: "LTE / Cellular"
              next: GDOC_LTE
            - label: "Ethernet"
              next: GDOC_ETH
            - label: "Not sure"
              next: GDOC_REBOOT

        GDOC_LTE:
          prompt: |
            Check modem power, antenna, and signal.
          options:
            - label: "Recovered"
              next: GDOC_DONE_RESOLVED
            - label: "Still offline"
              next: GDOC_REBOOT

        GDOC_ETH:
          prompt: |
            Check link lights, cabling, and switch port.
          options:
            - label: "Recovered"
              next: GDOC_DONE_RESOLVED
            - label: "Still offline"
              next: GDOC_REBOOT

        GDOC_REBOOT:
          prompt: |
            Reboot modem/router first, then charger.
          options:
            - label: "Recovered"
              next: GDOC_DONE_RESOLVED
            - label: "Still offline"
              next: GDOC_ESC

        GDOC_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Backend comms restored.
            Use **Create report for this fault** if repeatable.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDOC_ESC:
          prompt: |
            *Escalate ‚Äî Offline / Backend Comms*
            Include link type, ICCID/IMEI or MAC,
            timestamps, and reboot order.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # HANDSHAKE FAILURE
  # ============================================================

  - id: general_dc_vehicle_handshake_failure
    platform: general_dc
    charger_type: dc
    title: "Vehicle Connection / Handshake Failure"
    severity: medium
    tags: [handshake, connector, cp, pp]

    aliases:
      - "handshake failed"
      - "vehicle not detected"
      - "plug error"

    triggers:
      any_text_contains:
        - "handshake"
        - "vehicle not detected"
        - "plug error"
        - "cp"
        - "pp"

    description: >
      The EV and charger fail to complete initial communication.
      Most often caused by connector condition or vehicle-side limits.

    decision_tree:
      start_node: GDHS0
      nodes:

        GDHS0:
          prompt: |
            Inspect connector for damage or contamination.
          options:
            - label: "Damage found"
              next: GDHS_ESC
            - label: "Looks OK"
              next: GDHS_SWAP

        GDHS_SWAP:
          prompt: |
            Try alternate connector or known-good EV.
          options:
            - label: "Works"
              next: GDHS_DONE_STAB
            - label: "Fails"
              next: GDHS_REBOOT

        GDHS_REBOOT:
          prompt: |
            Controlled reboot and retry.
          options:
            - label: "Recovered"
              next: GDHS_DONE_RESOLVED
            - label: "Still failing"
              next: GDHS_ESC

        GDHS_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Handshake successful.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDHS_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised*
            Likely connector or vehicle-specific.
            Tag connector and document.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDHS_ESC:
          prompt: |
            *Escalate ‚Äî Handshake Failure*
            Include photos, EV model, connector ID,
            and timestamps.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # INSULATION / EARTH FAULT
  # ============================================================

  - id: general_dc_insulation_earth_fault
    platform: general_dc
    charger_type: dc
    title: "Insulation / Earth Fault"
    severity: high
    tags: [safety, insulation, imd]

    aliases:
      - "insulation fault"
      - "earth fault"
      - "imd fault"

    triggers:
      any_text_contains:
        - "insulation"
        - "earth fault"
        - "imd"

    description: >
      Indicates leakage to earth. Treat as safety-critical.
      Stabilise safely and escalate with evidence.

    decision_tree:
      start_node: GDIM0
      nodes:

        GDIM0:
          prompt: |
            Is this occurring with or without an EV connected?
          options:
            - label: "Without EV"
              next: GDIM_ESC
            - label: "Only with EV"
              next: GDIM_DONE_STAB

        GDIM_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised*
            Likely vehicle or connector leakage.
            Take out of service if repeatable.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDIM_ESC:
          prompt: |
            *Escalate ‚Äî Insulation / Earth Fault*
            Include moisture evidence, photos,
            timestamps, and test results if authorised.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # OVERTEMP / COOLING
  # ============================================================

  - id: general_dc_overtemp_cooling_fault
    platform: general_dc
    charger_type: dc
    title: "Overtemperature / Cooling Fault"
    severity: high
    tags: [thermal, cooling]

    aliases:
      - "overtemp"
      - "cooling fault"
      - "fan fault"

    triggers:
      any_text_contains:
        - "overtemp"
        - "cooling fault"
        - "fan fault"

    description: >
      Caused by blocked airflow, fan/pump failure,
      or extreme ambient conditions.

    decision_tree:
      start_node: GDTH0
      nodes:

        GDTH0:
          prompt: |
            Is the charger derating or shutting down?
          options:
            - label: "Derating"
              next: GDTH_DONE_STAB
            - label: "Shutdown"
              next: GDTH_ESC

        GDTH_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised*
            Improve airflow and plan follow-up service.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDTH_ESC:
          prompt: |
            *Escalate ‚Äî Overtemp*
            Include ambient temp, airflow condition,
            and photos of vents/filters.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # E-STOP / INTERLOCK
  # ============================================================

  - id: general_dc_estop_interlock_active
    platform: general_dc
    charger_type: dc
    title: "Emergency Stop / Safety Interlock Active"
    severity: high
    tags: [safety, interlock, estop]

    aliases:
      - "e-stop"
      - "interlock open"
      - "door open"

    triggers:
      any_text_contains:
        - "e-stop"
        - "interlock"
        - "door open"

    description: >
      A safety loop is open. Clear the indicated interlock
      and confirm the charger returns to Ready.

    decision_tree:
      start_node: GDIL0
      nodes:

        GDIL0:
          prompt: |
            Identify which interlock is active.
          options:
            - label: "E-stop"
              next: GDIL_DONE_RESOLVED
            - label: "Door / HVIL / Site interlock"
              next: GDIL_DONE_RESOLVED

        GDIL_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Interlock cleared and charger ready.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # LOW POWER / DERATING
  # ============================================================

  - id: general_dc_power_derating_low_power
    platform: general_dc
    charger_type: dc
    title: "Low Power / Derating"
    severity: medium
    tags: [performance, derating]

    aliases:
      - "slow charging"
      - "low power"
      - "derating"

    triggers:
      any_text_contains:
        - "slow"
        - "low power"
        - "derate"

    description: >
      Reduced power due to EV limits, site limits,
      thermal derating, or supply quality.

    decision_tree:
      start_node: GDLW0
      nodes:

        GDLW0:
          prompt: |
            Is this likely EV-limited or site-limited?
          options:
            - label: "Likely EV / site"
              next: GDLW_DONE_STAB
            - label: "Unclear"
              next: GDLW_ESC

        GDLW_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised*
            Document delivered kW, EV model, and conditions.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDLW_ESC:
          prompt: |
            *Escalate ‚Äî Low Power*
            Include delivered kW, EV model,
            site limits, and timestamps.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # HMI FROZEN
  # ============================================================

  - id: general_dc_hmi_frozen_unresponsive
    platform: general_dc
    charger_type: dc
    title: "HMI Frozen / Unresponsive"
    severity: medium
    tags: [hmi, ui, reboot]

    aliases:
      - "screen frozen"
      - "unresponsive"

    triggers:
      any_text_contains:
        - "frozen"
        - "unresponsive"

    description: >
      The screen is on but the UI is unresponsive due to a software hang.

    decision_tree:
      start_node: GDUI0
      nodes:

        GDUI0:
          prompt: |
            Is there an active charging session?
          options:
            - label: "Yes"
              next: GDUI_DONE_STAB
            - label: "No"
              next: GDUI_REBOOT

        GDUI_REBOOT:
          prompt: |
            Perform a controlled reboot.
          options:
            - label: "Recovered"
              next: GDUI_DONE_RESOLVED
            - label: "Still frozen"
              next: GDUI_ESC

        GDUI_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            UI restored.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDUI_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised*
            Monitor until session ends and escalate if repeatable.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"

        GDUI_ESC:
          prompt: |
            *Escalate ‚Äî HMI Frozen*
            Include photo/video, timestamps,
            and reboot method used.
          options:
            - label: "üè† Back to menu"
              next: "__MENU_GENERAL_DC__"
