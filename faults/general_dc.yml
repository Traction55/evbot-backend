# general_dc.yml
# EVBot Fault Pack: General DC (On-site Technician v1) â€” Kempower-style (symptom-first, gated, canonical clusters)
#
# Philosophy:
# - A few gold-standard CLUSTERS do the heavy lifting (consistent gates + evidence pack + outcomes)
# - Many â€œfaultâ€ entries act as ROUTERS (IDs stable for deep-links + familiar labels)
# - Symptom-first > code-first. Codes route you into the same canonical path.
#
# Notes:
# - Node-based decision tree: start_node + nodes map
# - node.options MUST be a LIST of {label, next}
# - image: general_dc/<filename_without_extension> (optional; expects files in assets/images/general_dc/*.png)

faults:

  # ============================================================
  # (1) GOLD STANDARD CLUSTER: HV Enable / Start Inhibit
  # Canonical flow for:
  # - Wonâ€™t start / start failed
  # - Precharge / DC bus not ready
  # - DC output contactor failed to close/verify
  # - AC input contactor faults that block start
  # - â€œClicks then faults quicklyâ€
  # ============================================================

  - id: general_dc_hv_enable_cluster
    platform: general_dc
    charger_type: dc
    title: "HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)"
    severity: critical
    tags: [hv_enable, start_inhibit, precharge, dc_bus, contactor, interlock, insulation, supply]

    aliases:
      - "start failed"
      - "start inhibited"
      - "hv enable fault"
      - "precharge fault"
      - "dc bus not ready"
      - "dc bus undervoltage"
      - "dc bus overvoltage"
      - "output contactor fault"
      - "dc contactor fault"
      - "ac contactor fault"
      - "internal power fault"
      - "clicks then faults"

    triggers:
      any_text_contains:
        - "start failed"
        - "start inhibited"
        - "hv enable"
        - "precharge"
        - "pre-charge"
        - "dc bus"
        - "bus not ready"
        - "bus undervoltage"
        - "bus overvoltage"
        - "output contactor"
        - "dc contactor"
        - "ac contactor"
        - "failed to close"
        - "verify failed"
        - "contactor fault"
        - "interlock"
        - "hvil"
        - "e-stop"
        - "estop"
        - "insulation"
        - "isolation"
        - "imd"
        - "earth leakage"
        - "rcm"
        - "rcd"

    description: >
      The charger is preventing HV start or cannot complete the HV start sequence (enable â†’ precharge â†’ DC bus build â†’
      contactor verification). Fastest wins come from gating: safety/visual â†’ supply sanity â†’ interlock/HVIL â†’
      insulation/IMD/earth leakage â†’ controlled reboot â†’ â€œfirst fault that returnsâ€. Do not chase parts before gates.

    safety_notes:
      - LOTO before opening cabinets; wait minimum 5 minutes for DC bus discharge
      - Treat insulation/isolation/earth leakage alarms as high risk; avoid repeated start attempts
      - Do not bypass HVIL/interlocks; do not repeatedly reset trips

    tools_required:
      - Multimeter (true RMS preferred)
      - Insulated hand tools
      - Torch / inspection light

    decision_tree:
      start_node: HV0
      nodes:

        HV0:
          prompt: |
            âš¡ *General DC â€” HV Enable / Start Inhibit*
            Start with what youâ€™re seeing (symptom-first). Pick the closest:
          options:
            - label: "ğŸš« Wonâ€™t start / fails immediately"
              next: HV_PATTERN_START_FAIL
            - label: "âš ï¸ Clicks/tries then faults quickly"
              next: HV_PATTERN_CLICKS
            - label: "ğŸŸª Insulation / Isolation / Earth leakage (IMD/RCM/RCD)"
              next: HV_ISO_GATE
            - label: "â¬› Interlock / HVIL / E-stop indicated"
              next: HV_INTERLOCK_GATE
            - label: "ğŸ”Œ Supply unstable / undervoltage / phase issue suspected"
              next: HV_SUPPLY_GATE
            - label: "ğŸ” I have a specific message (precharge/DC bus/contactor)"
              next: HV_CODE_ROUTER

        HV_PATTERN_START_FAIL:
          prompt: |
            *Pattern check â€” Start fails*
            Do you see an explicit block reason on the HMI/log?
          options:
            - label: "ğŸŸª Isolation/earth leakage (IMD/RCM/RCD)"
              next: HV_ISO_GATE
            - label: "â¬› Interlock/HVIL/E-stop"
              next: HV_INTERLOCK_GATE
            - label: "ğŸŸ¥ Contactor / Precharge / DC bus"
              next: HV_SAFE_REBOOT
            - label: "No obvious reason shown"
              next: HV_SAFE_REBOOT

        HV_PATTERN_CLICKS:
          prompt: |
            *Pattern check â€” Clicks then faults*
            Most often: supply sag at enable, interlock gating, or contactor/DC bus verification.
            Proceed with a clean safe-first recovery to identify the *first fault that returns*.
          options:
            - label: "Continue â¡ï¸"
              next: HV_SAFE_REBOOT

        HV_CODE_ROUTER:
          prompt: |
            *Quick routing (choose closest)*
          options:
            - label: "ğŸŸ¥ DC/Output contactor failed / failed to close / verify"
              next: HV_SAFE_REBOOT
            - label: "ğŸŸ¦ Precharge fault / DC bus not ready / undervoltage"
              next: HV_SAFE_REBOOT
            - label: "ğŸŸ§ DC bus overvoltage"
              next: HV_DC_BUS_OV
            - label: "ğŸŸª Insulation / earth leakage / IMD/RCM/RCD"
              next: HV_ISO_GATE
            - label: "â¬› Interlock / HVIL / E-stop"
              next: HV_INTERLOCK_GATE
            - label: "â“ Not sure"
              next: HV_SAFE_REBOOT

        HV_SAFE_REBOOT:
          prompt: |
            âœ… *Safe recovery first (do this once, cleanly)*
            1) Confirm: no smoke/heat/water ingress
            2) Controlled reboot or full power cycle
            3) Note the *first* fault/message that returns (root clue)
          options:
            - label: "Recovered âœ…"
              next: HV_DONE_RESOLVED
            - label: "Still failing"
              next: HV_VISUAL

        HV_VISUAL:
          prompt: |
            ğŸ‘€ *Visual checks (non-invasive)*
            - Burnt smell / discoloration / melted insulation?
            - Water ingress / wet marks?
            - Harness strain / loose external connectors?
          options:
            - label: "ğŸ”¥ Unsafe condition found"
              next: HV_ESC_UNSAFE
            - label: "Looks OK"
              next: HV_SUPPLY_GATE

        HV_SUPPLY_GATE:
          prompt: |
            âš¡ *Supply sanity check*
            Any upstream trip, undervoltage/phase loss alarm, or known site instability?
          options:
            - label: "Yes â€” supply issue suspected"
              next: HV_SUPPLY_ACTIONS
            - label: "No / unknown"
              next: HV_INTERLOCK_GATE

        HV_SUPPLY_ACTIONS:
          prompt: |
            *Supply actions (safe-first)*
            - Check upstream breaker/isolator
            - If authorised: confirm L-L voltages present and not sagging badly at enable
            - Stabilise supply before deeper charger work
          options:
            - label: "Supply corrected â†’ retry"
              next: HV_SAFE_REBOOT
            - label: "Supply seems OK â†’ continue"
              next: HV_INTERLOCK_GATE
            - label: "Canâ€™t verify â†’ evidence pack"
              next: HV_EVIDENCE

        HV_INTERLOCK_GATE:
          prompt: |
            â¬› *Interlock / HVIL gate*
            If any interlock is open, HV start will be inhibited. Clear this before chasing power-stage parts.
          options:
            - label: "Interlock cleared â†’ retry"
              next: HV_SAFE_REBOOT
            - label: "Interlock wonâ€™t clear"
              next: HV_EVIDENCE

        HV_ISO_GATE:
          prompt: |
            ğŸŸª *Isolation / Earth leakage gate (high risk)*
            Treat as safety critical:
            - Avoid repeated start attempts
            - Inspect connector face + cabinet for moisture/contamination/burn marks
            - If repeatable: tag out the port and escalate
          options:
            - label: "Continue â¡ï¸"
              next: HV_ISO_ACTIONS

        HV_ISO_ACTIONS:
          prompt: |
            *Isolation actions*
            - Record exact IMD/RCM/RCD message + timestamp
            - Inspect connector face (water/debris/burn marks)
            - Note weather / rain / washdown / flooding
          options:
            - label: "Evidence pack"
              next: HV_EVIDENCE
            - label: "Back to General DC menu"
              next: "__MENU_GENERAL_DC__"

        HV_DC_BUS_OV:
          prompt: |
            ğŸŸ§ *DC bus overvoltage*
            Do NOT repeatedly retry. Capture evidence and escalate.
          options:
            - label: "Evidence pack"
              next: HV_EVIDENCE
            - label: "Back to General DC menu"
              next: "__MENU_GENERAL_DC__"

        HV_EVIDENCE:
          prompt: |
            ğŸ—‚ï¸ *Evidence pack (fast escalation)*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Any supply alarms / measured L-L (if taken)
            - Interlock/HVIL status (if shown)
            - IMD/RCM/RCD status (if shown)
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: HV_ESC
            - label: "Back to General DC menu"
              next: "__MENU_GENERAL_DC__"

        HV_ESC_UNSAFE:
          prompt: |
            *âš ï¸ Escalate immediately â€” unsafe condition*
            Do NOT re-energise.
            Provide photos + what you observed (smell/heat/water ingress).
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        HV_ESC:
          prompt: |
            *Escalate â€” General DC HV Enable / Start Inhibit*
            Include:
            - Exact code/text + timestamps
            - State: start fails vs clicks then faults
            - Supply notes (alarms / measured L-L if available)
            - Interlock/HVIL + IMD/RCM/RCD status
            - Actions taken (reboot/power cycle)
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        HV_DONE_RESOLVED:
          prompt: |
            âœ… *Resolved*
            HV start restored. Run a short test session and confirm no recurrence.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # (2) GOLD STANDARD CLUSTER: Power Modules Offline / Derating
  # Canonical flow for:
  # - Reduced kW / derate
  # - Module offline / rectifier fault
  # - Power stack imbalance / output instability
  # ============================================================

  - id: general_dc_power_module_cluster
    platform: general_dc
    charger_type: dc
    title: "Power Modules Offline / Derating (Reduced kW / Rectifier)"
    severity: high
    tags: [power_module, derate, rectifier, reduced_kw, cooling, module_offline]

    aliases:
      - "derating"
      - "reduced power"
      - "reduced kw"
      - "module offline"
      - "rectifier fault"
      - "power module fault"
      - "stack fault"
      - "power stage derate"

    triggers:
      any_text_contains:
        - "derate"
        - "derating"
        - "reduced power"
        - "reduced kw"
        - "module offline"
        - "rectifier"
        - "power module"
        - "stack fault"
        - "power module fault"

    description: >
      Charger can often still operate but with reduced kW when modules are offline or thermally/electrically limited.
      Goal is to: (1) identify scope (one module vs many), (2) do safe recovery (cycle), (3) check cooling basics,
      (4) reseat/swap only if authorised, and (5) record derate level + stability.

    safety_notes:
      - LOTO before cabinet access and any reseat/swap activity
      - Do not repeatedly reset tripsâ€”identify cause
      - If burning smell/heat/water ingress: stop and escalate

    decision_tree:
      start_node: PM0
      nodes:

        PM0:
          prompt: |
            ğŸ§© *Power Modules Offline / Derating â€” Start*
            What are you seeing?
          options:
            - label: "âš ï¸ Charging but reduced kW"
              next: PM_SCOPE
            - label: "ğŸš« Charger unavailable (many modules offline)"
              next: PM_SCOPE
            - label: "ğŸ” I have a module/rectifier alarm"
              next: PM_SCOPE

        PM_SCOPE:
          prompt: |
            *Scope*
            Is it clearly one cabinet/module, or multiple/unclear?
          options:
            - label: "One module/cabinet"
              next: PM_SAFE_GATE
            - label: "Multiple / unclear"
              next: PM_SAFE_GATE

        PM_SAFE_GATE:
          prompt: |
            âœ… *Safety gate*
            - LOTO if opening cabinet
            - If heat/smell/smoke/water ingress: stop and escalate
          options:
            - label: "Continue â¡ï¸"
              next: PM_POWER_CYCLE

        PM_POWER_CYCLE:
          prompt: |
            ğŸ” *Controlled power cycle*
            Power cycle once, then note what changed (which alarms remain).
          options:
            - label: "Recovered (normal output) âœ…"
              next: PM_DONE_RESOLVED
            - label: "Recovered but still derated âš ï¸"
              next: PM_DERATE_RECORD
            - label: "Still faulting"
              next: PM_COOLING

        PM_COOLING:
          prompt: |
            ğŸŸ« *Cooling basics (highest yield)*
            Check airflow, filters, fan operation, ventilation around cabinet.
          options:
            - label: "Cooling issue found & corrected â†’ retest"
              next: PM_POWER_CYCLE
            - label: "Cooling seems OK / not sure"
              next: PM_RESEAT_GATE

        PM_RESEAT_GATE:
          prompt: |
            *Reseat/swap (authorised only)*
            Are you authorised to reseat or swap modules?
          options:
            - label: "Yes â€” authorised"
              next: PM_RESEAT
            - label: "No â€” not authorised"
              next: PM_EVIDENCE

        PM_RESEAT:
          prompt: |
            *Reseat / connector inspection*
            - LOTO
            - Reseat suspected module connectors
            - Inspect pins for burn/bend/contamination
          options:
            - label: "ğŸ”¥ Damage found"
              next: PM_ESC_UNSAFE
            - label: "Reseated â†’ retest"
              next: PM_POWER_CYCLE
            - label: "No change"
              next: PM_SWAP

        PM_SWAP:
          prompt: |
            ğŸ§© *Swap test (if allowed)*
            Move suspected module to another slot and see if fault follows.
          options:
            - label: "Fault follows module"
              next: PM_REPLACE_MODULE
            - label: "Fault stays with slot/backplane"
              next: PM_SLOT_ISSUE
            - label: "Canâ€™t swap"
              next: PM_EVIDENCE

        PM_DERATE_RECORD:
          prompt: |
            âš ï¸ *Derated but operating*
            Record:
            - Delivered kW and whether stable/fluctuating
            - Which cabinet/module indicated (if any)
            Then decide: accept temporary derate or escalate for module service.
          options:
            - label: "Accept derate (document + monitor)"
              next: PM_DONE_STABILISED
            - label: "Evidence pack"
              next: PM_EVIDENCE

        PM_EVIDENCE:
          prompt: |
            ğŸ—‚ï¸ *Evidence pack â€” Derating / Modules*
            Capture:
            - Exact alarm text + timestamp
            - Delivered kW (stable/fluctuating)
            - Any cabinet/module/slot indicator
            - Cooling condition notes
            - Actions taken (cycle/reseat/swap)
          options:
            - label: "Escalate"
              next: PM_ESC
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        PM_ESC_UNSAFE:
          prompt: |
            *âš ï¸ Escalate â€” unsafe condition*
            Do NOT re-energise. Provide photos of damage/burn/water ingress.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        PM_ESC:
          prompt: |
            *Escalate â€” Power Modules Offline / Derating*
            Include evidence pack + whether fault follows a module or stays with slot/backplane.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        PM_REPLACE_MODULE:
          prompt: |
            âœ… *Fault follows module*
            Likely module failure. Replace per OEM procedure and retest.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        PM_SLOT_ISSUE:
          prompt: |
            ğŸ§© *Fault stays with slot/backplane*
            Likely harness/backplane/controller-side issue. Escalate with photos + evidence.
          options:
            - label: "Evidence pack"
              next: PM_EVIDENCE
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        PM_DONE_RESOLVED:
          prompt: |
            âœ… *Resolved*
            Normal output restored. Confirm stability (no immediate re-fault).
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        PM_DONE_STABILISED:
          prompt: |
            âš ï¸ *Stabilised (Derated)*
            Charger operates but reduced power. Plan follow-up if derate persists.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # (3) GOLD STANDARD CLUSTER: Offline / Backend / OCPP / Network
  # Canonical flow for:
  # - Offline / no backend
  # - OCPP errors
  # - Ethernet/LTE issues
  # - Intermittent comms
  # ============================================================

  - id: general_dc_comms_offline_cluster
    platform: general_dc
    charger_type: dc
    title: "Offline / Backend / OCPP / Network (Ethernet/LTE)"
    severity: high
    tags: [ocpp, backend, network, ethernet, lte, modem, offline]

    aliases:
      - "ocpp offline"
      - "backend offline"
      - "server offline"
      - "charger offline"
      - "network error"
      - "no communication"
      - "communication fault"
      - "websocket"
      - "tls handshake"

    triggers:
      any_text_contains:
        - "ocpp"
        - "offline"
        - "backend"
        - "server"
        - "network"
        - "no communication"
        - "communication fault"
        - "websocket"
        - "handshake"
        - "tls"
        - "ethernet"
        - "lte"
        - "modem"
        - "sim"

    description: >
      Treat comms as a layered problem: site-wide vs single unit â†’ controlled reboot â†’ physical layer checks
      (Ethernet link/ports/cable OR LTE antenna/SIM) â†’ evidence pack. Escalate quickly when you lack visibility.

    safety_notes:
      - Most checks are low risk and can be done without HV compartment access
      - Follow ESD precautions if accessing comms hardware

    decision_tree:
      start_node: CO0
      nodes:

        CO0:
          prompt: |
            ğŸŒ *Offline / Backend / OCPP â€” Start*
            Is it only this charger, or multiple chargers/site affected?
          options:
            - label: "Multiple chargers / site-wide issue likely"
              next: CO_SITE
            - label: "Only this charger"
              next: CO_REBOOT
            - label: "Not sure"
              next: CO_REBOOT

        CO_SITE:
          prompt: |
            *Site-wide comms likely*
            - Check site router/modem power
            - Check WAN status (if known)
            - Capture timestamps + site notes
          options:
            - label: "After site checks â†’ reboot this charger"
              next: CO_REBOOT
            - label: "Evidence pack"
              next: CO_EVIDENCE

        CO_REBOOT:
          prompt: |
            *Controlled reboot / power cycle*
            Reboot and allow time for registration + OCPP handshake.
          options:
            - label: "Recovered (online) âœ…"
              next: CO_DONE
            - label: "Still offline"
              next: CO_LINK_TYPE

        CO_LINK_TYPE:
          prompt: |
            *Connection type*
            Whatâ€™s in use?
          options:
            - label: "ğŸ“¶ Cellular/LTE"
              next: CO_LTE
            - label: "ğŸ”Œ Ethernet"
              next: CO_ETH
            - label: "â“ Not sure"
              next: CO_EVIDENCE

        CO_LTE:
          prompt: |
            *LTE checks*
            - Antenna seated/tight, cable not damaged
            - If accessible: observe modem/TCU LEDs (power/status/network)
            - If permitted: reseat SIM, confirm APN profile
          options:
            - label: "Retest (reboot)"
              next: CO_REBOOT
            - label: "Evidence pack"
              next: CO_EVIDENCE

        CO_ETH:
          prompt: |
            *Ethernet checks*
            - Link lights present at charger/switch?
            - Reseat cable ends
            - Try alternate port/cable (if permitted)
          options:
            - label: "Retest (reboot)"
              next: CO_REBOOT
            - label: "Evidence pack"
              next: CO_EVIDENCE

        CO_EVIDENCE:
          prompt: |
            ğŸ—‚ï¸ *Evidence pack â€” Comms/Backend*
            Capture:
            - Offline message + timestamp
            - Connection type (LTE/Ethernet/unknown)
            - Link lights / signal strength / LED states (if known)
            - Actions taken (reboot/cables/antenna/SIM/APN)
          options:
            - label: "Escalate"
              next: CO_ESC
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        CO_ESC:
          prompt: |
            *Escalate â€” Offline/Backend/OCPP*
            Include evidence pack + last known online time (if known).
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        CO_DONE:
          prompt: |
            âœ… *Recovered*
            Confirm stability (no repeated dropouts).
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # (4) Cooling / Overtemperature (lightweight but useful)
  # ============================================================

  - id: general_dc_overtemp_cooling_fault
    platform: general_dc
    charger_type: dc
    title: "Overtemperature / Cooling Fault"
    severity: high
    tags: [cooling, overtemp, fans, filters, airflow]

    aliases:
      - "overtemp"
      - "over temperature"
      - "thermal fault"
      - "fan fault"
      - "cooling fault"

    triggers:
      any_text_contains:
        - "overtemp"
        - "over temperature"
        - "thermal"
        - "fan fault"
        - "cooling"
        - "temperature high"

    description: >
      Fastest wins are airflow and filters, then fan operation. If it persists, capture evidence and escalate.

    decision_tree:
      start_node: TH0
      nodes:

        TH0:
          prompt: |
            ğŸŸ« *Overtemperature / Cooling â€” Start*
            First: airflow and filters.
          options:
            - label: "Continue â¡ï¸"
              next: TH1

        TH1:
          prompt: |
            *Filters/vents blocked?*
            Inspect filters/vents for dust blockage and cabinet airflow.
          options:
            - label: "Yes â€” blocked/dirty"
              next: TH_FIX_FILTERS
            - label: "No â€” looks OK"
              next: TH2

        TH_FIX_FILTERS:
          prompt: |
            *Clean/replace filters*
            Clean/replace filters then retest under load.
          options:
            - label: "Retest"
              next: TH2

        TH2:
          prompt: |
            *Fan check*
            Confirm fans are operating and unobstructed.
          options:
            - label: "Fans OK"
              next: TH_DONE_OR_ESC
            - label: "Fan not running / blocked"
              next: TH_FIX_FANS

        TH_FIX_FANS:
          prompt: |
            *Fix fan issue*
            Clear obstruction, check fan connector/power, replace fan if failed. Then retest.
          options:
            - label: "Retest"
              next: TH_DONE_OR_ESC

        TH_DONE_OR_ESC:
          prompt: |
            Did the fault clear after airflow/fan actions?
          options:
            - label: "Cleared âœ…"
              next: TH_DONE
            - label: "Still faulting"
              next: TH_EVIDENCE

        TH_EVIDENCE:
          prompt: |
            ğŸ—‚ï¸ *Evidence pack â€” Cooling*
            Capture: ambient temp, filter condition, fan status, timestamps, and any thermal readings shown.
          options:
            - label: "Escalate"
              next: TH_ESC
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        TH_ESC:
          prompt: |
            *Escalate â€” Overtemperature/Cooling*
            Include evidence pack + whether it occurs immediately or only under load.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        TH_DONE:
          prompt: |
            âœ… *Resolved*
            Run a short test session and confirm no recurrence.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # (5) Electrical Safety / Earth Leakage / Isolation (strict)
  # ============================================================

  - id: general_dc_safety_earth_leakage_fault
    platform: general_dc
    charger_type: dc
    title: "Electrical Safety Fault (Earth Leakage / Isolation / IMD/RCM/RCD)"
    severity: critical
    tags: [safety, earth_leakage, insulation, isolation, imd, rcm, rcd, moisture]

    aliases:
      - "earth leakage"
      - "rcd tripped"
      - "rcm tripped"
      - "imd fault"
      - "isolation fault"
      - "insulation fault"
      - "ground fault"
      - "safety fault"

    triggers:
      any_text_contains:
        - "earth leakage"
        - "ground fault"
        - "rcd"
        - "rcm"
        - "imd"
        - "isolation"
        - "insulation"
        - "safety fault"

    description: >
      Treat as safety critical. Avoid repeated attempts. Check for moisture/contamination and capture evidence for escalation.

    decision_tree:
      start_node: SF0
      nodes:

        SF0:
          prompt: |
            ğŸŸª *Electrical Safety â€” Start (High risk)*
            Any evidence of moisture/water ingress or recent rain/washdown?
          options:
            - label: "Yes / likely"
              next: SF1
            - label: "No / unsure"
              next: SF1

        SF1:
          prompt: |
            *Immediate actions*
            - Avoid repeated start attempts
            - Inspect connector face for water/debris/burn marks
            - Inspect cabinet exterior for water paths
          options:
            - label: "Evidence pack"
              next: SF_EVIDENCE
            - label: "Back to General DC menu"
              next: "__MENU_GENERAL_DC__"

        SF_EVIDENCE:
          prompt: |
            ğŸ—‚ï¸ *Evidence pack â€” Safety*
            Capture:
            - Exact alarm text + timestamp
            - Weather/moisture notes
            - Photos of connector face and any moisture marks
            - Whether fault is repeatable across EVs/ports
          options:
            - label: "Escalate"
              next: SF_ESC
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"

        SF_ESC:
          prompt: |
            *Escalate â€” Electrical Safety*
            Do not re-energise if any burning smell/heat/water ingress is present.
            Include evidence pack.
          options:
            - label: "General DC menu"
              next: "__MENU_GENERAL_DC__"


  # ============================================================
  # ROUTERS (IDs stay stable; route into canonical clusters)
  # ============================================================

  - id: general_dc_ac_contactor_fault_routed
    platform: general_dc
    charger_type: dc
    title: "AC Contactor Fault â€” Routed (Use HV Enable Cluster)"
    severity: high
    tags: [routed, ac_contactor, hv_enable, start_inhibit]

    aliases:
      - "ac contactor fault"
      - "input contactor fault"
      - "mains contactor fault"
      - "input relay fault"

    triggers:
      any_text_contains:
        - "ac contactor"
        - "input contactor"
        - "mains contactor"
        - "input relay"

    description: >
      Routed: AC contactor issues typically block HV enable and share root causes with start sequence gates
      (supply stability â†’ interlock/HVIL â†’ isolation â†’ reboot-first-fault). Use the canonical cluster.

    decision_tree:
      start_node: R1
      nodes:
        R1:
          prompt: |
            âš¡ *AC Contactor Fault â€” Routed*
            Open:
            *HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)*
            and follow the symptom-first gates.
          options:
            - label: "ğŸ  General DC menu (open HV Enable cluster)"
              next: "__MENU_GENERAL_DC__"


  - id: general_dc_dc_contactor_fault_routed
    platform: general_dc
    charger_type: dc
    title: "DC/Output Contactor Fault â€” Routed (Use HV Enable Cluster)"
    severity: high
    tags: [routed, dc_contactor, hv_enable, start_inhibit]

    aliases:
      - "dc contactor fault"
      - "output contactor fault"
      - "failed to close"
      - "verify failed"
      - "welded contactor"

    triggers:
      any_text_contains:
        - "dc contactor"
        - "output contactor"
        - "failed to close"
        - "verify failed"
        - "welded"

    description: >
      Routed: Contactor faults are part of the HV enable sequence. Use the canonical HV Enable / Start Inhibit cluster.

    decision_tree:
      start_node: R2
      nodes:
        R2:
          prompt: |
            âš¡ *DC/Output Contactor Fault â€” Routed*
            Open:
            *HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)*
            and follow supply â†’ interlock â†’ isolation â†’ evidence.
          options:
            - label: "ğŸ  General DC menu (open HV Enable cluster)"
              next: "__MENU_GENERAL_DC__"


  - id: general_dc_precharge_fault_routed
    platform: general_dc
    charger_type: dc
    title: "Precharge Fault / DC Bus Not Ready â€” Routed (Use HV Enable Cluster)"
    severity: critical
    tags: [routed, precharge, dc_bus, hv_enable]

    aliases:
      - "precharge fault"
      - "pre-charge fault"
      - "dc bus not ready"
      - "dc bus undervoltage"

    triggers:
      any_text_contains:
        - "precharge"
        - "pre-charge"
        - "dc bus not ready"
        - "bus not ready"
        - "bus undervoltage"

    description: >
      Routed: Precharge/DC bus faults are the HV start sequence. Use the canonical HV Enable / Start Inhibit cluster.

    decision_tree:
      start_node: R3
      nodes:
        R3:
          prompt: |
            âš¡ *Precharge / DC Bus â€” Routed*
            Open:
            *HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)*
            and follow the symptom-first gates.
          options:
            - label: "ğŸ  General DC menu (open HV Enable cluster)"
              next: "__MENU_GENERAL_DC__"


  - id: general_dc_internal_power_fault_routed
    platform: general_dc
    charger_type: dc
    title: "Internal Power Fault / Start Failed â€” Routed (Use HV Enable Cluster)"
    severity: critical
    tags: [routed, internal_power, start_failed, hv_enable]

    aliases:
      - "internal power fault"
      - "internal fault"
      - "start failed"
      - "start inhibited"

    triggers:
      any_text_contains:
        - "internal power"
        - "internal fault"
        - "start failed"
        - "start inhibited"

    description: >
      Routed: Generic internal/start faults resolve fastest through the canonical gate sequence. Use the HV Enable cluster.

    decision_tree:
      start_node: R4
      nodes:
        R4:
          prompt: |
            âš¡ *Internal Power / Start Failed â€” Routed*
            Open:
            *HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)*
            and use reboot-first-fault + evidence pack for escalation.
          options:
            - label: "ğŸ  General DC menu (open HV Enable cluster)"
              next: "__MENU_GENERAL_DC__"


  - id: general_dc_rectifier_fault_routed
    platform: general_dc
    charger_type: dc
    title: "Rectifier / Power Module Fault â€” Routed (Use Power Module Cluster)"
    severity: high
    tags: [routed, rectifier, power_module, derate]

    aliases:
      - "rectifier fault"
      - "power module fault"
      - "module offline"
      - "stack fault"
      - "derate"

    triggers:
      any_text_contains:
        - "rectifier"
        - "power module"
        - "module offline"
        - "stack fault"
        - "derate"

    description: >
      Routed: Rectifier/module alarms are handled best via the Power Modules Offline / Derating cluster.

    decision_tree:
      start_node: R5
      nodes:
        R5:
          prompt: |
            ğŸ§© *Rectifier / Power Module â€” Routed*
            Open:
            *Power Modules Offline / Derating (Reduced kW / Rectifier)*
            and follow scope â†’ cycle â†’ cooling â†’ authorised reseat/swap â†’ evidence.
          options:
            - label: "ğŸ  General DC menu (open Power Module cluster)"
              next: "__MENU_GENERAL_DC__"


  - id: general_dc_backend_offline_routed
    platform: general_dc
    charger_type: dc
    title: "Backend / OCPP Offline â€” Routed (Use Offline/Network Cluster)"
    severity: high
    tags: [routed, ocpp, backend, offline, network]

    aliases:
      - "ocpp offline"
      - "backend offline"
      - "server offline"
      - "charger offline"

    triggers:
      any_text_contains:
        - "ocpp"
        - "backend offline"
        - "server offline"
        - "charger offline"
        - "offline to backend"

    description: >
      Routed: Backend/offline issues are handled via the Offline / Backend / OCPP / Network cluster.

    decision_tree:
      start_node: R6
      nodes:
        R6:
          prompt: |
            ğŸŒ *Backend / OCPP Offline â€” Routed*
            Open:
            *Offline / Backend / OCPP / Network (Ethernet/LTE)*
            and follow site-wide vs single â†’ reboot â†’ physical layer â†’ evidence.
          options:
            - label: "ğŸ  General DC menu (open Offline/Network cluster)"
              next: "__MENU_GENERAL_DC__"
