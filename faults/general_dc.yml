# general_dc.yml
# EVBot Fault Pack: General DC Charger (All Brands) ‚Äî On-site Technician v1 (Jan 2026)
# Purpose:
# - OEM-agnostic fault library for common DC fast charger issues across all manufacturers
# - Node-based decision trees: start_node + nodes map
# - Safe, field-ready steps with strong emphasis on isolation/LV checks before HV work
#
# Notes:
# - platform: general_dc
# - Keep IDs stable so your bot can deep-link (e.g., /general_dc will_not_power_on)
# - You can add images later (optional) using:
#     image: general_dc/<filename_without_extension>
#   and store files at:
#     assets/images/general_dc/<filename>.png

faults:

  - id: general_dc_will_not_power_on
    platform: general_dc
    charger_type: dc
    title: "Will Not Power On (Dead / No Display)"
    aliases:
      - "no power"
      - "dead"
      - "blank screen"
      - "won't turn on"
      - "no display"
    triggers:
      any_text_contains:
        - "no power"
        - "dead"
        - "blank screen"
        - "no display"
        - "won't power on"
        - "will not power on"
    severity: high
    tags: [power, supply, breaker, interlock, control_power]
    start_node: safety_first
    nodes:
      safety_first:
        prompt: "Safety first: is the site safe to troubleshoot and can you apply LOTO if opening cabinets?"
        options:
          "‚úÖ Yes": check_upstream_supply
          "‚ùå No / Not sure": stop_and_escalate

      stop_and_escalate:
        prompt: "Do not proceed. Make the area safe, apply isolation, and escalate per procedure."
        actions:
          - "Follow site isolation and SWMS/JSA requirements"
          - "Escalate to supervisor/OEM if you cannot isolate safely"
        next: end

      check_upstream_supply:
        prompt: "Is upstream supply available (breaker/isolator ON) and correct AC voltage present at charger incomer?"
        options:
          "‚ùå No (breaker tripped / isolator OFF / missing voltage)": restore_supply
          "‚úÖ Yes (voltage confirmed)": check_e_stop_interlocks

      restore_supply:
        prompt: "Restore supply if permitted and safe."
        actions:
          - "Check upstream breaker/RCBO and reset if safe"
          - "Verify isolator position"
          - "Measure phase-to-phase and phase-to-neutral as applicable"
          - "If breaker trips again, do NOT keep resetting‚Äîinvestigate cause"
        next: check_e_stop_interlocks

      check_e_stop_interlocks:
        prompt: "Are Emergency Stop / door interlocks / site interlocks active?"
        options:
          "‚úÖ Active (E-stop pressed / door open / interlock open)": clear_interlocks
          "‚ùå Not active": check_control_power

      clear_interlocks:
        prompt: "Clear interlocks and re-test power-up."
        actions:
          - "Reset E-stop(s) (including remote E-stops if present)"
          - "Close and latch cabinet doors"
          - "Check fire alarm / site interlock input if applicable"
        next: check_control_power

      check_control_power:
        prompt: "Is control power present (e.g., 24V/12V) and controller LEDs/status normal?"
        options:
          "‚úÖ Yes (control power OK)": attempt_power_cycle
          "‚ùå No / unstable": inspect_aux_psu

      inspect_aux_psu:
        prompt: "Aux/control PSU may be failed or supply to it is missing."
        actions:
          - "Check internal fuses feeding control PSU"
          - "Check LV PSU output rails if accessible and permitted"
          - "Look for burnt smell, discoloration, loose LV terminals"
        next: end

      attempt_power_cycle:
        prompt: "Perform a full power cycle (de-energize long enough for capacitors to discharge) then re-test."
        actions:
          - "Power OFF at upstream isolator (LOTO if opening)"
          - "Wait per OEM guidance (commonly 2‚Äì5 minutes)"
          - "Power ON and observe boot sequence / alarms"
        next: end


  - id: general_dc_powers_on_wont_start_charge
    platform: general_dc
    charger_type: dc
    title: "Powers On but Won‚Äôt Start Charging"
    aliases:
      - "won't start"
      - "cannot start charge"
      - "start failed"
      - "session won't begin"
      - "plug in but won't charge"
    triggers:
      any_text_contains:
        - "won't start charging"
        - "won‚Äôt start charging"
        - "cannot start"
        - "start failed"
        - "session won't start"
        - "plugged in but won't charge"
    severity: high
    tags: [session, authorisation, contactor, precharge, handshake]
    start_node: confirm_basics
    nodes:
      confirm_basics:
        prompt: "Confirm basics: connector fully latched, correct connector selected, and charger shows 'Ready'?"
        options:
          "‚úÖ Yes": try_known_good_vehicle
          "‚ùå No": fix_basic_issue

      fix_basic_issue:
        prompt: "Resolve basic readiness issues."
        actions:
          - "Reseat connector and ensure latch engaged"
          - "Try alternate connector (if available)"
          - "Confirm charger is not in 'Fault' or 'E-stop' state"
        next: try_known_good_vehicle

      try_known_good_vehicle:
        prompt: "Have you tried a known-good vehicle and a second connector (if available)?"
        options:
          "‚úÖ Yes (still fails)": check_authorisation
          "‚ùå No": do_vehicle_swap

      do_vehicle_swap:
        prompt: "Test with a known-good vehicle (or different EV) to isolate vehicle-side issues."
        actions:
          - "Try a second EV if available"
          - "Try a second connector/plug (if dual/tri-head)"
        next: check_authorisation

      check_authorisation:
        prompt: "Is this a backend/RFID/app authorisation site (not free-vend)?"
        options:
          "‚úÖ Yes": check_backend_signals
          "‚ùå No / Free-vend": check_charger_faults

      check_backend_signals:
        prompt: "Do you see payment/app/RFID errors, or 'Authorisation failed' messages?"
        options:
          "‚úÖ Yes": backend_checks
          "‚ùå No": check_charger_faults

      backend_checks:
        prompt: "Backend checks (no OEM tools required)."
        actions:
          - "Confirm charger is online/connected (modem/Ethernet up)"
          - "Check site connectivity / signal strength"
          - "Confirm correct site tariff/tenant config (if known)"
          - "Capture exact on-screen error + timestamp for backend support"
        next: check_charger_faults

      check_charger_faults:
        prompt: "Does the charger show a fault that blocks start (e.g., isolation, contactor, precharge, overtemp)?"
        options:
          "‚úÖ Yes": route_by_fault_type
          "‚ùå No obvious fault": attempt_soft_reset

      route_by_fault_type:
        prompt: "Pick the closest fault type shown."
        options:
          "üü™ Insulation / Earth fault": goto_isolation_fault
          "‚¨õ E-stop / Interlock": goto_interlock_fault
          "üü´ Overtemp / Cooling": goto_overtemp_fault
          "üü¶ Handshake / Vehicle comms": goto_handshake_fault
          "üü• Contactor / Precharge / HV": hv_block_fault

      hv_block_fault:
        prompt: "HV start blocked (contactor/precharge). Perform safe, non-invasive checks first."
        actions:
          - "Power cycle the charger (full restart)"
          - "Inspect for burnt smell, discoloration, loose terminations (visual only unless authorised)"
          - "If modular: reseat accessible modules/connectors only if permitted and isolated"
          - "Escalate with fault code + timestamp if persists"
        next: end

      attempt_soft_reset:
        prompt: "Try a controlled restart and re-test."
        actions:
          - "Reboot via HMI/service menu if available"
          - "If not: full power cycle at isolator (per procedure)"
          - "Re-test session start"
        next: end

      goto_isolation_fault:
        prompt: "Go to: 'Insulation / Earth Fault' fault pack item."
        next: end

      goto_interlock_fault:
        prompt: "Go to: 'Emergency Stop / Safety Interlock Active' fault pack item."
        next: end

      goto_overtemp_fault:
        prompt: "Go to: 'Overtemperature / Cooling Fault' fault pack item."
        next: end

      goto_handshake_fault:
        prompt: "Go to: 'Vehicle Connection / Handshake Failure' fault pack item."
        next: end


  - id: general_dc_offline_backend_comms
    platform: general_dc
    charger_type: dc
    title: "Offline / Backend Comms Down (OCPP / LTE / Ethernet)"
    aliases:
      - "offline"
      - "ocpp offline"
      - "backend down"
      - "no communication"
      - "modem offline"
      - "network down"
    triggers:
      any_text_contains:
        - "offline"
        - "ocpp"
        - "no comms"
        - "no communication"
        - "backend offline"
        - "modem offline"
        - "network"
        - "ethernet"
        - "sim"
    severity: high
    tags: [comms, ocpp, modem, ethernet, sim, apn]
    start_node: identify_link_type
    nodes:
      identify_link_type:
        prompt: "What connection type is in use?"
        options:
          "üì∂ Cellular/LTE (SIM modem)": lte_checks
          "üîå Ethernet": ethernet_checks
          "‚ùì Not sure": generic_comms_checks

      generic_comms_checks:
        prompt: "Do basic comms checks."
        actions:
          - "Check HMI for 'Offline' / comms alarms"
          - "Verify router/modem has power and indicators"
          - "Power cycle comms equipment first, then charger controller"
          - "Capture error text + timestamp"
        next: end

      lte_checks:
        prompt: "LTE checks: do modem LEDs show power + network connection?"
        options:
          "‚úÖ Yes (appears connected)": apn_backend_checks
          "‚ùå No (no signal / no network)": sim_signal_checks

      sim_signal_checks:
        prompt: "SIM/signal checks."
        actions:
          - "Check antenna connections"
          - "Confirm SIM seated (if accessible and permitted)"
          - "Check signal strength on HMI (if available)"
          - "Move/inspect antenna for damage"
        next: reboot_sequence

      apn_backend_checks:
        prompt: "If connected but still offline, likely APN/backend config or server issue."
        actions:
          - "Confirm APN settings (if accessible)"
          - "Check if other chargers on site are also offline"
          - "Escalate to backend team with charger ID + ICCID/IMEI + timestamp"
        next: reboot_sequence

      ethernet_checks:
        prompt: "Ethernet checks: link lights present at switch/port?"
        options:
          "‚úÖ Yes": ip_backend_checks
          "‚ùå No": physical_ethernet_checks

      physical_ethernet_checks:
        prompt: "Restore physical Ethernet link."
        actions:
          - "Reseat Ethernet at charger + switch"
          - "Inspect cable for damage"
          - "Try alternate switch port/cable if permitted"
        next: reboot_sequence

      ip_backend_checks:
        prompt: "If link is up but still offline, suspect IP/DHCP/firewall/backend."
        actions:
          - "Confirm site network is up (ask site / check router)"
          - "If permitted, confirm DHCP lease / IP settings on charger"
          - "Escalate with charger MAC/IP (if available) + timestamp"
        next: reboot_sequence

      reboot_sequence:
        prompt: "Perform controlled reboot order."
        actions:
          - "Reboot modem/router first"
          - "Then reboot charger controller/HMI"
          - "Wait for reconnect (several minutes) and re-check status"
        next: end


  - id: general_dc_vehicle_handshake_failure
    platform: general_dc
    charger_type: dc
    title: "Vehicle Connection / Handshake Failure (Plugged In but No Start)"
    aliases:
      - "handshake failed"
      - "communication error"
      - "vehicle not detected"
      - "cp pp fault"
      - "plug error"
    triggers:
      any_text_contains:
        - "handshake"
        - "vehicle not detected"
        - "communication error"
        - "plug error"
        - "connector fault"
        - "cp"
        - "pp"
    severity: medium
    tags: [handshake, connector, cable, cp, pp]
    start_node: inspect_connector
    nodes:
      inspect_connector:
        prompt: "Inspect connector and cable: any bent pins, debris, water, burn marks, damaged latch?"
        options:
          "‚úÖ Looks OK": reseat_and_retry
          "‚ùå Damage/contamination found": clean_or_isolate

      clean_or_isolate:
        prompt: "If contamination or damage is present, do not force operation."
        actions:
          - "If safe: dry/clean external debris only (no solvents unless approved)"
          - "If pins are burnt/bent or water ingress suspected: take out of service and escalate"
          - "Capture clear photos for report"
        next: end

      reseat_and_retry:
        prompt: "Reseat connector firmly and ensure latch engages. Try again."
        options:
          "‚úÖ Session starts": end_success
          "‚ùå Still fails": try_other_connector_or_ev

      try_other_connector_or_ev:
        prompt: "Try another connector (if available) or a known-good EV."
        options:
          "‚úÖ Works on other connector/EV": likely_local_issue
          "‚ùå Fails on all": check_interlocks_and_faults

      likely_local_issue:
        prompt: "Issue is likely connector/cable-specific or vehicle-specific."
        actions:
          - "Tag faulty connector/cable for repair if repeatable"
          - "Document which EV/connector combinations fail"
        next: end

      check_interlocks_and_faults:
        prompt: "Any safety interlock, insulation, or fault message shown on HMI?"
        options:
          "‚¨õ Interlock/E-stop": goto_interlock_fault
          "üü™ Insulation/Earth fault": goto_isolation_fault
          "üü• Other fault shown": capture_and_escalate
          "‚ùì No fault shown": reboot_and_retry

      reboot_and_retry:
        prompt: "Perform a controlled reboot and retry handshake."
        actions:
          - "Reboot HMI/controller"
          - "If still failing: full power cycle per procedure"
          - "Re-test with known-good EV"
        next: end

      capture_and_escalate:
        prompt: "Capture the exact message/code and escalate."
        actions:
          - "Record error code/text, timestamp, and EV model"
          - "Take photo of HMI fault screen"
        next: end

      goto_interlock_fault:
        prompt: "Go to: 'Emergency Stop / Safety Interlock Active' fault pack item."
        next: end

      goto_isolation_fault:
        prompt: "Go to: 'Insulation / Earth Fault' fault pack item."
        next: end

      end_success:
        prompt: "Handshake successful and session started."
        next: end


  - id: general_dc_insulation_earth_fault
    platform: general_dc
    charger_type: dc
    title: "Insulation / Earth Fault (RCD/IMD/Isolation Alarm)"
    aliases:
      - "insulation fault"
      - "earth fault"
      - "isolation fault"
      - "imd fault"
      - "rcd trip"
    triggers:
      any_text_contains:
        - "insulation"
        - "earth fault"
        - "isolation fault"
        - "imd"
        - "rcd"
        - "ground fault"
    severity: high
    tags: [safety, insulation, imd, moisture, cable]
    start_node: safety_warning
    nodes:
      safety_warning:
        prompt: "‚ö†Ô∏è Safety: insulation/earth faults can indicate dangerous leakage. Are you authorised and equipped to test safely?"
        options:
          "‚úÖ Yes (authorised)": visual_moisture_check
          "‚ùå No": stop_escalate

      stop_escalate:
        prompt: "Do not continue. Isolate the charger, tag out, and escalate to authorised personnel/OEM."
        actions:
          - "Apply LOTO and follow site procedure"
          - "Capture fault code + timestamp"
        next: end

      visual_moisture_check:
        prompt: "Any signs of moisture ingress, flooding, condensation, or damaged DC cable/connector?"
        options:
          "‚úÖ Yes": dry_and_isolate
          "‚ùå No": reproduce_and_isolate_pole

      dry_and_isolate:
        prompt: "Moisture/damage suspected."
        actions:
          - "Take out of service; do not run repeated tests"
          - "Dry external connector area if safe"
          - "Inspect door seals, filters, vents, cable glands"
          - "Document with photos"
        next: end

      reproduce_and_isolate_pole:
        prompt: "Does the fault occur immediately on enable, or only after plugging in an EV?"
        options:
          "Immediately (no EV)": internal_leakage_suspect
          "Only with EV connected": connector_or_ev_suspect

      internal_leakage_suspect:
        prompt: "Internal leakage suspected (IMD, HV components, moisture inside cabinet)."
        actions:
          - "Perform OEM-approved insulation checks only if authorised"
          - "Escalate with IMD/isolation readings if available"
        next: end

      connector_or_ev_suspect:
        prompt: "Could be connector/cable contamination or vehicle issue."
        actions:
          - "Inspect and clean/dry connector externally (approved methods only)"
          - "Try a different EV to rule out vehicle leakage"
          - "If repeatable on multiple EVs: tag connector/cable for service"
        next: end


  - id: general_dc_overtemp_cooling_fault
    platform: general_dc
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Fans/Pump/Filter)"
    aliases:
      - "overtemp"
      - "over temperature"
      - "cooling fault"
      - "fan fault"
      - "pump fault"
      - "thermal fault"
    triggers:
      any_text_contains:
        - "overtemp"
        - "over temperature"
        - "cooling fault"
        - "fan fault"
        - "pump fault"
        - "thermal"
        - "temperature high"
    severity: high
    tags: [thermal, cooling, fan, pump, filter]
    start_node: check_airflow
    nodes:
      check_airflow:
        prompt: "Is airflow/cooling obviously compromised (blocked vents, clogged filters, hot cabinet, fans not running)?"
        options:
          "‚úÖ Yes": restore_airflow
          "‚ùå No / unsure": read_temps

      restore_airflow:
        prompt: "Restore airflow where safe."
        actions:
          - "Clear obstructions around vents"
          - "Inspect/clean filters (if accessible)"
          - "Check fan operation (audible/visible)"
          - "If liquid cooled: check for leaks and coolant level (visual)"
        next: cooldown_retry

      read_temps:
        prompt: "Do you have temperature readouts or a specific thermal sensor fault shown?"
        options:
          "‚úÖ Yes": sensor_targeted_checks
          "‚ùå No": cooldown_retry

      sensor_targeted_checks:
        prompt: "Target likely cause based on fault."
        actions:
          - "If 'fan' fault: verify fan spins, wiring not loose (visual)"
          - "If 'pump' fault: listen/feel for pump operation (if accessible)"
          - "If 'sensor' fault: likely sensor/cable issue‚Äîescalate for parts"
        next: cooldown_retry

      cooldown_retry:
        prompt: "Allow cooldown and retry session."
        actions:
          - "Wait 10‚Äì20 minutes depending on conditions"
          - "Reboot controller if permitted"
          - "Re-test charging"
        next: end


  - id: general_dc_estop_interlock_active
    platform: general_dc
    charger_type: dc
    title: "Emergency Stop / Safety Interlock Active"
    aliases:
      - "e-stop"
      - "emergency stop"
      - "interlock open"
      - "door open"
      - "safety loop"
      - "hvil"
    triggers:
      any_text_contains:
        - "e-stop"
        - "estop"
        - "emergency stop"
        - "interlock"
        - "door open"
        - "safety loop"
        - "hvil"
    severity: high
    tags: [safety, interlock, estop, hvil]
    start_node: identify_interlock
    nodes:
      identify_interlock:
        prompt: "What is indicated?"
        options:
          "üü• Emergency stop pressed": reset_estop
          "üö™ Door/cabinet open": close_doors
          "üî• Site/fire interlock": site_interlock
          "üîå HVIL / connector interlock": hvil_checks
          "‚ùì Not sure": generic_interlock

      reset_estop:
        prompt: "Reset E-stop(s) and re-check status."
        actions:
          - "Check all E-stops (including remote or pedestal E-stops)"
          - "Twist/pull reset as per device"
        next: recheck_ready

      close_doors:
        prompt: "Ensure all cabinet doors/panels are properly closed and latched."
        actions:
          - "Inspect door switches if visible"
          - "Confirm no tools/cables obstructing closure"
        next: recheck_ready

      site_interlock:
        prompt: "Site interlock active (e.g., fire alarm)."
        actions:
          - "Confirm site safety system is reset/cleared"
          - "Coordinate with site contact if required"
          - "Do not bypass safety circuits"
        next: recheck_ready

      hvil_checks:
        prompt: "HVIL/interlock related to connector/cable."
        actions:
          - "Inspect connector latch and cable strain relief"
          - "Try alternate connector if available"
          - "If repeatable: tag connector/cable for service"
        next: recheck_ready

      generic_interlock:
        prompt: "General interlock troubleshooting."
        actions:
          - "Check HMI messages carefully for which loop is open"
          - "Power cycle after clearing interlock"
          - "Escalate if interlock does not clear"
        next: recheck_ready

      recheck_ready:
        prompt: "Is the charger now 'Ready' and faults cleared?"
        options:
          "‚úÖ Yes": end_success
          "‚ùå No": escalate_with_details

      escalate_with_details:
        prompt: "Escalate with evidence."
        actions:
          - "Capture exact message/code and timestamp"
          - "Photo of HMI alarm screen"
          - "Note which resets attempted"
        next: end

      end_success:
        prompt: "Interlock cleared and charger ready."
        next: end


  - id: general_dc_power_derating_low_power
    platform: general_dc
    charger_type: dc
    title: "Low Power / Derating (Charging but Slow)"
    aliases:
      - "slow charging"
      - "low power"
      - "derating"
      - "reduced power"
      - "limited power"
    triggers:
      any_text_contains:
        - "slow"
        - "low power"
        - "derate"
        - "derating"
        - "reduced power"
        - "limited power"
    severity: medium
    tags: [performance, derating, thermal, grid, load_management]
    start_node: confirm_expectations
    nodes:
      confirm_expectations:
        prompt: "Confirm expectations: is the vehicle requesting high power (SOC low, warm battery) and stall rating supports it?"
        options:
          "‚úÖ Yes": check_site_limits
          "‚ùå Not sure": explain_vehicle_limits

      explain_vehicle_limits:
        prompt: "Slow charge can be normal due to EV limits."
        actions:
          - "High SOC reduces requested power significantly"
          - "Cold battery limits power until warmed"
          - "Different EV models have different max kW"
        next: check_site_limits

      check_site_limits:
        prompt: "Any site limits active (load management, shared power, demand response)?"
        options:
          "‚úÖ Yes / likely": document_site_limits
          "‚ùå No": check_thermal_derate

      document_site_limits:
        prompt: "Document and confirm site-side limits."
        actions:
          - "Check if multiple stalls share a power cabinet"
          - "Confirm other dispensers are active"
          - "Ask site/client about demand limits"
        next: check_thermal_derate

      check_thermal_derate:
        prompt: "Any overtemp/cooling warnings or hot ambient conditions?"
        options:
          "‚úÖ Yes": goto_overtemp_fault
          "‚ùå No": check_ac_supply_quality

      check_ac_supply_quality:
        prompt: "AC supply quality issues can reduce output (phase imbalance/undervoltage). Any supply alarms?"
        options:
          "‚úÖ Yes": supply_quality_actions
          "‚ùå No": capture_and_escalate

      supply_quality_actions:
        prompt: "Supply quality actions (safe checks)."
        actions:
          - "Check for phase loss/undervoltage alarms on HMI"
          - "If authorised: verify voltages at incomer"
          - "Escalate to site electrician if supply abnormal"
        next: end

      capture_and_escalate:
        prompt: "If no obvious cause, capture evidence for OEM/backend."
        actions:
          - "Record delivered kW, EV model, SOC, ambient temp"
          - "Photo of HMI session screen"
          - "Timestamp + charger ID"
        next: end

      goto_overtemp_fault:
        prompt: "Go to: 'Overtemperature / Cooling Fault' fault pack item."
        next: end


  - id: general_dc_hmi_frozen_unresponsive
    platform: general_dc
    charger_type: dc
    title: "HMI Frozen / Unresponsive (Screen On but Not Working)"
    aliases:
      - "screen frozen"
      - "hmi frozen"
      - "touch not working"
      - "unresponsive"
      - "stuck"
    triggers:
      any_text_contains:
        - "frozen"
        - "unresponsive"
        - "touch not working"
        - "screen stuck"
        - "hmi"
    severity: medium
    tags: [hmi, ui, controller, reboot]
    start_node: check_active_session
    nodes:
      check_active_session:
        prompt: "Is there an active charging session in progress?"
        options:
          "‚úÖ Yes": avoid_interrupting_session
          "‚ùå No": reboot_hmi

      avoid_interrupting_session:
        prompt: "Avoid interrupting an active session unless required for safety."
        actions:
          - "If session is charging OK: monitor until complete"
          - "If user-impact is critical: follow site procedure to end session safely"
        next: end

      reboot_hmi:
        prompt: "Try a controlled HMI reboot first (if menu/button available)."
        actions:
          - "Use service menu reboot if available"
          - "If no UI access: full power cycle per procedure"
          - "Check for recurring freezes (may indicate storage/OS issues)"
        next: end
