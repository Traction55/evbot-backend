# kempower.yml
# EVBot Fault Pack: Kempower (On-site Technician v1)
# Notes:
# - Each fault has response.telegram_markdown + decision_tree
# - Keep IDs stable for deep links later

faults:
  - id: kp_power_module_fault
    platform: kempower
    charger_type: dc
    title: "Power Module Fault / Module Offline (Kempower)"
    severity: "high"
    response:
      telegram_markdown: |
        üß∞ *Power Module Fault / Module Offline (Kempower)*

        *What this usually means*
        ‚Ä¢ One or more power modules are not communicating / not enabled
        ‚Ä¢ Can be caused by DC bus issues, comms harness, module supply, or a hard fault in a module

        *Safety (always)*
        ‚Ä¢ Follow LOTO / isolation procedure
        ‚Ä¢ Verify no hazardous voltage before touching internal components

        *Tools*
        ‚Ä¢ Multimeter (CAT-rated)
        ‚Ä¢ Basic hand tools (Torx/Allen as applicable)
        ‚Ä¢ Torque driver (if re-terminating)
        ‚Ä¢ Laptop/phone for logs (if available)

        Tap *Start troubleshooting* to step through checks.
    decision_tree:
      start_node: s1_safe
      nodes:
        s1_safe:
          prompt: |
            ‚úÖ *Step 1 ‚Äî Make safe*
            ‚Ä¢ Apply LOTO/isolate per site procedure
            ‚Ä¢ Prove dead before touching
            ‚Ä¢ Visually inspect for heat/burn marks

            Ready to proceed?
          options:
            - label: "Yes ‚Äî safe and isolated"
              next: s2_visual
            - label: "No ‚Äî can‚Äôt isolate / unsafe"
              next: stop_escalate

        s2_visual:
          prompt: |
            üîé *Step 2 ‚Äî Visual inspection*
            Check:
            ‚Ä¢ Any obvious burn marks / smell
            ‚Ä¢ Loose connectors, comms plugs, module seating
            ‚Ä¢ Signs of water ingress / condensation

            Do you see obvious damage?
          options:
            - label: "Yes ‚Äî damage/ingress present"
              next: stop_damage
            - label: "No ‚Äî looks OK"
              next: s3_reseat

        s3_reseat:
          prompt: |
            üîß *Step 3 ‚Äî Reseat module & comms*
            With power isolated:
            ‚Ä¢ Reseat affected module(s) (remove/insert firmly)
            ‚Ä¢ Reseat comms harness/connectors to module backplane
            ‚Ä¢ Confirm plugs are fully latched

            Completed reseat?
          options:
            - label: "Yes ‚Äî reseated"
              next: s4_power_on
            - label: "Not possible / unclear"
              next: escalate_pack

        s4_power_on:
          prompt: |
            ‚ö° *Step 4 ‚Äî Re-energise & re-check*
            ‚Ä¢ Remove tools, close covers as required
            ‚Ä¢ Restore power
            ‚Ä¢ Observe if module comes online / fault clears

            Result?
          options:
            - label: "‚úÖ Fault cleared / module online"
              next: resolved_monitor
            - label: "‚ùå Still offline / fault remains"
              next: s5_swap_isolate

        s5_swap_isolate:
          prompt: |
            üß™ *Step 5 ‚Äî Identify if it follows the module*
            If site configuration allows:
            ‚Ä¢ Swap the suspected module with another position (like-for-like)
            ‚Ä¢ Power cycle and check if the fault follows the module

            Did the fault follow the module?
          options:
            - label: "Yes ‚Äî follows the module"
              next: replace_module
            - label: "No ‚Äî stays with the slot/system"
              next: s6_system_checks
            - label: "Can‚Äôt swap modules here"
              next: s6_system_checks

        s6_system_checks:
          prompt: |
            üß∞ *Step 6 ‚Äî System-side checks*
            Check:
            ‚Ä¢ DC bus / internal supply indications (if safe and trained)
            ‚Ä¢ Backplane/slot connector condition
            ‚Ä¢ Any related alarms (cooling, contactor, IMD)
            ‚Ä¢ Tightness of obvious terminations (visual + torque only if required)

            Any clear system-side issue found?
          options:
            - label: "Yes ‚Äî found wiring/connector issue"
              next: fix_and_retest
            - label: "No ‚Äî nothing obvious"
              next: escalate_pack

        fix_and_retest:
          prompt: |
            üî© *Fix & re-test*
            ‚Ä¢ Re-terminate/reseat the identified connector
            ‚Ä¢ Confirm latching/strain relief
            ‚Ä¢ Power cycle and re-check module state

            Result?
          options:
            - label: "‚úÖ Resolved"
              next: resolved_monitor
            - label: "‚ùå Still faulty"
              next: escalate_pack

        replace_module:
          prompt: |
            üß© *Outcome ‚Äî Suspected faulty power module*
            ‚Ä¢ Tag the module as suspect
            ‚Ä¢ Replace module if spare available
            ‚Ä¢ If no spare: leave system safe and escalate for replacement

            Continue?
          options:
            - label: "üì¶ Replacement required"
              next: escalate_pack
            - label: "üè† Back to Kempower menu"
              next: menu_kp

        resolved_monitor:
          prompt: |
            ‚úÖ *Resolved*
            ‚Ä¢ Confirm charger returns to operational state
            ‚Ä¢ Run a test session if possible
            ‚Ä¢ Monitor for recurrence

            Next action:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp
            - label: "üîÅ Restart troubleshooting"
              next: s2_visual

        stop_damage:
          prompt: |
            ‚õî *STOP ‚Äî Damage / ingress found*
            ‚Ä¢ Do not re-energise if unsafe
            ‚Ä¢ Photograph damage
            ‚Ä¢ Escalate with details and site conditions
          options:
            - label: "üìû Escalate (pack)"
              next: escalate_pack
            - label: "üè† Kempower menu"
              next: menu_kp

        stop_escalate:
          prompt: |
            ‚õî *STOP ‚Äî Unable to isolate safely*
            ‚Ä¢ Follow site safety rules
            ‚Ä¢ Escalate for support / authorised isolation
          options:
            - label: "üìû Escalate (pack)"
              next: escalate_pack
            - label: "üè† Kempower menu"
              next: menu_kp

        escalate_pack:
          prompt: |
            üìà *Escalation pack (send to support)*
            Include:
            ‚Ä¢ Site + charger ID
            ‚Ä¢ Exact alarm/fault text + time
            ‚Ä¢ Which module/slot affected (if known)
            ‚Ä¢ Actions taken (reseat/swap/power cycle)
            ‚Ä¢ Photos (module, backplane, any damage)
            ‚Ä¢ Any related alarms (cooling/IMD/contactor)

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        menu_kp:
          prompt: "üè† Returning to Kempower menu‚Ä¶"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_backend_comms_fault
    platform: kempower
    charger_type: dc
    title: "Backend / OCPP Communication Fault (Kempower)"
    severity: "high"
    response:
      telegram_markdown: |
        üß∞ *Backend / OCPP Communication Fault (Kempower)*

        *Typical symptoms*
        ‚Ä¢ Charger shows offline in backend / no remote control
        ‚Ä¢ Sessions won‚Äôt start or stop reporting correctly
        ‚Ä¢ Modem/SIM/network registration issues

        *Safety*
        ‚Ä¢ Networking checks are usually low risk
        ‚Ä¢ Still follow site rules before opening cabinets

        Tap *Start troubleshooting* for onsite checks.
    decision_tree:
      start_node: s1_confirm
      nodes:
        s1_confirm:
          prompt: |
            ‚úÖ *Step 1 ‚Äî Confirm comms fault*
            ‚Ä¢ Is the charger shown offline in backend?
            ‚Ä¢ Is the HMI showing network/OCPP errors?

            What are you seeing?
          options:
            - label: "Offline / OCPP error confirmed"
              next: s2_power_cycle
            - label: "Not sure / no error shown"
              next: s2_power_cycle

        s2_power_cycle:
          prompt: |
            üîÅ *Step 2 ‚Äî Controlled power cycle*
            ‚Ä¢ Perform a controlled reboot/power cycle per procedure
            ‚Ä¢ Wait for full boot + modem registration

            After reboot, is it online?
          options:
            - label: "‚úÖ Online now"
              next: resolved_monitor
            - label: "‚ùå Still offline"
              next: s3_signal_sim

        s3_signal_sim:
          prompt: |
            üì∂ *Step 3 ‚Äî Modem/SIM basic checks*
            Check:
            ‚Ä¢ Antenna connected and undamaged
            ‚Ä¢ SIM seated (if accessible) and correct carrier
            ‚Ä¢ Any modem LED/status indicators (if present)

            Any obvious issue found?
          options:
            - label: "Yes ‚Äî antenna/SIM issue"
              next: fix_and_retest
            - label: "No ‚Äî looks OK"
              next: s4_network_env

        s4_network_env:
          prompt: |
            üåê *Step 4 ‚Äî Site network environment*
            Check:
            ‚Ä¢ Is this site in a low-signal area (basement/plant room)?
            ‚Ä¢ Any recent works that could affect reception?
            ‚Ä¢ If dual SIM / external antenna is available: try alternate path

            Can you improve signal / antenna position?
          options:
            - label: "Yes ‚Äî adjusted antenna/signal"
              next: fix_and_retest
            - label: "No ‚Äî cannot improve"
              next: escalate_pack

        fix_and_retest:
          prompt: |
            üîß *Fix applied ‚Äî re-test*
            ‚Ä¢ Reboot after change
            ‚Ä¢ Wait for registration + OCPP reconnect

            Result?
          options:
            - label: "‚úÖ Online"
              next: resolved_monitor
            - label: "‚ùå Still offline"
              next: escalate_pack

        resolved_monitor:
          prompt: |
            ‚úÖ *Resolved (for now)*
            ‚Ä¢ Confirm status online in backend
            ‚Ä¢ Run a short test session if possible
            ‚Ä¢ Monitor for recurrence

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        escalate_pack:
          prompt: |
            üìà *Escalation pack*
            Send support:
            ‚Ä¢ Site + charger ID
            ‚Ä¢ Time of failure + screenshots
            ‚Ä¢ SIM/antenna checks performed
            ‚Ä¢ Reboot results
            ‚Ä¢ Signal quality details if known
            ‚Ä¢ Any modem status indicators

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        menu_kp:
          prompt: "üè† Returning to Kempower menu‚Ä¶"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_estop_interlock_active
    platform: kempower
    charger_type: dc
    title: "E-Stop / Interlock Active (Kempower)"
    severity: "high"
    response:
      telegram_markdown: |
        üß∞ *E-Stop / Interlock Active (Kempower)*

        *Typical causes*
        ‚Ä¢ Emergency stop pressed
        ‚Ä¢ Door interlock open / safety loop broken
        ‚Ä¢ Safety chain wiring issue

        *Safety*
        ‚Ä¢ Treat as live equipment until isolated
        ‚Ä¢ Follow site isolation procedure before opening cabinets

        Tap *Start troubleshooting*.
    decision_tree:
      start_node: s1_check_estop
      nodes:
        s1_check_estop:
          prompt: |
            üî¥ *Step 1 ‚Äî Check E-Stop(s)*
            ‚Ä¢ Verify all E-Stops are released/reset
            ‚Ä¢ Some sites have multiple E-Stops (cabinet + external)

            Is any E-Stop engaged?
          options:
            - label: "Yes ‚Äî found E-Stop engaged"
              next: s2_reset_estop
            - label: "No ‚Äî all released"
              next: s3_check_doors

        s2_reset_estop:
          prompt: |
            ‚úÖ *Step 2 ‚Äî Reset E-Stop*
            ‚Ä¢ Reset E-Stop(s)
            ‚Ä¢ Re-check alarms/status

            Did the interlock alarm clear?
          options:
            - label: "‚úÖ Cleared"
              next: resolved_test
            - label: "‚ùå Still active"
              next: s3_check_doors

        s3_check_doors:
          prompt: |
            üö™ *Step 3 ‚Äî Check doors / interlocks*
            ‚Ä¢ Confirm all cabinet doors are fully closed
            ‚Ä¢ Check door interlock switches (if accessible)
            ‚Ä¢ Look for damaged/loose interlock wiring

            Any door/interlock issue found?
          options:
            - label: "Yes ‚Äî door/switch/wiring issue"
              next: fix_and_retest
            - label: "No ‚Äî nothing obvious"
              next: s4_isolate_trace

        s4_isolate_trace:
          prompt: |
            üîí *Step 4 ‚Äî Isolate and trace safety loop (trained techs only)*
            If authorised/trained:
            ‚Ä¢ Isolate per procedure
            ‚Ä¢ Trace safety loop continuity at accessible points
            ‚Ä¢ Look for broken conductor / loose terminal

            Found an open circuit/loose terminal?
          options:
            - label: "Yes ‚Äî found issue"
              next: fix_and_retest
            - label: "No / not authorised"
              next: escalate_pack

        fix_and_retest:
          prompt: |
            üîß *Fix applied ‚Äî re-test*
            ‚Ä¢ Restore, reboot if required
            ‚Ä¢ Confirm interlock alarm clears
            ‚Ä¢ Confirm unit returns to ready state

            Result?
          options:
            - label: "‚úÖ Resolved"
              next: resolved_test
            - label: "‚ùå Still active"
              next: escalate_pack

        resolved_test:
          prompt: |
            ‚úÖ *Resolved*
            ‚Ä¢ Confirm charger is ready
            ‚Ä¢ Perform a test session if possible

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        escalate_pack:
          prompt: |
            üìà *Escalation pack*
            Send support:
            ‚Ä¢ Exact interlock alarm text
            ‚Ä¢ Which E-Stop(s) checked + results
            ‚Ä¢ Door/interlock checks performed
            ‚Ä¢ Photos of interlock wiring/switches (if safe)

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        menu_kp:
          prompt: "üè† Returning to Kempower menu‚Ä¶"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_imd_isolation_fault
    platform: kempower
    charger_type: dc
    title: "Insulation Monitoring / IMD Fault (Kempower)"
    severity: "critical"
    response:
      telegram_markdown: |
        üß∞ *Insulation Monitoring / IMD Fault (Kempower)*

        *Important*
        ‚Ä¢ IMD/insulation faults can indicate leakage to earth or moisture ingress
        ‚Ä¢ Treat as *high risk* until proven otherwise

        *Safety*
        ‚Ä¢ LOTO/isolate before opening
        ‚Ä¢ Do not bypass safety systems

        Tap *Start troubleshooting*.
    decision_tree:
      start_node: s1_stop_safe
      nodes:
        s1_stop_safe:
          prompt: |
            ‚õî *Step 1 ‚Äî Stop & make safe*
            ‚Ä¢ Isolate/LOTO per procedure
            ‚Ä¢ Inspect for water ingress, damaged cables, contamination

            Do you see moisture/ingress/damage?
          options:
            - label: "Yes ‚Äî ingress/damage present"
              next: stop_damage
            - label: "No ‚Äî looks dry"
              next: s2_external_cable

        s2_external_cable:
          prompt: |
            üîå *Step 2 ‚Äî Check external cable/connector*
            Check:
            ‚Ä¢ Cable sheath damage
            ‚Ä¢ Connector contamination/moisture
            ‚Ä¢ Signs of tracking/burn marks

            Any issue found?
          options:
            - label: "Yes ‚Äî cable/connector issue"
              next: stop_damage
            - label: "No ‚Äî looks OK"
              next: s3_isolate_reboot

        s3_isolate_reboot:
          prompt: |
            üîÅ *Step 3 ‚Äî Reboot after inspection*
            ‚Ä¢ Ensure everything is dry/clean
            ‚Ä¢ Restore power
            ‚Ä¢ Reboot/power cycle
            ‚Ä¢ Check if IMD fault clears

            Result?
          options:
            - label: "‚úÖ Cleared"
              next: resolved_monitor
            - label: "‚ùå Still present"
              next: escalate_pack

        resolved_monitor:
          prompt: |
            ‚úÖ *Cleared (monitor closely)*
            ‚Ä¢ Run a controlled test session if permitted
            ‚Ä¢ Monitor for recurrence
            ‚Ä¢ If recurring, treat as insulation degradation and escalate

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        stop_damage:
          prompt: |
            ‚õî *STOP ‚Äî IMD/insulation risk*
            ‚Ä¢ Do not return to service until resolved
            ‚Ä¢ Photograph damage/ingress
            ‚Ä¢ Escalate immediately

            Next:
          options:
            - label: "üìû Escalate (pack)"
              next: escalate_pack
            - label: "üè† Kempower menu"
              next: menu_kp

        escalate_pack:
          prompt: |
            üìà *Escalation pack (IMD fault)*
            Send support:
            ‚Ä¢ Exact IMD/alarm text + time
            ‚Ä¢ Weather conditions + recent rain/washdown
            ‚Ä¢ Photos: cable/connector/cabinet interior
            ‚Ä¢ Actions taken (inspection, cleaning, reboot)
            ‚Ä¢ Whether fault is persistent or intermittent

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        menu_kp:
          prompt: "üè† Returning to Kempower menu‚Ä¶"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_overtemp_cooling_fault
    platform: kempower
    charger_type: dc
    title: "Overtemperature / Cooling / Fan Fault (Kempower)"
    severity: "high"
    response:
      telegram_markdown: |
        üß∞ *Overtemperature / Cooling / Fan Fault (Kempower)*

        *Typical symptoms*
        ‚Ä¢ Power derates heavily
        ‚Ä¢ Unit stops charging or faults under load
        ‚Ä¢ Fan alarms / cooling alarms

        *Safety*
        ‚Ä¢ Hot surfaces and moving fans
        ‚Ä¢ Isolate before reaching into cabinet

        Tap *Start troubleshooting*.
    decision_tree:
      start_node: s1_confirm
      nodes:
        s1_confirm:
          prompt: |
            üå°Ô∏è *Step 1 ‚Äî Confirm cooling issue*
            ‚Ä¢ Is the unit derating or stopping under load?
            ‚Ä¢ Are fans running during operation?

            What‚Äôs happening?
          options:
            - label: "Fans not running / obvious cooling alarm"
              next: s2_visual
            - label: "Fans running but still overtemp"
              next: s3_airflow
            - label: "Not sure"
              next: s2_visual

        s2_visual:
          prompt: |
            üîé *Step 2 ‚Äî Visual inspection*
            Check:
            ‚Ä¢ Blocked vents/filters
            ‚Ä¢ Dust buildup
            ‚Ä¢ Damaged fan blades
            ‚Ä¢ Loose fan power plugs

            Found blockage/loose plug?
          options:
            - label: "Yes"
              next: fix_clean
            - label: "No"
              next: s3_airflow

        s3_airflow:
          prompt: |
            üå¨Ô∏è *Step 3 ‚Äî Airflow & environment*
            Check:
            ‚Ä¢ Heat sources nearby
            ‚Ä¢ Cabinet space around vents
            ‚Ä¢ Ambient temp extreme
            ‚Ä¢ Louvres obstructed

            Can airflow be improved?
          options:
            - label: "Yes ‚Äî cleared space/vents"
              next: fix_clean
            - label: "No ‚Äî environment unchanged"
              next: s4_retest

        fix_clean:
          prompt: |
            üßπ *Step 4 ‚Äî Clean/secure & re-test*
            ‚Ä¢ Clean filters/vents (as per procedure)
            ‚Ä¢ Reseat any loose fan power plugs
            ‚Ä¢ Restore and run a test charge

            Result?
          options:
            - label: "‚úÖ Resolved / no derate"
              next: resolved_monitor
            - label: "‚ùå Still derating/faulting"
              next: s4_retest

        s4_retest:
          prompt: |
            üß™ *Step 5 ‚Äî Re-test under load*
            ‚Ä¢ Attempt a controlled session
            ‚Ä¢ Watch for fan operation and alarms
            ‚Ä¢ If possible, capture temps/alarms/logs

            Result?
          options:
            - label: "‚úÖ Stable"
              next: resolved_monitor
            - label: "‚ùå Fault persists"
              next: escalate_pack

        resolved_monitor:
          prompt: |
            ‚úÖ *Resolved*
            ‚Ä¢ Confirm fans run correctly
            ‚Ä¢ Confirm no alarms return
            ‚Ä¢ Monitor during peak heat periods

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        escalate_pack:
          prompt: |
            üìà *Escalation pack (cooling)*
            Send support:
            ‚Ä¢ Exact alarm text + time
            ‚Ä¢ Photos of filters/vents/fans
            ‚Ä¢ Ambient temperature/site conditions
            ‚Ä¢ Actions taken (cleaning, reseat, retest)
            ‚Ä¢ Whether derate occurs only under load

            Next:
          options:
            - label: "üè† Kempower menu"
              next: menu_kp

        menu_kp:
          prompt: "üè† Returning to Kempower menu‚Ä¶"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__
