# kempower.yml
# EVBot Fault Pack: Kempower (On-site Technician v1)
# Notes:
# - Node-based decision tree: start_node + nodes map
# - Each node has: prompt, options -> next
# - Keep IDs stable for deep links

faults:

  - id: kp_power_module_fault
    platform: kempower
    charger_type: dc
    title: "Power Module Fault / Module Offline (Kempower)"
    severity: high
    tags: [power_module, rectifier, dc_bus, comms, cooling]

    response:
      telegram_markdown: |
        *Kempower — Power Module Fault / Module Offline*

        One or more power modules are not communicating or not enabled.

        Common causes:
        • Module not seated correctly
        • Loose comms/backplane connector
        • Module disabled after transient fault
        • Cooling-related shutdown
        • Failed power module (least common)

        Tap *Start troubleshooting* to proceed safely.

    decision_tree:
      start_node: P0
      nodes:

        P0:
          prompt: "*Power Module Fault — Start*"
          options:
            - label: "Module offline / fault active"
              next: P1
            - label: "Intermittent"
              next: P1

        P1:
          prompt: "*Make safe (LOTO)*"
          options:
            - label: "Isolated & safe"
              next: P2
            - label: "Cannot isolate"
              next: STOP_ESCALATE

        P2:
          prompt: "*Visual inspection*"
          options:
            - label: "Damage / ingress visible"
              next: STOP_DAMAGE
            - label: "Looks OK"
              next: P3

        P3:
          prompt: "*Reseat module (most common fix)*"
          options:
            - label: "Reseated"
              next: P4
            - label: "Not possible"
              next: ESCALATE_PACK

        P4:
          prompt: "*Restore power & re-check*"
          options:
            - label: "Module online"
              next: RESOLVED_MONITOR
            - label: "Still offline"
              next: P5

        P5:
          prompt: "*Does the fault follow the module?*"
          options:
            - label: "Yes — follows module"
              next: REPLACE_MODULE
            - label: "No — stays with slot/system"
              next: ESCALATE_PACK
            - label: "Cannot swap"
              next: ESCALATE_PACK

        REPLACE_MODULE:
          prompt: "*Suspected failed module*"
          options:
            - label: "Escalate for replacement"
              next: ESCALATE_PACK
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        STOP_DAMAGE:
          prompt: "*STOP — Damage / overheating found*"
          options:
            - label: "Escalate"
              next: ESCALATE_PACK
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        STOP_ESCALATE:
          prompt: "*STOP — Unable to isolate safely*"
          options:
            - label: "Escalate"
              next: ESCALATE_PACK
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        ESCALATE_PACK:
          prompt: "*Escalation pack — Power Module*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        RESOLVED_MONITOR:
          prompt: "*Resolved — monitor*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER
            - label: "Restart"
              next: P0

        MENU_KEMPOWER:
          prompt: "Returning to Kempower menu…"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_backend_comms_fault
    platform: kempower
    charger_type: dc
    title: "Backend / OCPP Communication Fault (Kempower)"
    severity: high
    tags: [ocpp, backend, comms, modem, sim, network]

    response:
      telegram_markdown: |
        *Kempower — Backend / OCPP Communication Fault*

        The charger is not connected to the backend (offline / no remote control).

        Common causes:
        • Modem or SIM registration issue
        • Antenna damage / poor signal
        • Network environment (basement, plant room)
        • Backend endpoint mismatch

    decision_tree:
      start_node: C0
      nodes:

        C0:
          prompt: "*Backend / OCPP offline*"
          options:
            - label: "Continue"
              next: C1

        C1:
          prompt: "*Reboot / power cycle*"
          options:
            - label: "Online"
              next: RESOLVED_MONITOR
            - label: "Still offline"
              next: C2

        C2:
          prompt: "*Basic antenna / SIM checks*"
          options:
            - label: "Issue found"
              next: C1
            - label: "No issue"
              next: ADVANCED_NETWORK

        ADVANCED_NETWORK:
          prompt: |
            *Deep dive — Network*
            Check:
            • SIM registered on GSM only
            • APN incorrect
            • Carrier outage
            • Private IP blocked
          options:
            - label: "Fixed"
              next: C1
            - label: "Escalate"
              next: ESCALATE_PACK

        ESCALATE_PACK:
          prompt: "*Escalation pack — Backend/OCPP*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        RESOLVED_MONITOR:
          prompt: "*Resolved — monitor*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        MENU_KEMPOWER:
          prompt: "Returning to Kempower menu…"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_estop_interlock_active
    platform: kempower
    charger_type: dc
    title: "E-Stop / Interlock Active (Kempower)"
    severity: high
    tags: [safety, interlock, estop]

    decision_tree:
      start_node: S0
      nodes:

        S0:
          prompt: "*E-Stop / Interlock active*"
          options:
            - label: "Check E-Stops"
              next: S1

        S1:
          prompt: "*Any E-Stop engaged?*"
          options:
            - label: "Yes"
              next: RESOLVED_TEST
            - label: "No"
              next: S2

        S2:
          prompt: "*Check doors / interlocks*"
          options:
            - label: "Issue found"
              next: RESOLVED_TEST
            - label: "Nothing obvious"
              next: ESCALATE_PACK

        RESOLVED_TEST:
          prompt: "*Resolved — test charger*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        ESCALATE_PACK:
          prompt: "*Escalation pack — Interlock*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        MENU_KEMPOWER:
          prompt: "Returning to Kempower menu…"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_imd_isolation_fault
    platform: kempower
    charger_type: dc
    title: "IMD / Insulation Fault (Kempower)"
    severity: critical
    tags: [imd, insulation, earth_leakage, safety]

    decision_tree:
      start_node: I0
      nodes:

        I0:
          prompt: "*IMD / insulation fault detected*"
          options:
            - label: "Inspect connector/cable"
              next: I1

        I1:
          prompt: "*Moisture or damage present?*"
          options:
            - label: "Yes"
              next: STOP_DAMAGE
            - label: "No"
              next: I2

        I2:
          prompt: "*Reboot & re-test*"
          options:
            - label: "Cleared"
              next: RESOLVED_MONITOR
            - label: "Still present"
              next: ESCALATE_PACK

        STOP_DAMAGE:
          prompt: "*STOP — insulation risk*"
          options:
            - label: "Escalate"
              next: ESCALATE_PACK
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        ESCALATE_PACK:
          prompt: "*Escalation pack — IMD*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        RESOLVED_MONITOR:
          prompt: "*Resolved — monitor closely*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        MENU_KEMPOWER:
          prompt: "Returning to Kempower menu…"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kp_overtemp_cooling_fault
    platform: kempower
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Kempower)"
    severity: high
    tags: [cooling, fans, filters, airflow]

    decision_tree:
      start_node: T0
      nodes:

        T0:
          prompt: "*Overtemperature / cooling fault*"
          options:
            - label: "Check airflow"
              next: T1

        T1:
          prompt: "*Filters dirty / vents blocked?*"
          options:
            - label: "Yes"
              next: FIX_FILTERS
            - label: "No"
              next: ESCALATE_PACK

        FIX_FILTERS:
          prompt: "*Clean filters & vents*"
          options:
            - label: "Re-test"
              next: RESOLVED_MONITOR

        ESCALATE_PACK:
          prompt: "*Escalation pack — Cooling*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        RESOLVED_MONITOR:
          prompt: "*Resolved — monitor*"
          options:
            - label: "Kempower menu"
              next: MENU_KEMPOWER

        MENU_KEMPOWER:
          prompt: "Returning to Kempower menu…"
          options:
            - label: "Open Kempower menu"
              next: __MENU_KEMPOWER__
