# kempower.yml
# EVBot Fault Pack: Kempower (Top faults by impact / frequency style)
# Source: Kempower Error Codes Rev 2.00 (09-2025)
#
# Notes:
# - platform: kempower
# - decision_tree.start_node + decision_tree.nodes
# - node.options MUST be a LIST of {label, next}
# - Keep IDs stable so your bot can deep-link

faults:

  # ============================================================
  # MERGED CLUSTER (GOLD STANDARD): Power Modules Offline / Derating
  # Keep ID stable for deep-links: kempower_power_module_cluster
  # ============================================================

  - id: kempower_power_module_cluster
    platform: kempower
    charger_type: dc
    title: "Power Modules Offline / Derating (PMC / DPDM)"
    severity: high
    tags: [power, module, pmc, dpdm, rectifier, derate, self_check]

    aliases:
      - "Power Module / Power Stack Fault (PMC / DPDM)"
      - "Power Module Controller Offline (PMC Not Communicating)"
      - "Power Distribution Module Missing (DPDM Not Detected)"
      - "Power Module Self-Check Failed (PMC Communication Error)"
      - "Power Module Control Signal Fault ‚Äì Enable Line or Control Signal Missing"
      - "Power Module Not Producing Output ‚Äì No DC Voltage Detected"
      - "RT_PMC_UNAVAILABLE"
      - "RT_RELAYCARD_MISSING"
      - "SSC_PMC_COMMUNICATION_ERROR"
      - "SSC_PMC_ENABLE_LINE_ERROR"
      - "SSC_PMC_VOLTAGE_MISSING"
      - "PMC offline"
      - "DPDM missing"

    triggers:
      any_text_contains:
        - "power module"
        - "power stack"
        - "pmc"
        - "dpdm"
        - "derate"
        - "self-check"
        - "self check"
        - "enable line"
        - "control signal"
        - "no dc voltage"
        - "voltage missing"
        - "drive command failed"
        - "not communicating"
        - "offline"
        - "relaycard"
        - "RT_PMC_UNAVAILABLE"
        - "rt_pmc_unavailable"
        - "RT_RELAYCARD_MISSING"
        - "rt_relaycard_missing"
        - "SSC_PMC_COMMUNICATION_ERROR"
        - "ssc_pmc_communication_error"
        - "SSC_PMC_ENABLE_LINE_ERROR"
        - "ssc_pmc_enable_line_error"
        - "SSC_PMC_VOLTAGE_MISSING"
        - "ssc_pmc_voltage_missing"

    description: >
      One or more Power Modules (PMCs) or the Power Distribution Module (DPDM) is not contributing to DC output.
      The system may be missing the module, unable to communicate with it, or the module has self-inhibited due to
      protection (thermal/electrical) or a control/enable signal issue. This typically causes derating (reduced kW)
      when some PMCs remain online, or charger unavailability when multiple PMCs/DPDM are affected.

    safety_notes:
      - Follow site LOTO and Kempower safety procedures before cabinet access
      - Do not reseat or move modules unless authorised/trained
      - Do not re-energise if signs of damage or overheating are present
      - Do not repeatedly reset tripping breakers/fuses‚Äîinvestigate cause

    decision_tree:
      start_node: PM0
      nodes:

        PM0:
          prompt: |
            *Power Modules Offline / Derating (PMC / DPDM)*
            Start with what you‚Äôre seeing (symptom-first):
          options:
            - label: "‚ö†Ô∏è Charging but reduced kW (derating)"
              next: PM_PATTERN_DERATE
            - label: "üö´ Charger unavailable / won‚Äôt start sessions"
              next: PM_PATTERN_UNAVAILABLE
            - label: "üîé I have a specific Kempower code"
              next: PM_CODE_PICKER
            - label: "‚ö†Ô∏è Generic power module / power stack fault"
              next: PM_PATTERN_GENERIC

        PM_PATTERN_DERATE:
          prompt: |
            *Pattern check ‚Äî Derating*
            Is this affecting one cabinet/stack or multiple?
          options:
            - label: "One cabinet/stack"
              next: PM_PATTERN_WHICH
            - label: "Multiple / unclear"
              next: PM_PATTERN_WHICH

        PM_PATTERN_UNAVAILABLE:
          prompt: |
            *Pattern check ‚Äî Unavailable*
            Is it one cabinet/stack or the whole station?
          options:
            - label: "One cabinet/stack"
              next: PM_PATTERN_WHICH
            - label: "Whole station / multiple"
              next: PM_PATTERN_WHICH

        PM_PATTERN_GENERIC:
          prompt: |
            *Pattern check*
            Before touching anything: identify whether it‚Äôs derating (some PMCs online) or unavailable (many offline).
          options:
            - label: "Derating"
              next: PM_PATTERN_DERATE
            - label: "Unavailable"
              next: PM_PATTERN_UNAVAILABLE

        PM_PATTERN_WHICH:
          prompt: |
            *Identify scope*
            Can you identify a specific cabinet/slot/module (PMC) related to the alarm?
            (HMI details, cabinet labels, or recent work notes)
          options:
            - label: "Yes ‚Äî specific cabinet/module/slot"
              next: PM_SAFETY
            - label: "No ‚Äî unclear"
              next: PM_SAFETY

        PM_CODE_PICKER:
          prompt: |
            *Select the closest code/symptom shown on HMI:*
          options:
            - label: "üß© PMC Offline / Not communicating (RT_PMC_UNAVAILABLE)"
              next: PM_SYM_PMC_OFFLINE
            - label: "üì¶ DPDM missing / not detected (RT_RELAYCARD_MISSING)"
              next: PM_SYM_DPDM_MISSING
            - label: "üß™ Self-check comms / drive command failed (SSC_PMC_COMMUNICATION_ERROR)"
              next: PM_SYM_SELFCHK_COMMS
            - label: "üîå Enable line / control signal missing (SSC_PMC_ENABLE_LINE_ERROR)"
              next: PM_SYM_ENABLE_LINE
            - label: "‚ùå No DC voltage / not producing output (SSC_PMC_VOLTAGE_MISSING)"
              next: PM_SYM_NO_DC_VOLT
            - label: "‚ö†Ô∏è Not sure / generic power module fault"
              next: PM_SYM_GENERIC

        PM_SAFETY:
          prompt: |
            ‚úÖ *Safety first (non-negotiable)*
            - LOTO / isolation applied per site procedure
            - Allow discharge time before opening cabinet
            - If heat/smell/smoke/water ingress: stop and escalate
          options:
            - label: "Continue ‚û°Ô∏è"
              next: PM_VISUAL

        PM_VISUAL:
          prompt: |
            üëÄ *Visual checks (cabinet + rack)*
            - Burnt smell / discoloration / melted insulation?
            - Loose lugs, arcing marks, water ingress?
            - Connector damage / bent pins?
          options:
            - label: "üî• Damage found"
              next: PM_ESC_UNSAFE
            - label: "Looks OK"
              next: PM_SUPPLY

        PM_SUPPLY:
          prompt: |
            ‚ö° *Supply checks (safe-first)*
            - Any upstream CB/fuse tripped?
            - Confirm supply present (and stable if possible)
            - If multi-feed: confirm correct feed live
          options:
            - label: "CB/fuse tripped or supply issue"
              next: PM_SUPPLY_FIX
            - label: "Supply OK"
              next: PM_POWER_CYCLE

        PM_SUPPLY_FIX:
          prompt: |
            *Supply / breaker recovery*
            - Reset a tripped breaker/fuse once only (if permitted)
            - If it trips again: do NOT keep resetting‚Äîsuspect fault and escalate
          options:
            - label: "Recovered (charger now available / derate cleared)"
              next: PM_DONE_RESOLVED
            - label: "Recovered but still derating"
              next: PM_DONE_STAB
            - label: "Trips again / still faulting"
              next: PM_ESC

        PM_POWER_CYCLE:
          prompt: |
            üîÅ *Controlled power cycle*
            - Isolate OFF
            - Wait per discharge procedure
            - Power ON
            - Re-check alarms / availability
          options:
            - label: "Recovered (normal output) ‚úÖ"
              next: PM_DONE_RESOLVED
            - label: "Recovered but still derating ‚ö†Ô∏è"
              next: PM_DONE_STAB
            - label: "Still faulting"
              next: PM_IDENTIFY

        PM_IDENTIFY:
          prompt: |
            *Identify where the fault is (now get specific)*
            Can you identify a specific cabinet / slot / module (PMC) related to the alarm?
          options:
            - label: "Yes ‚Äî specific module/slot"
              next: PM_RESEAT
            - label: "No ‚Äî unclear"
              next: PM_FW_CHECK

        PM_RESEAT:
          prompt: |
            *Reseat / connector inspection (authorised only)*
            If permitted:
            - Apply LOTO
            - Reseat affected PMC / DPDM connectors
            - Inspect connector pins for burning/bent pins/contamination
          options:
            - label: "üî• Damage found"
              next: PM_ESC_UNSAFE
            - label: "Reseated ‚Äî re-test"
              next: PM_RETEST
            - label: "Not permitted"
              next: PM_FW_CHECK

        PM_RETEST:
          prompt: |
            *Re-test (observe what changed)*
            Re-energise and run a short session (if safe).
            Monitor output stability and recurrence.
          options:
            - label: "Resolved (normal output) ‚úÖ"
              next: PM_DONE_RESOLVED
            - label: "Charging but derated ‚ö†Ô∏è"
              next: PM_DONE_STAB
            - label: "Still faulting"
              next: PM_SWAP

        PM_SWAP:
          prompt: |
            üß© *Swap / change slots (if allowed)*
            - Move suspected PMC to another slot
            - Check if fault follows module or stays with slot/backplane
          options:
            - label: "Fault follows module"
              next: PM_REPLACE_MODULE
            - label: "Fault stays with slot/backplane"
              next: PM_SLOT_BACKPLANE
            - label: "Can‚Äôt swap / not allowed"
              next: PM_FW_CHECK

        PM_FW_CHECK:
          prompt: |
            *Firmware / configuration checks (after safe hardware checks)*
            Check:
            - Station firmware version
            - Any recent updates/rollbacks
            - Configuration detects PMCs/DPDM correctly
          options:
            - label: "Issue found (mismatch / config / update required)"
              next: PM_ESC
            - label: "No obvious issues"
              next: PM_LOGS

        PM_LOGS:
          prompt: |
            üóÇÔ∏è *Logs & evidence (prepare for escalation)*
            - Note exact code/message + timestamps
            - Capture HMI screenshots
            - Capture any backend/session screenshots if available
            - Note derate level (kW) and whether it‚Äôs stable or fluctuating
          options:
            - label: "Escalate with evidence"
              next: PM_ESC
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        PM_SYM_PMC_OFFLINE:
          prompt: |
            *PMC Offline / Not communicating (RT_PMC_UNAVAILABLE)*
            Common causes:
            - seating / rear connector pins
            - 24V/AUX supply issue
            - module fault vs slot/backplane
            Proceed through the standard path (safety ‚Üí visual ‚Üí supply ‚Üí cycle ‚Üí reseat ‚Üí swap).
          options:
            - label: "Start checks ‚û°Ô∏è"
              next: PM_SAFETY

        PM_SYM_DPDM_MISSING:
          prompt: |
            *DPDM missing / not detected (RT_RELAYCARD_MISSING)*
            Common causes:
            - comms loss between cabinets (dynamic systems)
            - Ethernet wiring/switch ports
            - connector pin damage
            Proceed with standard checks; capture comms/cabinet details for escalation.
          options:
            - label: "Start checks ‚û°Ô∏è"
              next: PM_SAFETY

        PM_SYM_SELFCHK_COMMS:
          prompt: |
            *Self-check comms / drive command failed (SSC_PMC_COMMUNICATION_ERROR)*
            If SSC fan control errors exist, address those first.
            Otherwise treat as seating/comms/module fault and proceed.
          options:
            - label: "Start checks ‚û°Ô∏è"
              next: PM_SAFETY

        PM_SYM_ENABLE_LINE:
          prompt: |
            *Enable line / control signal missing (SSC_PMC_ENABLE_LINE_ERROR)*
            Often related to:
            - EN line continuity between PMC and DPDM
            - wiring after recent work
            - connector pins
            Proceed with standard checks, then escalate with findings.
          options:
            - label: "Start checks ‚û°Ô∏è"
              next: PM_SAFETY

        PM_SYM_NO_DC_VOLT:
          prompt: |
            *No DC voltage detected (SSC_PMC_VOLTAGE_MISSING)*
            Common causes:
            - breaker/fuse/phase issue
            - module fault
            Proceed with standard checks (supply ‚Üí cycle ‚Üí reseat ‚Üí swap).
          options:
            - label: "Start checks ‚û°Ô∏è"
              next: PM_SAFETY

        PM_SYM_GENERIC:
          prompt: |
            *Generic Power Module / Power Stack Fault*
            Proceed with the standard path (safety ‚Üí visual ‚Üí supply ‚Üí cycle ‚Üí reseat ‚Üí swap).
          options:
            - label: "Start checks ‚û°Ô∏è"
              next: PM_SAFETY

        PM_REPLACE_MODULE:
          prompt: |
            ‚úÖ *Fault follows module*
            Likely module failure.
            - Replace module per OEM procedure
            - Record serial + slot
            - Retest after replacement
          options:
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        PM_SLOT_BACKPLANE:
          prompt: |
            üß© *Fault stays with slot/backplane*
            Likely slot/backplane/harness/controller-side issue.
            - Inspect slot connector pins + harness seating (authorised only)
            - Escalate with photos + logs
          options:
            - label: "Escalate"
              next: PM_ESC
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        PM_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise.
            Evidence required:
            - Photos of damage/burn marks
            - Affected cabinet/module/slot
            - Error codes and timestamps
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        PM_ESC:
          prompt: |
            *Escalate ‚Äî Power Modules Offline / Derating (PMC / DPDM)*
            Include:
            - Exact error codes/messages + timestamps
            - Affected cabinet/module/slot
            - State: unavailable vs derated (kW delivered)
            - Actions attempted (supply check / cycle / reseat / swap)
            - Firmware version
            - Photos/screenshots
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        PM_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Power module fault cleared and normal output restored.
            Before leaving:
            - Confirm stability (no immediate re-fault)
            - Note what changed (cycle / reseat / swap result)
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        PM_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised (Derated)*
            Charger is operating but with reduced power.
            Recommended:
            - Document derate level (kW) + whether stable/fluctuating
            - Identify affected cabinet/module if possible
            - Plan follow-up (module/service visit) if derate persists
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # NO_HEARTBEAT (gold-standard lite)
  # Keep ID stable: kempower_no_heartbeat
  # ============================================================

  - id: kempower_no_heartbeat
    platform: kempower
    charger_type: dc
    title: "Satellite / Control Unit Offline (No Communication)"
    severity: high
    tags: [network, ethernet, satellite, control_unit, offline]

    aliases:
      - "NO_HEARTBEAT"
      - "no_heartbeat"
      - "no heartbeat"
      - "heartbeat missing"
      - "satellite offline"
      - "satellite not responding"
      - "control unit offline"
      - "control unit not responding"

    triggers:
      any_text_contains:
        - "NO_HEARTBEAT"
        - "no_heartbeat"
        - "no heartbeat"
        - "heartbeat missing"
        - "satellite offline"
        - "control unit offline"

    description: >
      A Satellite/Control Unit is configured but not available on the local network.
      This can be a single-device issue (24V supply, local ethernet, RJ45 termination) or system-wide
      (switching, cabinet-to-cabinet links, internal omega board ‚Üî Ethernet switch, grounding/jumpers in multi-cabinet systems).

    safety_notes:
      - If opening cabinets, follow LOTO and discharge requirements
      - Do not bypass safety interlocks or network segregation rules

    decision_tree:
      start_node: KHB0
      nodes:

        KHB0:
          prompt: |
            *NO_HEARTBEAT ‚Äî Start (pattern check)*
            Is it *one* Satellite/Control Unit, or *all* of them?
          options:
            - label: "Only one satellite"
              next: KHB1
            - label: "All satellites / whole station"
              next: KHB2

        KHB1:
          prompt: |
            *Single satellite (local path)*
            Check:
            - 24V supply at satellite/control unit (target 23‚Äì25VDC)
            - RJ45 cable seating/termination
            - RJ45 extension block + flat cable to display (if fitted)
          options:
            - label: "Fixed ‚Üí re-test"
              next: KHB3
            - label: "Still offline"
              next: KHB_LOGS

        KHB2:
          prompt: |
            *System-wide (infrastructure path)*
            Check:
            - Network links between main/secondary cabinets
            - Inside control module: omega board ‚Üî Ethernet switch links
            - Multi-cabinet: confirm cabinet GND terminal blocks are jumpered as required
          options:
            - label: "Fixed ‚Üí re-test"
              next: KHB3
            - label: "Still offline"
              next: KHB_LOGS

        KHB3:
          prompt: |
            *Re-test*
            Restart charger/controller (controlled) and confirm heartbeat returns.
          options:
            - label: "‚úÖ Resolved"
              next: KHB_DONE_RESOLVED
            - label: "‚ö†Ô∏è Still offline"
              next: KHB_LOGS

        KHB_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack (before escalating)*
            Capture:
            - Which satellite(s) affected
            - 24V measurement result(s)
            - Photos of RJ45 terminations / switch LEDs (if accessible)
            - Timestamps + any recent works/changes
          options:
            - label: "Escalate"
              next: KHB_ESC
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        KHB_ESC:
          prompt: |
            *Escalate ‚Äî NO_HEARTBEAT*
            Provide:
            - which satellite(s)
            - 24V measurements
            - what you reseated/checked
            - photos + timestamps
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KHB_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Heartbeat restored.
            Before leaving:
            - Confirm satellites remain online after 5‚Äì10 minutes
            - Note what fixed it (power, RJ45, switch, jumper)
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # COMM_NOT_READY (gold-standard lite)
  # Keep ID stable: kempower_comm_not_ready
  # ============================================================

  - id: kempower_comm_not_ready
    platform: kempower
    charger_type: dc
    title: "Vehicle Communication Failed (CCS Control Pilot Not Ready)"
    severity: high
    tags: [ccs, control_pilot, connector, startup]

    aliases:
      - "COMM_NOT_READY"
      - "comm_not_ready"
      - "comm not ready"
      - "ccs not ready"
      - "control pilot fault"
      - "cp not ready"
      - "pilot fault"

    triggers:
      any_text_contains:
        - "COMM_NOT_READY"
        - "comm_not_ready"
        - "comm not ready"
        - "control pilot"
        - "cp not ready"

    description: >
      CCS is not available because Control Pilot (CP) is in a fault state at startup.
      Commonly wiring/commissioning, CCS card revision mismatch, connector/CP pin integrity, or a transient boot fault.

    safety_notes:
      - Do not force connectors; inspect for damage/debris/water first
      - If repeated across vehicles/connectors, treat as hardware/wiring and escalate

    decision_tree:
      start_node: KCP0
      nodes:

        KCP0:
          prompt: |
            *COMM_NOT_READY ‚Äî Start (pattern check)*
            Did this start after recent install/commissioning work or hardware changes?
          options:
            - label: "Yes (recent changes)"
              next: KCP1
            - label: "No (sudden fault)"
              next: KCP2

        KCP1:
          prompt: |
            *Commissioning path*
            Check:
            - CP pin continuity/termination per install spec
            - Connector condition (bent pin/debris/water)
            - If mismatch suspected: optional CCS card revision may need upgrade
          options:
            - label: "Restart & re-test"
              next: KCP_RETEST
            - label: "Need evidence/escalate"
              next: KCP_LOGS

        KCP2:
          prompt: |
            *Sudden fault path*
            Do safe-first recovery:
            - Controlled restart (controller/HMI if available)
            - If persists: full power cycle (per procedure)
          options:
            - label: "Restart & re-test"
              next: KCP_RETEST
            - label: "Still failing"
              next: KCP_LOGS

        KCP_RETEST:
          prompt: |
            *Re-test*
            Try:
            - Known-good EV (if available)
            - Alternate connector (if station supports)
          options:
            - label: "‚úÖ Resolved"
              next: KCP_DONE_RESOLVED
            - label: "‚ö†Ô∏è Still failing"
              next: KCP_LOGS

        KCP_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Connector ID used + whether other connector works
            - EV model tested
            - Exact message/code + timestamp
            - Photos of connector face/CP pin area (external only)
            - Recent works/changes notes (if any)
          options:
            - label: "Escalate"
              next: KCP_ESC
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        KCP_ESC:
          prompt: |
            *Escalate ‚Äî COMM_NOT_READY*
            Provide:
            - connector ID + EV model
            - CP wiring check result (if performed)
            - timestamps + photos
            - recent work history
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KCP_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            CP/CCS comms restored.
            Before leaving:
            - Confirm 2‚Äì3 start attempts succeed
            - Note what fixed it (restart vs reseat vs connector swap)
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # RCM_BAD (gold-standard lite)
  # Keep ID stable: kempower_rcm_bad
  # ============================================================

  - id: kempower_rcm_bad
    platform: kempower
    charger_type: ac
    title: "Earth Leakage Detected (Residual Current Monitor Trip)"
    severity: high
    tags: [safety, rcd, rcm, earth_leakage, type2]

    aliases:
      - "RCM_BAD"
      - "rcm_bad"
      - "rcm bad"
      - "residual current leak"
      - "earth leakage"
      - "leakage detected"

    triggers:
      any_text_contains:
        - "RCM_BAD"
        - "rcm_bad"
        - "rcm bad"
        - "earth leakage"
        - "residual current"

    description: >
      The residual current monitor detected leakage to protective earth (PE) and disabled output for safety.
      Often moisture-related (rain/condensation/contaminated connector), cable damage, or an RCM sensor fault.

    safety_notes:
      - Treat as safety-critical; do not repeatedly attempt to charge
      - If moisture or damage is suspected, take out of service and escalate
      - Insulation/IR testing only by authorised personnel using approved methods

    decision_tree:
      start_node: KRCM0
      nodes:

        KRCM0:
          prompt: |
            *RCM_BAD ‚Äî Start (pattern check)*
            Was this a one-off event (e.g., after rain/washdown), or is it repeating?
          options:
            - label: "One-off / after moisture"
              next: KRCM1
            - label: "Repeating / persistent"
              next: KRCM2

        KRCM1:
          prompt: |
            *One-off moisture path*
            - Inspect connector/port externally for water/debris
            - Allow drying time if conditions suggest moisture
            - Perform controlled restart / AC main OFF‚ÜíON (if permitted)
          options:
            - label: "Re-test"
              next: KRCM_RETEST
            - label: "Collect evidence"
              next: KRCM_LOGS

        KRCM2:
          prompt: |
            *Persistent path*
            Likely leakage source or sensor fault.
            Next actions (authorised only):
            - Insulation resistance testing phases‚ÜíPE
            - Inspect cable/connector for damage
            If IR is OK, RCM device may be faulty.
          options:
            - label: "Escalate"
              next: KRCM_ESC
            - label: "Collect evidence"
              next: KRCM_LOGS

        KRCM_RETEST:
          prompt: |
            *Re-test*
            Does the fault clear and charging resume normally?
          options:
            - label: "‚úÖ Resolved"
              next: KRCM_DONE_RESOLVED
            - label: "‚ö†Ô∏è Still present"
              next: KRCM_LOGS

        KRCM_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Weather/moisture notes
            - Photos of connector/port condition
            - Exact code/message + timestamp
            - Whether it happens with no load vs on plug-in (if observable)
          options:
            - label: "Escalate"
              next: KRCM_ESC
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        KRCM_ESC:
          prompt: |
            *Escalate ‚Äî RCM_BAD*
            Provide:
            - moisture/weather context
            - photos
            - any IR results (if authorised/performed)
            - timestamps + repeatability
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KRCM_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Leakage cleared and unit operating.
            Before leaving:
            - Confirm repeat start works
            - Note conditions (rain/moisture) + action taken
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # AFE_COMMUNICATION_ERROR (gold-standard lite)
  # Keep ID stable: kempower_afe_communication_error
  # ============================================================

  - id: kempower_afe_communication_error
    platform: kempower
    charger_type: dc
    title: "Grid Input Stage Communication Fault (AFE Internal Comms)"
    severity: medium
    tags: [pmc, afe, firmware, comms]

    aliases:
      - "AFE_COMMUNICATION_ERROR"
      - "afe_communication_error"
      - "afe communication error"
      - "pmc comms bus error"

    triggers:
      any_text_contains:
        - "AFE_COMMUNICATION_ERROR"
        - "afe_communication_error"
        - "afe communication error"

    description: >
      PMC internal communication bus error related to the AFE (grid input stage).
      Can cause temporary PMC unavailability and reduced power. Often software/firmware-related if repeating.

    safety_notes:
      - If accompanied by power module derating/unavailability, also review the Power Modules Cluster
      - Avoid repeated hard power cycles unless required; capture evidence for OEM

    decision_tree:
      start_node: KAFE0
      nodes:

        KAFE0:
          prompt: |
            *AFE_COMMUNICATION_ERROR ‚Äî Start (pattern check)*
            Is this a one-off event or repeating/frequent?
          options:
            - label: "One-off"
              next: KAFE1
            - label: "Repeating"
              next: KAFE2

        KAFE1:
          prompt: |
            *One-off*
            - Monitor for recurrence
            - Optional: controlled restart if unit is impacted
          options:
            - label: "‚úÖ Resolved / Not recurring"
              next: KAFE_DONE_RESOLVED
            - label: "It came back"
              next: KAFE2

        KAFE2:
          prompt: |
            *Repeating*
            Recommended:
            - Check firmware/software version
            - If updates pending, apply per process
            - If already current, escalate with frequency + cabinet context
          options:
            - label: "Collect evidence"
              next: KAFE_LOGS
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        KAFE_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Frequency (per day/week) + whether it clears on restart
            - Cabinet/module context (if shown)
            - Firmware/software version
            - Timestamps + HMI screenshots
          options:
            - label: "Escalate"
              next: KAFE_ESC
            - label: "Back"
              next: __MENU_KEMPOWER__

        KAFE_ESC:
          prompt: |
            *Escalate ‚Äî AFE_COMMUNICATION_ERROR*
            Provide:
            - frequency + impact (derate/unavailable?)
            - firmware version
            - timestamps + screenshots
            - any steps attempted (restart, update)
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KAFE_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            No recurrence observed.
            Before leaving:
            - Note event + timestamp
            - Confirm output normal / no derate
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # FAN_CURRENT (gold-standard lite)
  # Keep ID stable: kempower_fan_current
  # ============================================================

  - id: kempower_fan_current
    platform: kempower
    charger_type: dc
    title: "Cooling Fan Electrical Fault (Fan Current Out of Range)"
    severity: medium
    tags: [fan, cooling, airflow, firmware, pmc]

    aliases:
      - "FAN_CURRENT"
      - "fan_current"
      - "fan current"
      - "fan fault"
      - "thermal performance reduced"

    triggers:
      any_text_contains:
        - "FAN_CURRENT"
        - "fan_current"
        - "fan current"
        - "thermal performance reduced"

    description: >
      Fan current is out of expected range. The unit may derate to protect itself.
      Causes include blocked airflow/filters, failing fan, wiring/connector issue, or control/firmware edge cases.

    safety_notes:
      - Keep hands/tools clear of moving fans
      - If overheating is present, allow cooldown and avoid repeated sessions until airflow is restored

    decision_tree:
      start_node: KFN0
      nodes:

        KFN0:
          prompt: |
            *FAN_CURRENT ‚Äî Start (pattern check)*
            Do you observe airflow issues (blocked vents/dirty filters) or abnormal fan noise?
          options:
            - label: "Yes (airflow/noise issue)"
              next: KFN1
            - label: "No / unsure"
              next: KFN2

        KFN1:
          prompt: |
            *Airflow path*
            Actions:
            - Clear external obstructions
            - Check/clean filters (if accessible)
            - Verify fans spin freely (visual/audible)
            If a fan is not running or noisy: plan replacement.
          options:
            - label: "Re-test"
              next: KFN_RETEST
            - label: "Collect evidence"
              next: KFN_LOGS

        KFN2:
          prompt: |
            *Recovery path*
            - Controlled restart (remote if available ‚Üí local)
            - If repeating: check firmware version and update if required
          options:
            - label: "Re-test"
              next: KFN_RETEST
            - label: "Collect evidence"
              next: KFN_LOGS

        KFN_RETEST:
          prompt: |
            *Re-test*
            Does the fan fault clear and does the unit stop derating?
          options:
            - label: "‚úÖ Resolved (normal cooling/output)"
              next: KFN_DONE_RESOLVED
            - label: "‚ö†Ô∏è Still derating / fault persists"
              next: KFN_DONE_STAB

        KFN_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Which cabinet/module (if shown)
            - Fan noise/airflow observations + filter condition
            - Ambient temperature
            - Firmware/software version
            - Timestamps + HMI screenshots
          options:
            - label: "Escalate"
              next: KFN_ESC
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        KFN_ESC:
          prompt: |
            *Escalate ‚Äî FAN_CURRENT*
            Provide:
            - cabinet/module context
            - airflow/noise/filter observations
            - firmware version
            - timestamps + screenshots/photos
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KFN_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Cooling restored and fault cleared.
            Before leaving:
            - Confirm no recurrence during a short session
            - Note what changed (filter clean, obstruction removed, restart)
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KFN_DONE_STAB:
          prompt: |
            ‚ö†Ô∏è *Stabilised (Derated)*
            Charger may still operate but at reduced power to protect thermal limits.
            Recommended:
            - Document derate level and whether it‚Äôs stable/fluctuating
            - Plan service visit (fan/filter/airflow)
          options:
            - label: "Escalate"
              next: KFN_ESC
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # PRIMARY_UNDERVOLTAGE (gold-standard lite)
  # Keep ID stable: kempower_primary_undervoltage
  # ============================================================

  - id: kempower_primary_undervoltage
    platform: kempower
    charger_type: dc
    title: "Incoming Supply Too Low (Undervoltage / Phase Issue)"
    severity: high
    tags: [grid, supply, undervoltage, wiring, pmc]

    aliases:
      - "PRIMARY_UNDERVOLTAGE"
      - "primary_undervoltage"
      - "primary undervoltage"
      - "incoming supply too low"
      - "supply too low"
      - "phase issue"

    triggers:
      any_text_contains:
        - "PRIMARY_UNDERVOLTAGE"
        - "primary_undervoltage"
        - "undervoltage"
        - "supply too low"

    description: >
      Primary circuit voltage is below threshold. Can be genuine grid undervoltage (especially under load),
      phase imbalance/loss, upstream limitation, or internal cabinet issues causing one stack to report low supply.

    safety_notes:
      - Live measurements only by authorised personnel using approved methods/PPE
      - If a breaker trips repeatedly, do not keep resetting‚Äîinvestigate cause

    decision_tree:
      start_node: KUV0
      nodes:

        KUV0:
          prompt: |
            *PRIMARY_UNDERVOLTAGE ‚Äî Start (pattern check)*
            Can you confirm whether site/grid voltage is actually low (ideally under load)?
          options:
            - label: "Yes (grid low confirmed)"
              next: KUV1
            - label: "No / unknown"
              next: KUV2

        KUV1:
          prompt: |
            *Grid-side issue likely*
            Actions:
            - Confirm site supply capacity vs charger rating
            - Check if other equipment/site loads coincide
            - Escalate to site electrician / distributor as appropriate
          options:
            - label: "Collect evidence"
              next: KUV_LOGS
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        KUV2:
          prompt: |
            *Charger-side checks (safe-first)*
            Check:
            - Upstream CB/isolator status
            - Any phase-loss/imbalance alarms
            - If shown: does undervoltage relate to a specific cabinet/PMC?
          options:
            - label: "Do controlled restart"
              next: KUV_RESTART
            - label: "Collect evidence"
              next: KUV_LOGS

        KUV_RESTART:
          prompt: |
            *Controlled restart*
            - Restart controller/HMI if available
            - If persists: full power cycle per procedure
          options:
            - label: "‚úÖ Resolved"
              next: KUV_DONE_RESOLVED
            - label: "‚ö†Ô∏è Still present"
              next: KUV_LOGS

        KUV_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Measured L-L voltages (and under-load if possible)
            - Whether whole site affected vs one cabinet
            - Any phase imbalance/phase loss indicators
            - Timestamps + screenshots
          options:
            - label: "Escalate"
              next: KUV_ESC
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        KUV_ESC:
          prompt: |
            *Escalate ‚Äî PRIMARY_UNDERVOLTAGE*
            Provide:
            - voltage measurements + method/context (load/no-load)
            - cabinet/stack context (if any)
            - timestamps + screenshots
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KUV_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Undervoltage cleared and unit operating normally.
            Before leaving:
            - Confirm stable voltage + no recurrence during short session
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # RT_SAFETY_ERROR_IN_THIS_PMC (gold-standard lite, safety heavy)
  # Keep ID stable: kempower_rt_safety_error_in_this_pmc
  # ============================================================

  - id: kempower_rt_safety_error_in_this_pmc
    platform: kempower
    charger_type: dc
    title: "Electrical Safety Fault Detected (Isolation / Moisture Risk)"
    severity: critical
    tags: [safety, insulation, isolation, water_ingress, dpdm, maintenance]

    aliases:
      - "RT_SAFETY_ERROR_IN_THIS_PMC"
      - "rt_safety_error_in_this_pmc"
      - "rt safety error"
      - "isolation fault"
      - "pmc safety error"
      - "moisture risk"

    triggers:
      any_text_contains:
        - "RT_SAFETY_ERROR_IN_THIS_PMC"
        - "rt_safety_error_in_this_pmc"
        - "isolation"
        - "safety error"

    description: >
      Safety monitoring indicates an isolation/leakage risk associated with a specific PMC/cabinet.
      Often moisture/water ingress, contamination, cable gland/seal failure, or internal insulation degradation.
      Treat as safety-critical and avoid repeated operation attempts.

    safety_notes:
      - Do not continue charging attempts until assessed; risk of dangerous leakage
      - Apply LOTO before opening cabinets; discharge requirements apply
      - Insulation/IR tests only by authorised personnel using approved methods

    decision_tree:
      start_node: KISO0
      nodes:

        KISO0:
          prompt: |
            *RT_SAFETY_ERROR_IN_THIS_PMC ‚Äî Start (safety gate)*
            Treat as *safety critical*.
            Any evidence of water ingress / moisture marks / condensation?
          options:
            - label: "Yes (moisture evidence)"
              next: KISO1
            - label: "No / unsure"
              next: KISO2

        KISO1:
          prompt: |
            *Moisture path*
            Actions:
            - Take affected cabinet/connector out of service
            - Inspect seals, vents, cable glands, door gaskets (visual)
            - Document moisture paths and condition
          options:
            - label: "Collect evidence"
              next: KISO_LOGS
            - label: "Escalate"
              next: KISO_ESC

        KISO2:
          prompt: |
            *Still treat seriously*
            Even without obvious moisture:
            - Avoid repeated sessions
            - Document which PMC/cabinet is referenced
            - Prepare for authorised insulation testing / OEM support
          options:
            - label: "Collect evidence"
              next: KISO_LOGS
            - label: "Escalate"
              next: KISO_ESC

        KISO_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Which PMC/cabinet
            - Photos of cabinet condition (external + any visible moisture marks)
            - Environmental conditions (rain, flooding, washdown, humidity)
            - Maintenance history notes (filters/PM interval)
            - Timestamps + HMI screenshots
          options:
            - label: "Escalate"
              next: KISO_ESC
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        KISO_ESC:
          prompt: |
            *Escalate ‚Äî RT_SAFETY_ERROR_IN_THIS_PMC*
            Provide:
            - PMC/cabinet identification
            - photos + environmental context
            - maintenance history
            - timestamps + screenshots
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # SSC_SELFTEST_INTERNAL_ERROR (gold-standard lite)
  # Keep ID stable: kempower_ssc_selftest_internal_error
  # ============================================================

  - id: kempower_ssc_selftest_internal_error
    platform: kempower
    charger_type: dc
    title: "Internal System Fault ‚Äì Self-Test Failed"
    severity: critical
    tags: [self_check, configuration, canbus, software, dpdm]

    aliases:
      - "SSC_SELFTEST_INTERNAL_ERROR"
      - "ssc_selftest_internal_error"
      - "ssc selftest internal error"
      - "self test failed"
      - "self-check failed"
      - "all connectors failed"

    triggers:
      any_text_contains:
        - "SSC_SELFTEST_INTERNAL_ERROR"
        - "ssc_selftest_internal_error"
        - "self-test failed"
        - "self test failed"
        - "self check failed"

    description: >
      System self-test failed. Often triggered by companion SSC faults, configuration/hardware mismatch, or CAN wiring/divider board issues.
      Best practice: resolve other SSC alarms first, then re-run self-test and escalate with inventory + firmware context.

    safety_notes:
      - Avoid repeated reboot loops without collecting evidence; you‚Äôll lose timestamps/context
      - If any safety/isolation alarms coexist, treat those as priority

    decision_tree:
      start_node: KST0
      nodes:

        KST0:
          prompt: |
            *SSC_SELFTEST_INTERNAL_ERROR ‚Äî Start (pattern check)*
            Are other SSC codes present (example: SSC_CONNECTOR_VOLTAGE_MISSING)?
          options:
            - label: "Yes (other SSC codes present)"
              next: KST1
            - label: "No (standalone self-test error)"
              next: KST2

        KST1:
          prompt: |
            *Do companion SSC codes first*
            - Troubleshoot the other SSC alarms first
            - Then re-run self-test / restart and check if this clears
          options:
            - label: "Re-test"
              next: KST_RETEST
            - label: "Collect evidence"
              next: KST_LOGS

        KST2:
          prompt: |
            *Core system checks*
            Recommended checks (as available):
            - Inventory scan: confirm PMCs detected
            - DPDM configuration correct (dynamic systems)
            - Firmware/software version current
            - CAN bus divider board installation/wiring/condition
          options:
            - label: "Re-test"
              next: KST_RETEST
            - label: "Collect evidence"
              next: KST_LOGS

        KST_RETEST:
          prompt: |
            *Re-test*
            After addressing items above, does self-test pass and system become available?
          options:
            - label: "‚úÖ Resolved"
              next: KST_DONE_RESOLVED
            - label: "‚ö†Ô∏è Still failing"
              next: KST_LOGS

        KST_LOGS:
          prompt: |
            üóÇÔ∏è *Evidence pack*
            Capture:
            - Inventory scan results (PMCs found/missing)
            - Firmware/software version
            - Any other SSC codes + order of appearance
            - Photos/notes of CAN divider board (if inspected)
            - Timestamps + HMI screenshots
          options:
            - label: "Escalate"
              next: KST_ESC
            - label: "Back"
              next: __MENU_KEMPOWER__

        KST_ESC:
          prompt: |
            *Escalate ‚Äî SSC_SELFTEST_INTERNAL_ERROR*
            Provide:
            - inventory scan results
            - firmware version
            - CAN divider board notes
            - other SSC codes
            - timestamps + screenshots
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__

        KST_DONE_RESOLVED:
          prompt: |
            ‚úÖ *Resolved*
            Self-test passed and system available.
            Before leaving:
            - Confirm stable operation (no immediate re-fault)
            - Note what fixed it (SSC companion fix vs config vs update)
          options:
            - label: "üè† Kempower menu"
              next: __MENU_KEMPOWER__
