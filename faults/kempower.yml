# kempower.yml
# EVBot Fault Pack: Kempower (Top 12 by impact / frequency style)
# Source: Kempower Error Codes Rev 2.00 (09-2025)

faults:

  # ============================================================
  # MERGED CLUSTER (REWRITE): Power Modules Offline / Derating
  # Keep ID stable for deep-links: kempower_power_module_cluster
  # ============================================================

  - id: kempower_power_module_cluster
    platform: kempower
    charger_type: dc
    title: "Power Modules Offline / Derating (PMC / DPDM)"
    severity: high
    tags: [power, module, pmc, dpdm, rectifier, derate, self_check]

    aliases:
      - "Power Module / Power Stack Fault (PMC / DPDM)"
      - "Power Module Controller Offline (PMC Not Communicating)"
      - "Power Distribution Module Missing (DPDM Not Detected)"
      - "Power Module Self-Check Failed (PMC Communication Error)"
      - "Power Module Control Signal Fault â€“ Enable Line or Control Signal Missing"
      - "Power Module Not Producing Output â€“ No DC Voltage Detected"
      - "RT_PMC_UNAVAILABLE"
      - "RT_RELAYCARD_MISSING"
      - "SSC_PMC_COMMUNICATION_ERROR"
      - "SSC_PMC_ENABLE_LINE_ERROR"
      - "SSC_PMC_VOLTAGE_MISSING"
      - "PMC offline"
      - "DPDM missing"

    triggers:
      any_text_contains:
        # Generic text
        - "power module"
        - "power stack"
        - "pmc"
        - "dpdm"
        - "derate"
        - "self-check"
        - "self check"
        - "enable line"
        - "control signal"
        - "no dc voltage"
        - "voltage missing"
        - "drive command failed"
        - "not communicating"
        - "offline"
        - "relaycard"
        # Error code strings (as your bot sees them)
        - "RT_PMC_UNAVAILABLE"
        - "rt_pmc_unavailable"
        - "RT_RELAYCARD_MISSING"
        - "rt_relaycard_missing"
        - "SSC_PMC_COMMUNICATION_ERROR"
        - "ssc_pmc_communication_error"
        - "SSC_PMC_ENABLE_LINE_ERROR"
        - "ssc_pmc_enable_line_error"
        - "SSC_PMC_VOLTAGE_MISSING"
        - "ssc_pmc_voltage_missing"

    description: >
      One or more Power Modules (PMCs) or the Power Distribution Module (DPDM) is not contributing to DC output.
      The system may be missing the module, unable to communicate with it, or the module has self-inhibited due to
      protection (thermal/electrical) or a control/enable signal issue. This typically causes derating (reduced kW)
      when some PMCs remain online, or charger unavailability when multiple PMCs/DPDM are affected.

    safety_notes:
      - Follow site LOTO and Kempower safety procedures before cabinet access
      - Do not reseat or move modules unless authorised/trained
      - Do not re-energise if signs of damage or overheating are present
      - Do not repeatedly reset tripping breakers/fusesâ€”investigate cause

    decision_tree:
      start_node: PM0
      nodes:

        PM0:
          prompt: |
            *Power Modules Offline / Derating (PMC / DPDM)*
            Start with what youâ€™re seeing (symptom-first):
          options:
            - label: "âš ï¸ Charging but reduced kW (derating)"
              next: PM_PATTERN_DERATE
            - label: "ðŸš« Charger unavailable / wonâ€™t start sessions"
              next: PM_PATTERN_UNAVAILABLE
            - label: "ðŸ”Ž I have a specific Kempower code"
              next: PM_CODE_PICKER
            - label: "âš ï¸ Generic power module / power stack fault"
              next: PM_PATTERN_GENERIC

        # ---------- Pattern check (collapses uncertainty early) ----------
        PM_PATTERN_DERATE:
          prompt: |
            *Pattern check â€” Derating*
            Is this affecting one cabinet/stack or multiple?
          options:
            - label: "One cabinet/stack"
              next: PM_PATTERN_WHICH
            - label: "Multiple / unclear"
              next: PM_PATTERN_WHICH

        PM_PATTERN_UNAVAILABLE:
          prompt: |
            *Pattern check â€” Unavailable*
            Is it one cabinet/stack or the whole station?
          options:
            - label: "One cabinet/stack"
              next: PM_PATTERN_WHICH
            - label: "Whole station / multiple"
              next: PM_PATTERN_WHICH

        PM_PATTERN_GENERIC:
          prompt: |
            *Pattern check*
            Before touching anything: identify whether itâ€™s derating (some PMCs online) or unavailable (many offline).
          options:
            - label: "Derating"
              next: PM_PATTERN_DERATE
            - label: "Unavailable"
              next: PM_PATTERN_UNAVAILABLE

        PM_PATTERN_WHICH:
          prompt: |
            *Identify scope*
            Can you identify a specific cabinet/slot/module (PMC) related to the alarm?
            (HMI details, cabinet labels, or recent work notes)
          options:
            - label: "Yes â€” specific cabinet/module/slot"
              next: PM_SAFETY
            - label: "No â€” unclear"
              next: PM_SAFETY

        # ---------- Code picker (moved behind symptom-first) ----------
        PM_CODE_PICKER:
          prompt: |
            *Select the closest code/symptom shown on HMI:*
          options:
            - label: "ðŸ§© PMC Offline / Not communicating (RT_PMC_UNAVAILABLE)"
              next: PM_SYM_PMC_OFFLINE
            - label: "ðŸ“¦ DPDM missing / not detected (RT_RELAYCARD_MISSING)"
              next: PM_SYM_DPDM_MISSING
            - label: "ðŸ§ª Self-check comms / drive command failed (SSC_PMC_COMMUNICATION_ERROR)"
              next: PM_SYM_SELFCHK_COMMS
            - label: "ðŸ”Œ Enable line / control signal missing (SSC_PMC_ENABLE_LINE_ERROR)"
              next: PM_SYM_ENABLE_LINE
            - label: "âŒ No DC voltage / not producing output (SSC_PMC_VOLTAGE_MISSING)"
              next: PM_SYM_NO_DC_VOLT
            - label: "âš ï¸ Not sure / generic power module fault"
              next: PM_SYM_GENERIC

        # ---------- Common safety gate ----------
        PM_SAFETY:
          prompt: |
            âœ… *Safety first (non-negotiable)*
            - LOTO / isolation applied per site procedure
            - Allow discharge time before opening cabinet
            - If heat/smell/smoke/water ingress: stop and escalate
          options:
            - label: "Continue âž¡ï¸"
              next: PM_VISUAL

        # ---------- Common visual + supply checks ----------
        PM_VISUAL:
          prompt: |
            ðŸ‘€ *Visual checks (cabinet + rack)*
            - Burnt smell / discoloration / melted insulation?
            - Loose lugs, arcing marks, water ingress?
            - Connector damage / bent pins?
          options:
            - label: "ðŸ”¥ Damage found"
              next: PM_ESC_UNSAFE
            - label: "Looks OK"
              next: PM_SUPPLY

        PM_SUPPLY:
          prompt: |
            âš¡ *Supply checks (safe-first)*
            - Any upstream CB/fuse tripped?
            - Confirm supply present (and stable if possible)
            - If multi-feed: confirm correct feed live
          options:
            - label: "CB/fuse tripped or supply issue"
              next: PM_SUPPLY_FIX
            - label: "Supply OK"
              next: PM_POWER_CYCLE

        PM_SUPPLY_FIX:
          prompt: |
            *Supply / breaker recovery*
            - Reset a tripped breaker/fuse once only (if permitted)
            - If it trips again: do NOT keep resettingâ€”suspect fault and escalate
          options:
            - label: "Recovered (charger now available / derate cleared)"
              next: PM_DONE_RESOLVED
            - label: "Recovered but still derating"
              next: PM_DONE_STAB
            - label: "Trips again / still faulting"
              next: PM_ESC

        PM_POWER_CYCLE:
          prompt: |
            ðŸ” *Controlled power cycle*
            - Isolate OFF
            - Wait per discharge procedure
            - Power ON
            - Re-check alarms / availability
          options:
            - label: "Recovered (normal output) âœ…"
              next: PM_DONE_RESOLVED
            - label: "Recovered but still derating âš ï¸"
              next: PM_DONE_STAB
            - label: "Still faulting"
              next: PM_IDENTIFY

        PM_IDENTIFY:
          prompt: |
            *Identify where the fault is (now get specific)*
            Can you identify a specific cabinet / slot / module (PMC) related to the alarm?
          options:
            - label: "Yes â€” specific module/slot"
              next: PM_RESEAT
            - label: "No â€” unclear"
              next: PM_FW_CHECK

        PM_RESEAT:
          prompt: |
            *Reseat / connector inspection (authorised only)*
            If permitted:
            - Apply LOTO
            - Reseat affected PMC / DPDM connectors
            - Inspect connector pins for burning/bent pins/contamination
          options:
            - label: "ðŸ”¥ Damage found"
              next: PM_ESC_UNSAFE
            - label: "Reseated â€” re-test"
              next: PM_RETEST
            - label: "Not permitted"
              next: PM_FW_CHECK

        PM_RETEST:
          prompt: |
            *Re-test (observe what changed)*
            Re-energise and run a short session (if safe).
            Monitor output stability and recurrence.
          options:
            - label: "Resolved (normal output) âœ…"
              next: PM_DONE_RESOLVED
            - label: "Charging but derated âš ï¸"
              next: PM_DONE_STAB
            - label: "Still faulting"
              next: PM_SWAP

        PM_SWAP:
          prompt: |
            ðŸ§© *Swap / change slots (if allowed)*
            - Move suspected PMC to another slot
            - Check if fault follows module or stays with slot/backplane
          options:
            - label: "Fault follows module"
              next: PM_REPLACE_MODULE
            - label: "Fault stays with slot/backplane"
              next: PM_SLOT_BACKPLANE
            - label: "Canâ€™t swap / not allowed"
              next: PM_FW_CHECK

        PM_FW_CHECK:
          prompt: |
            *Firmware / configuration checks (after safe hardware checks)*
            Check:
            - Station firmware version
            - Any recent updates/rollbacks
            - Configuration detects PMCs/DPDM correctly
          options:
            - label: "Issue found (mismatch / config / update required)"
              next: PM_ESC
            - label: "No obvious issues"
              next: PM_LOGS

        PM_LOGS:
          prompt: |
            ðŸ—‚ï¸ *Logs & evidence (prepare for escalation)*
            - Note exact code/message + timestamps
            - Capture HMI screenshots
            - Capture any backend/session screenshots if available
            - Note derate level (kW) and whether itâ€™s stable or fluctuating
          options:
            - label: "Escalate with evidence"
              next: PM_ESC
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        # ---------- Symptom-specific â€œextrasâ€ (light branching) ----------
        PM_SYM_PMC_OFFLINE:
          prompt: |
            *PMC Offline / Not communicating (RT_PMC_UNAVAILABLE)*
            Common causes:
            - seating / rear connector pins
            - 24V/AUX supply issue
            - module fault vs slot/backplane
            Proceed through the standard path (safety â†’ visual â†’ supply â†’ cycle â†’ reseat â†’ swap).
          options:
            - label: "Start checks âž¡ï¸"
              next: PM_SAFETY

        PM_SYM_DPDM_MISSING:
          prompt: |
            *DPDM missing / not detected (RT_RELAYCARD_MISSING)*
            Common causes:
            - comms loss between cabinets (dynamic systems)
            - Ethernet wiring/switch ports
            - connector pin damage
            Proceed with standard checks; capture comms/cabinet details for escalation.
          options:
            - label: "Start checks âž¡ï¸"
              next: PM_SAFETY

        PM_SYM_SELFCHK_COMMS:
          prompt: |
            *Self-check comms / drive command failed (SSC_PMC_COMMUNICATION_ERROR)*
            If SSC fan control errors exist, address those first.
            Otherwise treat as seating/comms/module fault and proceed.
          options:
            - label: "Start checks âž¡ï¸"
              next: PM_SAFETY

        PM_SYM_ENABLE_LINE:
          prompt: |
            *Enable line / control signal missing (SSC_PMC_ENABLE_LINE_ERROR)*
            Often related to:
            - EN line continuity between PMC and DPDM
            - wiring after recent work
            - connector pins
            Proceed with standard checks, then escalate with findings.
          options:
            - label: "Start checks âž¡ï¸"
              next: PM_SAFETY

        PM_SYM_NO_DC_VOLT:
          prompt: |
            *No DC voltage detected (SSC_PMC_VOLTAGE_MISSING)*
            Common causes:
            - breaker/fuse/phase issue
            - module fault
            Proceed with standard checks (supply â†’ cycle â†’ reseat â†’ swap).
          options:
            - label: "Start checks âž¡ï¸"
              next: PM_SAFETY

        PM_SYM_GENERIC:
          prompt: |
            *Generic Power Module / Power Stack Fault*
            Proceed with the standard path (safety â†’ visual â†’ supply â†’ cycle â†’ reseat â†’ swap).
          options:
            - label: "Start checks âž¡ï¸"
              next: PM_SAFETY

        # ---------- Outcomes (explicit end states) ----------
        PM_REPLACE_MODULE:
          prompt: |
            âœ… *Fault follows module*
            Likely module failure.
            - Replace module per OEM procedure
            - Record serial + slot
            - Retest after replacement
          options:
            - label: "Back to Kempower menu"
              next: __MENU_KEMPOWER__

        PM_SLOT_BACKPLANE:
          prompt: |
            ðŸ§© *Fault stays with slot/backplane*
            Likely slot/backplane/harness/controller-side issue.
            - Inspect slot connector pins + harness seating (authorised only)
            - Escalate with photos + logs
          options:
            - label: "Escalate"
              next: PM_ESC
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        PM_ESC_UNSAFE:
          prompt: |
            *âš ï¸ Escalate immediately â€” unsafe condition*
            Do NOT re-energise.
            Evidence required:
            - Photos of damage/burn marks
            - Affected cabinet/module/slot
            - Error codes and timestamps
          options:
            - label: "ðŸ  Kempower menu"
              next: __MENU_KEMPOWER__

        PM_ESC:
          prompt: |
            *Escalate â€” Power Modules Offline / Derating (PMC / DPDM)*
            Include:
            - Exact error codes/messages + timestamps
            - Affected cabinet/module/slot
            - State: unavailable vs derated (kW delivered)
            - Actions attempted (supply check / cycle / reseat / swap)
            - Firmware version
            - Photos/screenshots
          options:
            - label: "ðŸ  Kempower menu"
              next: __MENU_KEMPOWER__

        PM_DONE_RESOLVED:
          prompt: |
            âœ… *Resolved*
            Power module fault cleared and normal output restored.
            Before leaving:
            - Confirm stability (no immediate re-fault)
            - Note what changed (cycle / reseat / swap result)
          options:
            - label: "ðŸ  Kempower menu"
              next: __MENU_KEMPOWER__

        PM_DONE_STAB:
          prompt: |
            âš ï¸ *Stabilised (Derated)*
            Charger is operating but with reduced power.
            Recommended:
            - Document derate level (kW) + whether stable/fluctuating
            - Identify affected cabinet/module if possible
            - Plan follow-up (module/service visit) if derate persists
          options:
            - label: "ðŸ  Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # NO_HEARTBEAT (updated to the version we discussed)
  # Keep ID stable: kempower_no_heartbeat
  # ============================================================

  - id: kempower_no_heartbeat
    platform: kempower
    charger_type: dc
    title: "Satellite / Control Unit Offline (No Communication)"

    aliases:
      - "NO_HEARTBEAT"
      - "no heartbeat"
      - "heartbeat missing"
      - "satellite offline"
      - "satellite not responding"
      - "control unit offline"
      - "control unit not responding"
    triggers:
      any_text_contains:
        - "NO_HEARTBEAT"
        - "no_heartbeat"
        - "no heartbeat"
        - "heartbeat missing"
        - "satellite offline"
        - "control unit offline"
    severity: high
    tags: [network, ethernet, satellite, control_unit, offline]

    description: >
      Satellite/Control Unit is configured but not available on the local network. This can be a single-device
      issue (24V supply, local ethernet, RJ45 termination) or system-wide (switching, cabinet-to-cabinet links,
      internal omega board â†” Ethernet switch, grounding/jumpers in multi-cabinet systems).

    decision_tree:
      start_node: KHB0
      nodes:
        KHB0:
          prompt: |
            *NO_HEARTBEAT â€” Start*
            Is it *one* Satellite/Control Unit, or *all* of them?
          options:
            - label: "Only one satellite"
              next: KHB1
            - label: "All satellites"
              next: KHB2

        KHB1:
          prompt: |
            *Single satellite issue*
            Check 24V supply at the Satellite/Control Unit (23â€“25VDC) and inspect RJ45 cabling/termination.
            If needed, inspect RJ45 extension block connections and flat cable to the display.
          options:
            - label: "Power/ethernet fixed â†’ retest"
              next: KHB3
            - label: "Still offline"
              next: KHB_ESC

        KHB2:
          prompt: |
            *System-wide issue*
            Check network links between main/secondary cabinets and inside control module (omega board â†” Ethernet switch).
            With multi-cabinet units, confirm cabinet GND terminal blocks are jumpered.
          options:
            - label: "Fixed â†’ retest"
              next: KHB3
            - label: "Still offline"
              next: KHB_ESC

        KHB3:
          prompt: |
            *Re-test*
            Restart charger and confirm heartbeat returns.
          options:
            - label: "Done"
              next: __MENU_KEMPOWER__

        KHB_ESC:
          prompt: |
            *Escalate*
            Provide: which satellite(s), 24V measurement result, cabling checks performed, and timestamps.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  # ============================================================
  # Other top faults (left as-is)
  # ============================================================

  - id: kempower_comm_not_ready
    platform: kempower
    charger_type: dc
    title: "Vehicle Communication Failed (CCS Control Pilot Not Ready)"

    aliases: ["comm not ready", "ccs not ready", "control pilot fault"]
    triggers:
      any_text_contains: ["COMM_NOT_READY", "comm_not_ready"]
    severity: high
    tags: [ccs, control_pilot, connector, startup]

    description: >
      CCS not available; Control Pilot (CP) in fault state during startup.

    decision_tree:
      start_node: KCP0
      nodes:
        KCP0:
          prompt: |
            *COMM_NOT_READY â€” Start*
            Is this after recent install/commissioning work or hardware changes?
          options:
            - label: "Yes (recent changes)"
              next: KCP1
            - label: "No (sudden fault)"
              next: KCP2

        KCP1:
          prompt: |
            *Commissioning / wiring path*
            Restart the charger and verify CP pin is connected correctly.
            If hardware mismatch is suspected, replace optional CCS card with newer revision.
          options:
            - label: "Resolved"
              next: KCP_DONE
            - label: "Still failing"
              next: KCP_ESC

        KCP2:
          prompt: |
            *Sudden fault path*
            Restart the charger. If persists, treat as CCS card / CP wiring integrity issue and escalate with photos/notes.
          options:
            - label: "Resolved"
              next: KCP_DONE
            - label: "Still failing"
              next: KCP_ESC

        KCP_DONE:
          prompt: |
            *Complete*
            âœ… CCS/CP flow complete.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__

        KCP_ESC:
          prompt: |
            *Escalate*
            Provide: connector ID, CP wiring check result, any recent work, and timestamps.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kempower_rcm_bad
    platform: kempower
    charger_type: ac
    title: "Earth Leakage Detected (Residual Current Monitor Trip)"

    aliases: ["rcm bad", "residual current leak", "earth leakage"]
    triggers:
      any_text_contains: ["RCM_BAD", "rcm_bad"]
    severity: high
    tags: [safety, rcd, rcm, earth_leakage, type2]

    description: >
      Residual current monitor detected a leak to protective earth (PE); connector disabled for safety.

    decision_tree:
      start_node: KRCM0
      nodes:
        KRCM0:
          prompt: |
            *RCM_BAD â€” Start*
            Did it occur once only, possibly after rain/moisture?
          options:
            - label: "Yes (single event)"
              next: KRCM1
            - label: "Repeating"
              next: KRCM2

        KRCM1:
          prompt: |
            *Single event*
            Restart charger. If needed, shut off AC main power supply and turn back ON, then re-test.
          options:
            - label: "Resolved"
              next: KRCM_DONE
            - label: "Still present"
              next: KRCM2

        KRCM2:
          prompt: |
            *Repeating / persistent*
            Find source of leakage:
            - Measure insulation resistance between all phases and PE (follow local safety rules).
            If insulation is OK, replace the RCM.
          options:
            - label: "Escalate (need support)"
              next: KRCM_ESC
            - label: "Done"
              next: KRCM_DONE

        KRCM_DONE:
          prompt: |
            *Complete*
            âœ… RCM flow complete.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__

        KRCM_ESC:
          prompt: |
            *Escalate*
            Provide: weather/moisture notes, IR results, photos of connector/port, timestamps.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kempower_afe_communication_error
    platform: kempower
    charger_type: dc
    title: "Grid Input Stage Communication Fault (AFE Internal Comms)"
    aliases: ["afe communication error", "pmc comms bus error"]
    triggers:
      any_text_contains: ["AFE_COMMUNICATION_ERROR", "afe_communication_error"]
    severity: medium
    tags: [pmc, afe, firmware, comms]

    description: >
      PMC internal communication bus error; PMC temporarily unavailable; reduced power in cabinet.

    decision_tree:
      start_node: KAFE0
      nodes:
        KAFE0:
          prompt: |
            *AFE_COMMUNICATION_ERROR â€” Start*
            Is this a one-off or frequent/repeating?
          options:
            - label: "One-off"
              next: KAFE1
            - label: "Repeating"
              next: KAFE2

        KAFE1:
          prompt: |
            *One-off*
            If it appears once, no action is typically necessary. Monitor.
          options:
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        KAFE2:
          prompt: |
            *Repeating*
            Update firmware/software to latest release and escalate if it continues.
          options:
            - label: "Escalate"
              next: KAFE_ESC
            - label: "Back"
              next: __MENU_KEMPOWER__

        KAFE_ESC:
          prompt: |
            *Escalate*
            Provide: frequency, cabinet/module affected, firmware version, timestamps.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kempower_fan_current
    platform: kempower
    charger_type: dc
    title: "Cooling Fan Electrical Fault (Fan Current Out of Range)"
    aliases: ["fan current", "fan fault", "thermal performance reduced"]
    triggers:
      any_text_contains: ["FAN_CURRENT", "fan_current"]
    severity: medium
    tags: [fan, cooling, airflow, firmware, pmc]

    description: >
      Fan current out of range; output reduced and thermal performance reduced.

    decision_tree:
      start_node: KFN0
      nodes:
        KFN0:
          prompt: |
            *FAN_CURRENT â€” Start*
            Is airflow obstructed / filters dirty / fan noise present?
          options:
            - label: "Yes"
              next: KFN1
            - label: "No / unsure"
              next: KFN2

        KFN1:
          prompt: |
            *Airflow path*
            Clear obstructions, check filters, confirm fans spin freely and are not noisy.
            If needed, replace fans.
          options:
            - label: "Resolved"
              next: KFN_DONE
            - label: "Still failing"
              next: KFN_ESC

        KFN2:
          prompt: |
            *Standard recovery*
            Remote restart â†’ local restart â†’ remote fault analysis. Update software to latest.
            If persists, schedule site visit / replace fans.
          options:
            - label: "Escalate"
              next: KFN_ESC
            - label: "Done"
              next: KFN_DONE

        KFN_DONE:
          prompt: |
            *Complete*
            âœ… Fan flow complete.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__

        KFN_ESC:
          prompt: |
            *Escalate*
            Provide: cabinet/module, fan noise/airflow notes, software version, timestamps.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kempower_primary_undervoltage
    platform: kempower
    charger_type: dc
    title: "Incoming Supply Too Low (Undervoltage / Phase Issue)"
    aliases: ["primary undervoltage", "supply too low"]
    triggers:
      any_text_contains: ["PRIMARY_UNDERVOLTAGE", "primary_undervoltage"]
    severity: high
    tags: [grid, supply, undervoltage, wiring, pmc]

    description: >
      Primary circuit voltage too low; reduced power available; can relate to supply insufficiency or wiring/module issues.

    decision_tree:
      start_node: KUV0
      nodes:
        KUV0:
          prompt: |
            *PRIMARY_UNDERVOLTAGE â€” Start*
            Is site/grid voltage actually low (measure under load if possible)?
          options:
            - label: "Yes (grid low)"
              next: KUV1
            - label: "No / unknown"
              next: KUV2

        KUV1:
          prompt: |
            *Grid-side issue*
            Confirm supply is sufficient for the unit; escalate to electricity distributor if needed.
          options:
            - label: "Back to menu"
              next: __MENU_KEMPOWER__

        KUV2:
          prompt: |
            *Charger-side checks*
            Check PMC breaker ON, inspect rear connector pins (not bent/broken), move module to another slot and see if fault follows.
            If fault follows module â†’ replace module.
          options:
            - label: "Resolved"
              next: KUV_DONE
            - label: "Still failing"
              next: KUV_ESC

        KUV_DONE:
          prompt: |
            *Complete*
            âœ… Undervoltage flow complete.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__

        KUV_ESC:
          prompt: |
            *Escalate*
            Provide: measured L-L voltages under load, which PMC slot, connector inspection result.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kempower_rt_safety_error_in_this_pmc
    platform: kempower
    charger_type: dc
    title: "Electrical Safety Fault Detected (Isolation / Moisture Risk)"
    aliases: ["rt safety error", "isolation fault", "pmc safety error"]
    triggers:
      any_text_contains: ["RT_SAFETY_ERROR_IN_THIS_PMC", "rt_safety_error_in_this_pmc"]
    severity: critical
    tags: [safety, insulation, isolation, water_ingress, dpdm, maintenance]

    description: >
      Indication of isolation issue; charging cannot continue safely; may trigger self-check; often related to moisture/water ingress and maintenance.

    decision_tree:
      start_node: KISO0
      nodes:
        KISO0:
          prompt: |
            *RT_SAFETY_ERROR_IN_THIS_PMC â€” Start*
            Treat as *safety critical*.
            Is there any evidence of water ingress / moisture marks?
          options:
            - label: "Yes"
              next: KISO1
            - label: "No / unsure"
              next: KISO2

        KISO1:
          prompt: |
            *Moisture path*
            Inspect cabinet for water ingress and module front panels for moisture marks/buildup.
            Review maintenance history (filters/PM intervals) and adjust frequency if needed.
          options:
            - label: "Escalate"
              next: KISO_ESC

        KISO2:
          prompt: |
            *Still treat seriously*
            Perform the same inspection steps and escalate with evidenceâ€”do not keep running repeated sessions.
          options:
            - label: "Escalate"
              next: KISO_ESC

        KISO_ESC:
          prompt: |
            *Escalate*
            Provide: which PMC, photos of cabinet/modules, maintenance history notes, timestamps, any environmental factors.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__


  - id: kempower_ssc_selftest_internal_error
    platform: kempower
    charger_type: dc
    title: "Internal System Fault â€“ Self-Test Failed"
    aliases: ["ssc selftest internal error", "self check failed", "all connectors failed"]
    triggers:
      any_text_contains: ["SSC_SELFTEST_INTERNAL_ERROR", "ssc_selftest_internal_error"]
    severity: critical
    tags: [self_check, configuration, canbus, software, dpdm]

    description: >
      System self-check failed; may be due to outdated software vs hardware, CAN wiring/divider board issues; troubleshoot companion SSC errors first.

    decision_tree:
      start_node: KST0
      nodes:
        KST0:
          prompt: |
            *SSC_SELFTEST_INTERNAL_ERROR â€” Start*
            Are other SSC codes present (e.g., SSC_CONNECTOR_VOLTAGE_MISSING)?
          options:
            - label: "Yes"
              next: KST1
            - label: "No"
              next: KST2

        KST1:
          prompt: |
            *Do the other SSC codes first*
            Troubleshoot companion SSC codes first, then re-run self-check.
          options:
            - label: "Back"
              next: __MENU_KEMPOWER__

        KST2:
          prompt: |
            *Core system checks*
            Perform inventory scan to confirm PMCs found.
            Verify DPDM configured correctly (if dynamic).
            Update software to latest available version.
            Inspect CAN bus divider board installation/wiring/damage.
          options:
            - label: "Escalate"
              next: KST_ESC
            - label: "Back"
              next: __MENU_KEMPOWER__

        KST_ESC:
          prompt: |
            *Escalate*
            Provide: inventory scan results, software version, CAN divider inspection notes, other SSC codes, timestamps.
          options:
            - label: "Kempower menu"
              next: __MENU_KEMPOWER__
