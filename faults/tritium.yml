# tritium.yml
# EVBot Fault Pack: Tritium (On-site Technician v1) ‚Äî GOLD STANDARD (symptom-first, gated, canonical clusters)
#
# Philosophy (matches General DC + Autel conventions):
# - 1‚Äì2 canonical ‚Äúgold standard clusters‚Äù do the heavy lifting (consistent gates + evidence pack + outcomes)
# - Individual ‚Äúfault‚Äù entries keep stable IDs for deep-links, but route into canonical flows (no menu bouncing mid-flow)
# - Symptom-first > code-first. Codes/messages route into the same canonical path.
#
# Notes:
# - Node-based decision tree: start_node + nodes map
# - node.options MUST be a LIST of {label, next}
# - image: tritium/<filename_without_extension> (expects files in assets/images/tritium/*.png)
#
# Reserved menu targets used by EVBot:
# - __MENU_TRITIUM__  (your bot‚Äôs Tritium menu node)

faults:

  # ============================================================
  # (0) GOLD STANDARD CLUSTER: Tritium HV Enable / Start Inhibit
  # Canonical flow for:
  # - Start inhibited / start failed
  # - Precharge / DC bus not building
  # - Contactor verification faults
  # - ‚ÄúClicks then faults‚Äù
  # - Safety chain / HVIL / E-stop / isolation gating (common inhibitors)
  # ============================================================

  - id: tritium_hv_enable_cluster
    platform: tritium
    charger_type: dc
    title: "HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)"
    severity: critical
    tags: [power_stage, hv_enable, precharge, dc_bus, contactor, interlock, isolation, start_inhibit]

    aliases:
      - "start inhibited"
      - "start failed"
      - "precharge fault"
      - "pre-charge fault"
      - "dc bus not ready"
      - "dc bus undervoltage"
      - "dc bus overvoltage"
      - "contactor fault"
      - "main contactor fault"
      - "failed to close"
      - "contactor feedback"
      - "verify failed"
      - "welded contactor"
      - "hv enable fault"
      - "safety chain open"
      - "hvil open"
      - "e-stop"
      - "isolation fault"
      - "imd"
      - "ground fault"

    triggers:
      any_text_contains:
        - "start inhibited"
        - "start failed"
        - "precharge"
        - "pre-charge"
        - "dc bus not ready"
        - "dc bus undervoltage"
        - "dc bus overvoltage"
        - "contactor feedback"
        - "failed to close"
        - "verify failed"
        - "welded contactor"
        - "safety chain open"
        - "hvil"
        - "e-stop"
        - "isolation"
        - "imd"
        - "ground fault"

    description: >
      The charger is preventing HV start or cannot complete the start sequence (enable ‚Üí precharge ‚Üí DC bus build ‚Üí
      contactor verification). Highest-yield field path is gating: safety/visual ‚Üí supply sanity ‚Üí safety chain/HVIL ‚Üí
      isolation/IMD ‚Üí then contactor/DC bus specifics. Capture the ‚Äúfirst fault that returns‚Äù after one clean reboot.

    safety_notes:
      - Apply LOTO before opening cabinets; verify safe state before touching any internal components
      - Treat isolation/IMD/ground faults as safety critical; avoid repeated start attempts
      - Do not bypass HVIL/interlocks/safety chain

    tools_required:
      - Torch / inspection light
      - Multimeter (true RMS preferred) (if authorised)
      - Insulated hand tools (if authorised)

    decision_tree:
      start_node: THV0
      nodes:

        THV0:
          prompt: |
            ‚ö° *Tritium ‚Äî HV Enable / Start Inhibit*
            Start symptom-first. What‚Äôs closest?
          options:
            - label: "üö´ Won‚Äôt start / fails immediately"
              next: THV_PATTERN_FAIL
            - label: "‚ö†Ô∏è Clicks/tries then faults quickly"
              next: THV_SAFE_REBOOT
            - label: "‚¨õ Safety chain / HVIL / E-stop indicated"
              next: THV_INTERLOCK_GATE
            - label: "üü™ Isolation / IMD / ground fault indicated"
              next: THV_ISO_GATE
            - label: "üîå Supply unstable / undervoltage / phase issue suspected"
              next: THV_SUPPLY_GATE
            - label: "üîé Message mentions precharge/DC bus/contactor"
              next: THV_SAFE_REBOOT

        THV_PATTERN_FAIL:
          prompt: |
            *Pattern check ‚Äî Start fails*
            Do you see an explicit block reason on HMI/logs?
          options:
            - label: "‚¨õ Safety chain / HVIL / E-stop"
              next: THV_INTERLOCK_GATE
            - label: "üü™ Isolation / IMD / ground fault"
              next: THV_ISO_GATE
            - label: "üîå Supply/undervoltage/phase"
              next: THV_SUPPLY_GATE
            - label: "No obvious reason shown"
              next: THV_SAFE_REBOOT

        THV_SAFE_REBOOT:
          prompt: |
            ‚úÖ *Safe recovery first (do this once, cleanly)*
            1) Confirm: no smoke/heat/water ingress
            2) Controlled reboot or controlled power cycle (per site rules)
            3) Note the *first* fault/message that returns (root clue)
          options:
            - label: "Recovered ‚úÖ"
              next: THV_DONE
            - label: "Still failing"
              next: THV_VISUAL

        THV_VISUAL:
          prompt: |
            üëÄ *Visual checks (non-invasive)*
            - Burnt smell / discoloration / melted insulation?
            - Water ingress / wet marks?
            - Harness strain / loose external connectors?
          options:
            - label: "üî• Unsafe condition found"
              next: THV_ESC_UNSAFE
            - label: "Looks OK"
              next: THV_SUPPLY_GATE

        THV_SUPPLY_GATE:
          prompt: |
            üîå *Supply sanity gate*
            Any upstream trip, undervoltage/phase loss alarm, or known site instability?
          options:
            - label: "Yes ‚Äî supply issue suspected"
              next: THV_SUPPLY_ACTIONS
            - label: "No / unknown"
              next: THV_INTERLOCK_GATE

        THV_SUPPLY_ACTIONS:
          prompt: |
            *Supply actions*
            - Check upstream breaker/isolator
            - If authorised: confirm L-L present and not sagging badly at enable
            - Stabilise supply before deeper charger work
          options:
            - label: "Supply corrected ‚Üí retry"
              next: THV_SAFE_REBOOT
            - label: "Supply seems OK ‚Üí continue"
              next: THV_INTERLOCK_GATE
            - label: "Can‚Äôt verify ‚Üí evidence pack"
              next: THV_EVIDENCE

        THV_INTERLOCK_GATE:
          prompt: |
            ‚¨õ *Safety chain / HVIL / E-stop gate*
            If any safety chain input is open, HV start will be inhibited. Clear this before chasing contactors/DC bus.
          options:
            - label: "Cleared safety chain ‚Üí retry"
              next: THV_SAFE_REBOOT
            - label: "Won‚Äôt clear"
              next: THV_EVIDENCE

        THV_ISO_GATE:
          prompt: |
            üü™ *Isolation / IMD / ground fault gate (safety critical)*
            - Avoid repeated start attempts
            - Inspect connector face + leads + cabinet for moisture/contamination/burn marks
          options:
            - label: "Continue ‚û°Ô∏è"
              next: THV_ISO_ACTIONS

        THV_ISO_ACTIONS:
          prompt: |
            *Isolation actions*
            - Record exact message + timestamp
            - Determine: one lead/connector vs all outputs
            - If lead-specific: remove affected lead from service if damaged/wet
          options:
            - label: "Evidence pack ‚Üí escalate"
              next: THV_ESC
            - label: "Back to Tritium menu"
              next: __MENU_TRITIUM__

        THV_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack (fast escalation)*
            Capture:
            - Exact message/code + timestamp
            - State: start fails vs clicks then faults
            - Any supply alarms / measured voltages (if taken)
            - Safety chain/HVIL/E-stop status
            - Isolation/IMD status (if shown)
            - Actions taken (reboot/power cycle)
          options:
            - label: "Escalate"
              next: THV_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        THV_ESC_UNSAFE:
          prompt: |
            *‚ö†Ô∏è Escalate immediately ‚Äî unsafe condition*
            Do NOT re-energise.
            Provide photos + what you observed (smell/heat/water ingress).
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        THV_ESC:
          prompt: |
            *Escalate ‚Äî Tritium HV Enable / Start Inhibit*
            Include evidence pack + what changed (if anything) after a clean reboot.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        THV_DONE:
          prompt: |
            ‚úÖ *Resolved*
            HV start restored. Run a short test session and confirm no recurrence.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (1) PLC / Controller Offline (Stable ID; gold standard gating)
  # ============================================================

  - id: tritium_plc_offline
    platform: tritium
    charger_type: dc
    title: "PLC / Controller Offline (Tritium)"
    severity: high
    tags: [comms, plc, controller, ethernet, router, reboot, ocpp, offline]

    aliases:
      - "plc offline"
      - "controller offline"
      - "charger unresponsive"
      - "ui not responding"
      - "unit not responding"
      - "cannot connect"
      - "backend offline"

    triggers:
      any_text_contains:
        - "plc offline"
        - "controller offline"
        - "ui not responding"
        - "unit not responding"
        - "cannot connect"
        - "backend offline"
        - "ocpp offline"

    description: >
      The charger is unresponsive or not communicating to backend/controller. Highest-yield path:
      scope (site-wide vs single charger) ‚Üí controlled reboot ‚Üí physical link checks (Ethernet/LTE) ‚Üí
      evidence pack for OEM/backend.

    safety_notes:
      - Follow site rules before power cycling; apply LOTO if accessing cabinets
      - Most comms checks can be done without entering HV compartments

    tools_required:
      - Known-good Ethernet patch lead (optional)
      - Phone hotspot test (if permitted)

    decision_tree:
      start_node: TPLC0
      nodes:

        TPLC0:
          prompt: |
            üåê *PLC / Controller Offline ‚Äî Start*
            First: is the unit actually powered (screen/LEDs/fans)?
          options:
            - label: "‚úÖ Powered (UI on / LEDs present)"
              next: TPLC_SCOPE
            - label: "‚ùå Completely dead (no UI/LEDs)"
              next: TPLC_DEAD_GATE

        TPLC_SCOPE:
          prompt: |
            *Scope check*
            Are other chargers at the same site also offline?
          options:
            - label: "Yes ‚Äî site-wide issue likely"
              next: TPLC_SITE
            - label: "No ‚Äî only this charger"
              next: TPLC_REBOOT
            - label: "Not sure"
              next: TPLC_REBOOT

        TPLC_SITE:
          prompt: |
            *Site-wide comms likely*
            - Check site router/modem power (if accessible)
            - Check WAN status (if you have visibility)
            - Capture timestamps + site notes
          options:
            - label: "Proceed to controlled reboot"
              next: TPLC_REBOOT
            - label: "Evidence pack"
              next: TPLC_EVIDENCE

        TPLC_REBOOT:
          prompt: |
            ‚úÖ *Controlled reboot / power cycle*
            Reboot per site policy. Allow time for modem registration and OCPP handshake.
          options:
            - label: "Recovered (online) ‚úÖ"
              next: TPLC_DONE
            - label: "Still offline"
              next: TPLC_LINKTYPE

        TPLC_LINKTYPE:
          prompt: |
            *Connection type*
            What comms path is used?
          options:
            - label: "üîå Ethernet"
              next: TPLC_ETH
            - label: "üì∂ Cellular/LTE"
              next: TPLC_LTE
            - label: "‚ùì Not sure"
              next: TPLC_EVIDENCE

        TPLC_ETH:
          prompt: |
            *Ethernet checks*
            - Link lights present?
            - Reseat cable at charger and switch
            - Try known-good cable/port if permitted
          options:
            - label: "Comms restored ‚úÖ"
              next: TPLC_DONE
            - label: "Still offline"
              next: TPLC_EVIDENCE

        TPLC_LTE:
          prompt: |
            *LTE checks*
            - Check antenna seated and not damaged
            - Note signal indication (if visible)
            - If permitted: SIM/APN sanity checks
          options:
            - label: "Comms restored ‚úÖ"
              next: TPLC_DONE
            - label: "Still offline"
              next: TPLC_EVIDENCE

        TPLC_DEAD_GATE:
          prompt: |
            ‚ö° *Dead unit gate*
            If no UI/LEDs:
            - Confirm upstream isolator ON and breaker not tripped
            - If permitted: confirm supply present at incomer
          options:
            - label: "Supply issue found ‚Üí corrected"
              next: TPLC_DONE
            - label: "Supply OK / can‚Äôt verify"
              next: TPLC_EVIDENCE

        TPLC_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî PLC/Offline*
            Capture:
            - Offline message + timestamp
            - UI state (dead vs on)
            - Connection type (Ethernet/LTE)
            - Link lights / signal notes (if known)
            - Actions taken (reboot/cables/antenna)
          options:
            - label: "Escalate"
              next: TPLC_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TPLC_ESC:
          prompt: |
            *Escalate ‚Äî PLC/Controller Offline*
            Include evidence pack + last known online time (if available).
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TPLC_DONE:
          prompt: |
            ‚úÖ *Recovered*
            Confirm stable online state (no repeated dropouts).
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (2) Pre-charge / Contactor Fault (Stable ID; routes to HV cluster)
  # ============================================================

  - id: tritium_precharge_contactor_fault
    platform: tritium
    charger_type: dc
    title: "Pre-charge / Contactor Fault (Tritium)"
    severity: high
    tags: [power, contactor, precharge, hv_enable, start_inhibit, interlock, safety]

    aliases:
      - "precharge fault"
      - "pre-charge fault"
      - "contactor fault"
      - "main contactor"
      - "contactor feedback"
      - "failed to close"
      - "verify failed"
      - "welded contactor"

    triggers:
      any_text_contains:
        - "precharge"
        - "pre-charge"
        - "contactor feedback"
        - "failed to close"
        - "verify failed"
        - "welded contactor"

    description: >
      Precharge/contactor faults are almost always part of the HV enable/start sequence.
      Use the canonical HV Enable / Start Inhibit cluster so you don‚Äôt miss safety chain, supply, or isolation gates.

    safety_notes:
      - Apply LOTO before cabinet access; do not bypass safety chain/HVIL
      - If isolation/IMD appears, stop repeated attempts and escalate

    decision_tree:
      start_node: TCON0
      nodes:

        TCON0:
          prompt: |
            üü• *Pre-charge / Contactor Fault*
            This routes into the canonical start-inhibit flow (gates + evidence pack).
          options:
            - label: "Open HV Enable / Start Inhibit cluster"
              next: THV0
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (3) Power Module Fault / Module Offline (Stable ID; gold standard gating)
  # ============================================================

  - id: tritium_power_module_fault
    platform: tritium
    charger_type: dc
    title: "Power Module Fault / Module Offline (Tritium)"
    severity: high
    tags: [power_module, rectifier, derate, module_offline, cooling, routed]

    aliases:
      - "power module fault"
      - "module offline"
      - "rectifier fault"
      - "derated"
      - "derate"

    triggers:
      any_text_contains:
        - "power module"
        - "module offline"
        - "rectifier fault"
        - "derated"
        - "derate"

    description: >
      One or more power modules are offline or faulted, causing derate or unavailable state.
      Highest-yield: clean reboot ‚Üí identify affected module/slot (if visible) ‚Üí cooling basics ‚Üí reseat (if authorised) ‚Üí
      evidence pack and escalation if persistent.

    safety_notes:
      - Apply LOTO before any internal access; do not handle modules without authorisation/training
      - If overtemp/coolant alarms exist, resolve cooling first before repeated load tests

    tools_required:
      - Torch / inspection light
      - IR thermometer (optional)

    decision_tree:
      start_node: TPM0
      nodes:

        TPM0:
          prompt: |
            üß© *Power Module Offline ‚Äî Start*
            Is the charger derated (reduced kW) or fully unavailable?
          options:
            - label: "Derated"
              next: TPM1
            - label: "Unavailable"
              next: TPM2
            - label: "Not sure"
              next: TPM2

        TPM1:
          prompt: |
            *Derate path*
            Can you identify a specific module/slot from HMI/status?
          options:
            - label: "Yes ‚Äî module/slot identified"
              next: TPM_RESEAT_GATE
            - label: "No ‚Äî not visible"
              next: TPM_COOLING_GATE

        TPM2:
          prompt: |
            *Unavailable path*
            If unavailable, check if this is paired with HV enable/start inhibit messages (precharge/contactor/DC bus).
          options:
            - label: "Yes ‚Äî start inhibit also present"
              next: TPM_ROUTE_HV
            - label: "No ‚Äî only module offline/derate type alarms"
              next: TPM_COOLING_GATE

        TPM_ROUTE_HV:
          prompt: |
            Use canonical flow:
            *HV Enable / Start Inhibit (Precharge / DC Bus / Contactors)*
          options:
            - label: "Open HV cluster"
              next: THV0

        TPM_COOLING_GATE:
          prompt: |
            üü´ *Cooling basics gate*
            Thermal issues commonly cause module trips. Check:
            - Filters/vents (air-cooled models)
            - Fans running/no obstructions
            - Ambient/sun load/ventilation clearance
          options:
            - label: "Cooling issue found ‚Üí corrected"
              next: TPM_RETEST
            - label: "Cooling looks OK"
              next: TPM_RESEAT_GATE
            - label: "Not sure"
              next: TPM_RESEAT_GATE

        TPM_RESEAT_GATE:
          prompt: |
            üîß *Reseat gate (authorised only)*
            If permitted: apply LOTO, reseat the identified module/connection, then retest.
          options:
            - label: "Retest"
              next: TPM_RETEST
            - label: "Not authorised / can‚Äôt access"
              next: TPM_EVIDENCE

        TPM_RETEST:
          prompt: |
            üîÅ *Re-test*
            Run a short test session (or readiness check) and confirm stability.
          options:
            - label: "Resolved ‚úÖ"
              next: TPM_DONE
            - label: "Still faulting"
              next: TPM_EVIDENCE

        TPM_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Power Module*
            Capture:
            - Module/slot ID (if visible) and count of modules offline
            - Derate level (kW) or unavailable state
            - Any cooling/overtemp context
            - Actions taken (reboot/filters/fans/reseat)
            - Timestamps + photos/screenshots
          options:
            - label: "Escalate"
              next: TPM_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TPM_ESC:
          prompt: |
            *Escalate ‚Äî Power Module Offline*
            Include evidence pack + any site event context (outage/surge/weather).
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TPM_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stable output and no module alarms returning under load.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (4) Overtemperature / Cooling Fault (RT/PK vs RTM model-aware)
  # ============================================================

  - id: tritium_overtemp_cooling_fault
    platform: tritium
    charger_type: dc
    title: "Overtemperature / Cooling Fault (Tritium)"
    severity: high
    tags: [cooling, overtemp, fans, filters, thermal, derate, rtm, liquid_cooling]

    aliases:
      - "overtemp"
      - "over temperature"
      - "thermal fault"
      - "cooling fault"
      - "fan fault"
      - "derated"
      - "derate"
      - "coolant fault"
      - "pump fault"
      - "flow fault"

    triggers:
      any_text_contains:
        - "overtemp"
        - "over temperature"
        - "thermal fault"
        - "cooling fault"
        - "fan fault"
        - "coolant"
        - "pump"
        - "flow fault"
        - "derate"
        - "derated"

    description: >
      The charger is exceeding thermal limits or detecting inadequate cooling, causing derate or shutdown.
      Tritium cooling differs by model family:
      - RT / PK are commonly air-cooled (filters/vents/fans are primary checks)
      - RTM uses a liquid cooling loop (coolant pump/flow/level/leaks become primary checks)

    safety_notes:
      - Start with external airflow checks where possible
      - If RTM coolant faults are suspected, avoid repeated sessions (risk of damage)
      - Apply LOTO before accessing internal fans/pump/coolant components

    tools_required:
      - Torch / inspection light
      - IR thermometer (optional)

    decision_tree:
      start_node: TCOOL0
      nodes:

        TCOOL0:
          prompt: |
            üü´ *Overtemperature / Cooling ‚Äî Start*
            Which Tritium model family are you working on?
          options:
            - label: "RT / PK (air-cooled)"
              next: TCOOL_AIR0
            - label: "RTM (liquid-cooled)"
              next: TCOOL_RTM0
            - label: "Not sure"
              next: TCOOL_ID

        TCOOL_ID:
          prompt: |
            *Identify RT/PK vs RTM (quick hints)*
            ‚Ä¢ Coolant reservoir/hoses/pump loop visible ‚Üí likely *RTM*
            ‚Ä¢ Mostly filters/vents/fans (no coolant loop) ‚Üí likely *RT/PK*
          options:
            - label: "Looks like RTM (coolant loop)"
              next: TCOOL_RTM0
            - label: "Looks like RT/PK (fans/filters)"
              next: TCOOL_AIR0
            - label: "Still unsure"
              next: TCOOL_EVIDENCE

        # -------- RT/PK air-cooled --------
        TCOOL_AIR0:
          prompt: |
            *RT/PK Air Cooling ‚Äî Filters/vents*
            Are filters/vents blocked or dirty?
          options:
            - label: "Dirty/blocked ‚Äî cleaned"
              next: TCOOL_AIR_RETEST
            - label: "Looks clean"
              next: TCOOL_AIR1

        TCOOL_AIR1:
          prompt: |
            *RT/PK Air Cooling ‚Äî Fan check*
            Confirm fans run freely, no obstructions, and airflow feels correct.
          options:
            - label: "Fans OK"
              next: TCOOL_AIR2
            - label: "Fan not running / blocked"
              next: TCOOL_AIR_FIX

        TCOOL_AIR2:
          prompt: |
            *RT/PK Site conditions*
            Consider sun load/ambient temperature and ventilation clearance.
          options:
            - label: "Conditions improved/corrected"
              next: TCOOL_AIR_RETEST
            - label: "Still derating/faulting"
              next: TCOOL_EVIDENCE

        TCOOL_AIR_FIX:
          prompt: |
            *Fix fan issue*
            Clear obstruction, check connectors, replace fan per OEM if failed.
          options:
            - label: "Re-test"
              next: TCOOL_AIR_RETEST

        TCOOL_AIR_RETEST:
          prompt: |
            *Re-test (RT/PK)*
            Run a short test session and confirm temps stabilise and output returns.
          options:
            - label: "Resolved ‚úÖ"
              next: TCOOL_DONE
            - label: "Still faulting"
              next: TCOOL_EVIDENCE

        # -------- RTM liquid-cooled --------
        TCOOL_RTM0:
          prompt: |
            *RTM Liquid Cooling ‚Äî quick route*
            Does the alarm text mention coolant/pump/flow/low level/leak?
          options:
            - label: "Yes (coolant/pump/flow related)"
              next: TCOOL_RTM_PUMP
            - label: "No (just overtemp)"
              next: TCOOL_RTM_BEHAVIOUR
            - label: "Not sure"
              next: TCOOL_RTM_PUMP

        TCOOL_RTM_BEHAVIOUR:
          prompt: |
            *RTM behaviour*
            Does derate/overtemp happen very quickly (seconds‚Äìminutes) after start?
            Rapid overtemp strongly suggests coolant flow failure.
          options:
            - label: "Rapid (seconds‚Äìminutes)"
              next: TCOOL_RTM_PUMP
            - label: "Gradual"
              next: TCOOL_RTM_PUMP

        TCOOL_RTM_PUMP:
          prompt: |
            *RTM pump/flow gate*
            Can you confirm the coolant pump runs during startup / cooling demand?
          options:
            - label: "‚úÖ Pump runs"
              next: TCOOL_RTM_LEVEL
            - label: "‚ùå Pump not running"
              next: TCOOL_RTM_ESC
            - label: "Not sure"
              next: TCOOL_RTM_ESC

        TCOOL_RTM_LEVEL:
          prompt: |
            *RTM level/leak sanity*
            If visible: check for low coolant level and any leaks/wet marks on hoses/reservoir area.
          options:
            - label: "Leak/low coolant observed"
              next: TCOOL_RTM_ESC
            - label: "No leak / level OK"
              next: TCOOL_RTM_ESC

        TCOOL_RTM_ESC:
          prompt: |
            *Escalate RTM coolant/flow fault*
            Include:
            - Whether pump runs
            - Any leak/level observations
            - Photos of reservoir/hoses/pump area (if visible)
            - Exact fault text + timestamps
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        # -------- shared evidence / closeout --------
        TCOOL_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Thermal*
            Capture:
            - Model family (RT/PK vs RTM)
            - Ambient conditions / sun load
            - Filter/fan findings (RT/PK) OR coolant/pump findings (RTM)
            - Derate level and timestamps
            - Photos/screenshots
          options:
            - label: "Escalate"
              next: TCOOL_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TCOOL_ESC:
          prompt: |
            *Escalate ‚Äî Overtemperature/Cooling*
            Include evidence pack and confirm what was already cleaned/checked.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TCOOL_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stable output and no repeated thermal alarms.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (5) Safety Chain Open (Stable ID; routes to HV cluster gate)
  # ============================================================

  - id: tritium_safety_chain_open
    platform: tritium
    charger_type: dc
    title: "E-stop / Safety Chain Open (Tritium)"
    severity: medium
    tags: [safety, interlock, estop, hvil, start_inhibit, routed]

    aliases:
      - "safety chain open"
      - "e-stop"
      - "estop"
      - "hvil open"
      - "interlock open"
      - "door open"

    triggers:
      any_text_contains:
        - "safety chain open"
        - "hvil open"
        - "interlock open"
        - "e-stop"
        - "estop"

    description: >
      Safety chain is open (E-stop/HVIL/door interlock/safety loop), preventing charging.
      Use the canonical HV Enable / Start Inhibit cluster (safety chain gate + evidence pack).

    safety_notes:
      - Do not bypass interlocks/HVIL
      - Apply LOTO if cabinet access is required

    decision_tree:
      start_node: TSAF0
      nodes:

        TSAF0:
          prompt: |
            ‚¨õ *Safety Chain Open*
            Route into the canonical start-inhibit flow (safety chain gate).
          options:
            - label: "Open HV Enable / Start Inhibit cluster"
              next: THV0
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (6) Isolation / IMD / Ground Fault (Stable ID; routes to HV cluster gate)
  # ============================================================

  - id: tritium_dc_isolation_fault
    platform: tritium
    charger_type: dc
    title: "DC Isolation / IMD / Ground Fault (Tritium)"
    severity: high
    tags: [safety, isolation, imd, ground_fault, hv_enable, routed]

    aliases:
      - "isolation fault"
      - "imd fault"
      - "ground fault"
      - "insulation fault"
      - "leakage"

    triggers:
      any_text_contains:
        - "isolation fault"
        - "imd"
        - "ground fault"
        - "insulation fault"
        - "leakage"

    description: >
      Isolation/IMD/ground faults are safety-critical and prevent charging.
      Route into the canonical HV Enable / Start Inhibit cluster (isolation gate + escalation pack).

    safety_notes:
      - Do not bypass IMD/isolation protections
      - Remove damaged/wet leads from service and escalate

    decision_tree:
      start_node: TISO0
      nodes:

        TISO0:
          prompt: |
            üü™ *Isolation / IMD / Ground Fault*
            Route into canonical start-inhibit flow (isolation gate).
          options:
            - label: "Open HV Enable / Start Inhibit cluster"
              next: THV0
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (7) Handle Temperature Sensor Fault (lead-specific vs all leads)
  # ============================================================

  - id: tritium_handle_temp_sensor_fault
    platform: tritium
    charger_type: dc
    title: "Connector / Handle Temperature Sensor Fault (Tritium)"
    severity: medium
    tags: [connector, thermal, sensor, safety, derate]

    aliases:
      - "handle temp fault"
      - "temperature sensor fault"
      - "connector temp fault"
      - "handle overtemp"
      - "plug overtemp"

    triggers:
      any_text_contains:
        - "handle temp"
        - "temperature sensor"
        - "connector temp"
        - "plug overtemp"
        - "handle overtemp"

    description: >
      Abnormal connector/handle temperature sensor reading or overheating condition.
      Often lead-specific (damaged handle/sensor/pins/contamination) and may cause derate or shutdown.

    safety_notes:
      - If overheating is suspected, remove the lead from service and escalate
      - Avoid repeated attempts if connector heating is present

    tools_required:
      - Torch / inspection light
      - IR thermometer (optional)

    decision_tree:
      start_node: THT0
      nodes:

        THT0:
          prompt: |
            üå°Ô∏è *Handle Temp Sensor ‚Äî Start*
            Is it happening on one lead/connector only?
          options:
            - label: "One lead"
              next: THT1
            - label: "All leads"
              next: THT2
            - label: "Not sure"
              next: THT1

        THT1:
          prompt: |
            *Lead-specific checks*
            Inspect: pins/contamination, latch function, strain relief, visible damage.
            If persistent or overheating is suspected: tag the lead out of service.
          options:
            - label: "Resolved ‚úÖ"
              next: THT_DONE
            - label: "Still faulting"
              next: THT_EVIDENCE

        THT2:
          prompt: |
            *All leads affected*
            Suggests controller/harness interpretation issue (not a single lead). Escalate with evidence.
          options:
            - label: "Evidence pack"
              next: THT_EVIDENCE
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        THT_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Handle Temp*
            Capture:
            - Which connector/lead (A/B) and whether all leads affected
            - Photos of pins/handle/strain relief
            - Session screenshot and timestamps
            - Any derate behaviour
          options:
            - label: "Escalate"
              next: THT_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        THT_ESC:
          prompt: |
            *Escalate ‚Äî Handle Temp Sensor Fault*
            Include evidence pack and confirm whether the lead was removed from service.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        THT_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stable session start and no re-fault.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (8) Connector Not Detected / CP-PP Fault
  # ============================================================

  - id: tritium_connector_proximity_pilot_fault
    platform: tritium
    charger_type: dc
    title: "Connector Not Detected / CP-PP Fault (Tritium)"
    severity: medium
    tags: [connector, cp, pp, pilot, proximity, latch]

    aliases:
      - "connector not detected"
      - "cp fault"
      - "pp fault"
      - "pilot fault"
      - "proximity fault"
      - "plug not detected"

    triggers:
      any_text_contains:
        - "connector not detected"
        - "plug not detected"
        - "cp fault"
        - "pp fault"
        - "pilot fault"
        - "proximity fault"

    description: >
      The charger is not detecting the connector correctly (CP/PP/proximity/pilot-related),
      preventing a session from starting. Often lead-specific due to pin damage/contamination,
      latch issues, or cable/handle wear.

    safety_notes:
      - If pins are damaged or overheating is suspected, remove lead from service
      - Avoid repeated attempts that can worsen arcing/pin damage

    tools_required:
      - Torch / inspection light
      - Known-good test vehicle (optional)

    decision_tree:
      start_node: TCPP0
      nodes:

        TCPP0:
          prompt: |
            üîå *Connector Not Detected ‚Äî Start*
            Is it happening on one connector only?
          options:
            - label: "One connector"
              next: TCPP1
            - label: "All connectors"
              next: TCPP2
            - label: "Not sure"
              next: TCPP1

        TCPP1:
          prompt: |
            *Lead-specific checks*
            Inspect pins/contamination, latch function, strain relief. If possible, try known-good vehicle.
          options:
            - label: "Resolved ‚úÖ"
              next: TCPP_DONE
            - label: "Still faulting"
              next: TCPP_EVIDENCE

        TCPP2:
          prompt: |
            *All outputs affected*
            Suggests common control/harness issue. Escalate with evidence.
          options:
            - label: "Evidence pack"
              next: TCPP_EVIDENCE
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TCPP_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî CP/PP*
            Capture:
            - Which connector/lead (A/B) or all leads
            - Photos of pins/handle/latch
            - Test vehicle details (if used)
            - Alarm text + timestamps
          options:
            - label: "Escalate"
              next: TCPP_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TCPP_ESC:
          prompt: |
            *Escalate ‚Äî Connector Not Detected / CP-PP*
            Include evidence pack and whether the lead was removed from service.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TCPP_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm stable plug detection and session start.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (9) OCPP / Authorisation Failed
  # ============================================================

  - id: tritium_ocpp_authorisation_failed
    platform: tritium
    charger_type: dc
    title: "OCPP / Authorisation Failed (Tritium)"
    severity: medium
    tags: [ocpp, backend, auth, rfid, csms]

    aliases:
      - "authorisation failed"
      - "authorization failed"
      - "rfid rejected"
      - "token rejected"
      - "transaction rejected"

    triggers:
      any_text_contains:
        - "authorisation failed"
        - "authorization failed"
        - "rfid rejected"
        - "token rejected"
        - "transaction rejected"

    description: >
      Backend (OCPP/CSMS) is rejecting authorisation or transactions.
      First determine scope: all users vs one token, then check comms/online state and escalate with timestamps.

    safety_notes:
      - Low risk; primarily backend/config checks

    tools_required:
      - CSMS access (if available)
      - Known-good RFID/token (optional)

    decision_tree:
      start_node: TAUTH0
      nodes:

        TAUTH0:
          prompt: |
            ‚úÖ *Authorisation Failed ‚Äî Start*
            Does it happen for all users/tokens or only one?
          options:
            - label: "All users/tokens"
              next: TAUTH_ALL
            - label: "One user/token"
              next: TAUTH_ONE
            - label: "Not sure"
              next: TAUTH_ALL

        TAUTH_ALL:
          prompt: |
            *All users failing*
            Suggests backend connectivity/config. Confirm charger is online and backend reachable.
          options:
            - label: "Charger appears offline"
              next: TAUTH_ROUTE_OFFLINE
            - label: "Charger online but auth failing"
              next: TAUTH_EVIDENCE

        TAUTH_ROUTE_OFFLINE:
          prompt: |
            Route to PLC/Offline checks first.
          options:
            - label: "Open PLC/Controller Offline flow"
              next: TPLC0
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TAUTH_ONE:
          prompt: |
            *Single token failing*
            Test a known-good token/app and verify allowlist/provisioning.
          options:
            - label: "Resolved ‚úÖ"
              next: TAUTH_DONE
            - label: "Still failing"
              next: TAUTH_EVIDENCE

        TAUTH_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Auth*
            Capture:
            - Timestamps and exact error text
            - Whether all tokens vs one token
            - Charger serial/site ID
            - CSMS screenshots (if available)
            - Masked token/RFID ID (never full raw IDs)
          options:
            - label: "Escalate"
              next: TAUTH_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TAUTH_ESC:
          prompt: |
            *Escalate ‚Äî Authorisation Failed*
            Include evidence pack + last known good authorisation time (if known).
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TAUTH_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm multiple tokens can start sessions successfully.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (10) Payment Terminal / Reader Fault
  # ============================================================

  - id: tritium_payment_terminal_fault
    platform: tritium
    charger_type: dc
    title: "Payment Terminal / Reader Fault (Tritium)"
    severity: low
    tags: [payment, reader, retail, comms]

    aliases:
      - "payment terminal fault"
      - "reader fault"
      - "tap not working"
      - "card reader offline"

    triggers:
      any_text_contains:
        - "payment terminal"
        - "reader fault"
        - "tap not working"
        - "card reader offline"

    description: >
      Payment terminal/reader is not functioning (tap/insert not working).
      First determine whether charging still works via app/RFID. If terminal-only, focus on terminal power/comms and escalate
      to payment vendor if required.

    safety_notes:
      - Low risk; avoid opening payment hardware unless authorised

    tools_required:
      - CSMS/payment portal access (if available)

    decision_tree:
      start_node: TPAY0
      nodes:

        TPAY0:
          prompt: |
            üí≥ *Payment Terminal Fault ‚Äî Start*
            Is charging still possible via app/RFID (even if the terminal is down)?
          options:
            - label: "‚úÖ Yes, charging still works"
              next: TPAY1
            - label: "‚ùå No, everything is down"
              next: TPAY2

        TPAY1:
          prompt: |
            *Terminal-only issue*
            Reset terminal per site policy (if permitted) and note comms/signal if visible.
          options:
            - label: "Resolved ‚úÖ"
              next: TPAY_DONE
            - label: "Still faulting"
              next: TPAY_EVIDENCE

        TPAY2:
          prompt: |
            *Wider outage suspected*
            Treat as comms/controller issue first.
          options:
            - label: "Open PLC/Controller Offline flow"
              next: TPLC0
            - label: "Evidence pack"
              next: TPAY_EVIDENCE

        TPAY_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî Payment*
            Capture:
            - Terminal model (if known)
            - Screenshots/photos of terminal state
            - Last successful transaction time (if known)
            - Whether app/RFID charging still works
            - Timestamps
          options:
            - label: "Escalate"
              next: TPAY_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TPAY_ESC:
          prompt: |
            *Escalate ‚Äî Payment Terminal Fault*
            Provide evidence pack and route to payment vendor/OEM as per your process.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        TPAY_DONE:
          prompt: |
            ‚úÖ *Resolved*
            Confirm terminal accepts payments and sessions start normally.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__


  # ============================================================
  # (11) RTM Coolant System / Pump / Flow Fault (Dedicated, but consistent)
  # ============================================================

  - id: tritium_rtm_coolant_system_fault
    platform: tritium
    charger_type: dc
    title: "RTM Coolant System / Pump / Flow Fault (Tritium)"
    severity: high
    tags: [cooling, coolant, pump, rtm, liquid_cooling, thermal, derate]

    aliases:
      - "coolant fault"
      - "pump fault"
      - "flow fault"
      - "low coolant"
      - "coolant leak"

    triggers:
      any_text_contains:
        - "coolant fault"
        - "pump fault"
        - "flow fault"
        - "low coolant"
        - "coolant leak"

    description: >
      RTM units use a liquid cooling loop. Coolant system faults (pump/flow/level/leak) can cause rapid derate or shutdown
      to protect power electronics. Avoid repeated sessions and escalate with a strong evidence pack.

    safety_notes:
      - Do not run repeated sessions if coolant faults persist
      - Inspect for leaks before re-energising
      - Apply LOTO before accessing pump/coolant components

    tools_required:
      - Torch / inspection light
      - Hearing/feel check to confirm pump operation (if accessible)

    decision_tree:
      start_node: RTC0
      nodes:

        RTC0:
          prompt: |
            üßä *RTM Coolant System Fault ‚Äî Start*
            Can you confirm the coolant pump runs during startup / cooling demand?
          options:
            - label: "‚úÖ Pump runs"
              next: RTC1
            - label: "‚ùå Pump not running"
              next: RTC_EVIDENCE
            - label: "Not sure"
              next: RTC_EVIDENCE

        RTC1:
          prompt: |
            *Pump runs*
            If visible: check coolant level and inspect for leaks/wet marks.
            If level/leaks OK but fault persists ‚Üí likely sensor/control interpretation.
          options:
            - label: "Leak / low coolant observed"
              next: RTC_EVIDENCE
            - label: "No leak / level OK"
              next: RTC_EVIDENCE

        RTC_EVIDENCE:
          prompt: |
            üóÇÔ∏è *Evidence pack ‚Äî RTM Coolant*
            Capture:
            - Whether pump runs (and how you confirmed)
            - Any leak/level observations
            - Photos of reservoir/hoses/pump area (if visible)
            - Exact fault text + timestamps/logs
          options:
            - label: "Escalate"
              next: RTC_ESC
            - label: "Tritium menu"
              next: __MENU_TRITIUM__

        RTC_ESC:
          prompt: |
            *Escalate ‚Äî RTM Coolant System Fault*
            Include evidence pack and confirm unit was not repeatedly re-tried under fault.
          options:
            - label: "Tritium menu"
              next: __MENU_TRITIUM__
